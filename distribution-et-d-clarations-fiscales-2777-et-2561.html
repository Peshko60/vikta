<!doctype html>
<html lang="fr"><head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>D√©finition de t√¢che</title>
  <link rel="stylesheet" href="vikta-task.css">
</head>

<body>
  <div class="wrap">
    <!-- Titlebar sticky -->
    <div class="titlebar">
      <h1>T√¢che VIKTA</h1>
      <div class="spacer"></div>
      <span id="costDisplay" title="Co√ªt estim√© de la session">$0.0086</span>
      <button class="btn" id="aiSettings">Param√®tres IA</button>
      <button class="btn" id="openTask">Ouvrir‚Ä¶</button>
      <button class="btn" id="pickDefaultDir">Dossier de travail‚Ä¶</button>
      <button class="btn" id="saveAsTask">Sauvegarder</button>
      <button class="btn brand" id="exportMockup">
          Exporter maquette autonome
        </button>
      <button class="btn" id="exportWorkspace">Exporter workspace pour JIRA (FR + EN)</button>
    </div>

    <!-- Bloc T√¢che (collapsible + sticky) -->
    <section class="card collapsible sticky" id="taskCard" aria-expanded="false">
      <div class="collapsible-head">
        <button class="chevron" id="toggleTask" aria-controls="taskBody" aria-expanded="false" title="Plier / d√©plier"></button>
        <div class="collapsible-title">T√¢che</div>
        <div class="spacer"></div>
        <button class="btn brand" id="addScreenHeader">Ajouter un √©cran</button>
      </div>
      <div id="taskBody" class="collapsible-body">
        <label for="taskName">Nom de la t√¢che</label>
        <input id="taskName" placeholder="ex: WEB-Page-Inscription" aria-required="true" aria-invalid="false" value="Distribution et d√©clarations fiscales 2777 et 2561">
        <div id="taskNameError" class="hint error" style="display:none;">‚ö†Ô∏è Le nom de la t√¢che est obligatoire.</div>

        <label for="projectKey" style="margin-top:12px;">Cl√© projet (pour CSV)</label>
        <input id="projectKey" placeholder="ex: WEB" value="">
        <div class="hint">Ex. pour Jira : <code>WEB</code>, <code>APP</code>‚Ä¶</div>

        <label style="margin-top:12px;">D√©finition de t√¢che</label>
        <div class="rte-wrap" id="defWrap">
          <div class="prompt-actions">
            <button class="btn" data-cmd="bold"><b>B</b></button>
            <button class="btn" data-cmd="italic"><i>I</i></button>
            <button class="btn" data-cmd="formatBlock" data-value="H2">H2</button>
            <button class="btn" data-cmd="insertUnorderedList">‚Ä¢ Liste</button>
            <button class="btn" data-cmd="insertOrderedList">1. Liste</button>
            <button class="btn" data-cmd="removeFormat">Effacer</button>
          </div>
          <div id="definition" class="rte" contenteditable="true" data-placeholder="D√©cris le contexte, le pourquoi, les hypoth√®ses‚Ä¶">L'objectif est de pouvoir g√©rer int√©gralement dans VIKTA les d√©clarations fiscales 2777 et 2561.&nbsp;<div>La d√©claration 2777 est un formulaire fiscal de paiement pour les sommes pr√©lev√©es sur des distributions de dividendes et d'int√©r√™ts :</div><div>1. pr√©l√®vement √† la source (flat tax IR)</div><div>2. retenue √† la source (r√©sidents √©trangers)</div><div>3. pr√©l√®vements sociaux -csg, crds etc.)</div><div>Cela signifie g√©n√©ration d'un fichier structur√© EDI (normes EDIFICAS)&nbsp;</div></div>
        </div>
      </div>
    </section>

    <div id="screens" class="screens"><div class="screen collapsible" id="screen-1" aria-expanded="false" draggable="true" data-index="1"><div class="screen-head"><div class="screen-left"><div class="drag-handle" title="Glisser pour r√©ordonner">‚ãÆ‚ãÆ</div><div class="screen-num" aria-label="Num√©ro d'√©cran">√âcran 1</div><input class="screen-title" placeholder="Titre de l‚Äô√©cran" value="Liste de distributions"></div><div class="screen-actions"><button class="chevron" data-role="toggle" title="Plier / d√©plier" aria-expanded="false"></button><button class="btn" data-role="focus" title="Masquer texte et outils, garder l‚Äôaper√ßu en grand">Focus aper√ßu</button><button class="btn warn" data-role="delete">Supprimer</button></div></div><div class="collapsible-body"><label>Zone explicative</label><div class="rte-wrap explication"><div class="rte-toolbar"><button class="btn" data-cmd="bold" data-value="">B</button><button class="btn" data-cmd="italic" data-value="">I</button><button class="btn" data-cmd="formatBlock" data-value="H2">H2</button><button class="btn" data-cmd="insertUnorderedList" data-value="">‚Ä¢ Liste</button><button class="btn" data-cmd="insertOrderedList" data-value="">1. Liste</button><button class="btn" data-cmd="removeFormat" data-value="">Effacer</button></div><div class="rte" contenteditable="true" data-placeholder="But de l‚Äô√©cran, r√®gles, comportements attendus‚Ä¶">Cet √©cran contient un tableau des distributions et versements des int√©r√™ts.&nbsp;<div>Un bouton au-dessus du tableau permet de rajouter une nouvelle distribution ce qui am√®ne l'utilisateur √† l'√©cran 2 "D√©tail d'une distribution - premier √©cran".</div><div>Ce bouton doit √™tre align√© sur la droite par rapport au tableau<br><div>Le tableau contient 5 colonnes :</div><div><ul><li>Date</li><li>Type</li><li>Source</li><li>Montant</li><li>Actions</li></ul><div>La colonne actions contiens les boutons d'actions suivants :</div></div><div><ul><li>Crayon (√©diter) ou loupe (visualiser)</li><li>Poubelle (supprimer)</li><li>Cadenas (verrouiller)</li></ul><div>Les 4 colonnes (DATE, TYPE, SOURCE et MONTANT) sont en lecture seule et proviennent des informations que l'utilisateur a saisi dans les √©crans "D√©tail d'une distribution..."</div></div><div>Le clic sur la poubelle supprime la ligne du tableau et efface toutes les donn√©es associ√©es</div><div>Le clic sur le crayon permet √† l'utilisateur de rentrer dans le modal de d√©tail d'une distribution (√©crans suivants).</div><div>Le clic sur le cadenas ouvert remplace le bouton crayon par bouton loupe et change le cadenas en cadenas ferm√©</div><div>Le clic sur le cadenas ferm√© remplace le bouton loupe par bouton crayon et change le cadenas en cadenas ferm√©</div><div>Chaque colonne doit pouvoir √™tre tri√©e</div><div>Une ligne sur deux doit √™tre colori√©e #f6f9ff.</div><div>L'en-t√™te du tableau doit en gras</div><div>Le tableau doit avoir des bordures sur colonnes "|" - donc pas toute la hauteur. la couleur de la bordure est&nbsp;#f6f9ff</div><div><br></div><div><br></div></div></div></div><label>Discussion &amp; √©l√©ments (g√©n√©ration + aper√ßu)</label><div class="chat"><div class="chat-head"><div class="title">Discussion / Prompt IA</div></div><div class="chat-body"><div class="chat-message user"><pre style="margin: 0px; white-space: pre-wrap; user-select: text;">üë§ test</pre></div><div class="chat-message assistant"><pre style="margin: 0px; white-space: pre-wrap; user-select: text;">ü§ñ J‚Äôai bien re√ßu ton message. Tu peux me donner des instructions ou poser ta question sur l‚Äô√©cran ou le HTML.</pre></div><div class="chat-message user"><pre style="margin: 0px; white-space: pre-wrap; user-select: text;">üë§ on est √† l'√©cran 1. je te donne le code de l'√©cran 3 qui sauvegarde la distribution dans le local storage. je ne comprends pas pourquoi sur l'√©cran 1 dans mon tableau la date est vide, la colonne type donne undefined de m√™me que source et montant
&lt;!doctype html&gt;
&lt;html lang="fr"&gt;&lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;meta name="viewport" content="width=device-width,initial-scale=1"&gt;
    &lt;title&gt;Pr√©l√®vements et retenues ‚Äî Distribution&lt;/title&gt;
    &lt;link rel="stylesheet" href="vikta-task.css"&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h2&gt;Pr√©l√®vements et retenues&lt;/h2&gt;
    &lt;div id="distribution-summary" class="mb-4"&gt;&lt;/div&gt;

    &lt;div id="fr-residents-section"&gt;
      &lt;h3&gt;B√©n√©ficiaires r√©sidents fran√ßais&lt;/h3&gt;
      &lt;table class="display datatable table table-hover dataTable" id="fr-datatable"&gt;
        &lt;thead&gt;
          &lt;tr&gt;
            &lt;th&gt;B√©n√©ficiaire&lt;/th&gt;
            &lt;th&gt;Montant&lt;/th&gt;
            &lt;th class="qp-col"&gt;QP du capital&lt;/th&gt;
            &lt;th class="cc-col"&gt;C/C moyen&lt;/th&gt;
            &lt;th&gt;CSG/CRDS/PS&lt;/th&gt;
            &lt;th&gt;IR&lt;/th&gt;
            &lt;th&gt;Montant NET&lt;/th&gt;
            &lt;th&gt;PEA&lt;/th&gt;
            &lt;th&gt;Demande de dispense&lt;/th&gt;
          &lt;/tr&gt;
        &lt;/thead&gt;
        &lt;tbody&gt;&lt;/tbody&gt;
        &lt;tfoot&gt;
          &lt;tr&gt;
            &lt;th&gt;Total&lt;/th&gt;
            &lt;th id="fr-total-montant" class="text-right"&gt;&lt;/th&gt;
            &lt;th class="qp-col" id="fr-total-qp"&gt;&lt;/th&gt;
            &lt;th class="cc-col" id="fr-total-cc"&gt;&lt;/th&gt;
            &lt;th id="fr-total-csg" class="text-right"&gt;&lt;/th&gt;
            &lt;th id="fr-total-ir" class="text-right"&gt;&lt;/th&gt;
            &lt;th id="fr-total-net" class="text-right"&gt;&lt;/th&gt;
            &lt;th&gt;&lt;/th&gt;
            &lt;th&gt;&lt;/th&gt;
          &lt;/tr&gt;
        &lt;/tfoot&gt;
      &lt;/table&gt;
    &lt;/div&gt;

    &lt;div id="foreign-residents-section" class="mt-5"&gt;
      &lt;h3&gt;B√©n√©ficiaires r√©sidents √©trangers&lt;/h3&gt;
      &lt;table class="display datatable table table-hover dataTable" id="foreign-datatable"&gt;
        &lt;thead&gt;
          &lt;tr&gt;
            &lt;th&gt;B√©n√©ficiaire&lt;/th&gt;
            &lt;th&gt;Montant&lt;/th&gt;
            &lt;th&gt;Taux&lt;/th&gt;
            &lt;th&gt;Retenue √† la source&lt;/th&gt;
            &lt;th&gt;Montant NET&lt;/th&gt;
          &lt;/tr&gt;
        &lt;/thead&gt;
        &lt;tbody&gt;&lt;/tbody&gt;
        &lt;tfoot&gt;
          &lt;tr&gt;
            &lt;th&gt;Total&lt;/th&gt;
            &lt;th id="foreign-total-montant" class="text-right"&gt;&lt;/th&gt;
            &lt;th&gt;&lt;/th&gt;
            &lt;th id="foreign-total-retenue" class="text-right"&gt;&lt;/th&gt;
            &lt;th id="foreign-total-net" class="text-right"&gt;&lt;/th&gt;
          &lt;/tr&gt;
        &lt;/tfoot&gt;
      &lt;/table&gt;
    &lt;/div&gt;

    &lt;div class="row mt-4"&gt;
      &lt;div class="col-5"&gt;&lt;/div&gt;
      &lt;div class="col-7 right"&gt;
        &lt;button type="button" class="btn btn-primary" id="btn-save-distribution"&gt;
          Sauvegarder
        &lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;script&gt;
      (function () {
        // --- UTILS ---
        function parseFrNumber(str) {
          if (!str) return 0;
          return Number(String(str).replace(/\s/g, "").replace(",", ".")) || 0;
        }
        function formatFrNumber(value) {
          return Number(value).toLocaleString("fr-FR", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
        }
        function sum(arr, fn) {
          return arr.reduce((acc, x) =&gt; acc + (fn ? fn(x) : x), 0);
        }
        function getLegalForm() {
          return localStorage.getItem("distributionLegalForm") || "";
        }
        function getDistributionDetails() {
          try {
            return JSON.parse(
              localStorage.getItem("distributionDetails") || "{}",
            );
          } catch (e) {
            return {};
          }
        }
        function getBeneficiaires() {
          try {
            return JSON.parse(
              localStorage.getItem("distributionBeneficiaires") || "[]",
            );
          } catch (e) {
            return [];
          }
        }
        function getDistributionsData() {
          try {
            return JSON.parse(
              localStorage.getItem("distributionsData") || "[]",
            );
          } catch (e) {
            return [];
          }
        }
        function setDistributionsData(data) {
          localStorage.setItem("distributionsData", JSON.stringify(data));
        }
        function isFrance(pays) {
          if (!pays) return true;
          return (
            pays.trim().toLowerCase() === "france" ||
            pays.trim().toLowerCase() === "fr"
          );
        }
        function createToggleInput(id, checked) {
          return (
            '&lt;input type="checkbox" id="' +
            id +
            '" ' +
            (checked ? "checked" : "") +
            "&gt;"
          );
        }
        function createSelectTaux(id, value) {
          const tauxList = [
            "5",
            "10",
            "12",
            "12.5",
            "12.8",
            "15",
            "20",
            "25",
            "75",
          ];
          let options = tauxList
            .map((t) =&gt; {
              let v = t.replace(",", ".");
              let label = t.replace(".", ",") + " %";
              return (
                '&lt;option value="' +
                v +
                '"' +
                (parseFloat(value) == parseFloat(v) ? " selected" : "") +
                "&gt;" +
                label +
                "&lt;/option&gt;"
              );
            })
            .join("");
          // Ajout d'une option personnalis√©e si la valeur n'est pas dans la liste
          if (
            value &amp;&amp;
            !tauxList.some((t) =&gt; parseFloat(t) === parseFloat(value))
          ) {
            options +=
              '&lt;option value="' +
              value +
              '" selected&gt;' +
              formatFrNumber(value) +
              " %&lt;/option&gt;";
          }
          return (
            '&lt;select class="viktaselect custom-select taux-select" id="' +
            id +
            '"&gt;' +
            options +
            "&lt;/select&gt;"
          );
        }

        // --- ETAT ---
        let legalForm = getLegalForm();
        let details = getDistributionDetails();
        let beneficiaires = getBeneficiaires();

        // Calcul QP du capital total (somme PP+NP de tous les b√©n√©ficiaires)
        let totalPPNP = sum(
          beneficiaires,
          (b) =&gt; parseFrNumber(b.pp || 0) + parseFrNumber(b.np || 0),
        );
        // Pour chaque b√©n√©ficiaire, calculer QP du capital initial
        beneficiaires.forEach((b) =&gt; {
          b.qpInit = totalPPNP
            ? (parseFrNumber(b.pp || 0) + parseFrNumber(b.np || 0)) / totalPPNP
            : 0;
        });

        // S√©paration FR/√©trangers
        let frBenefs = beneficiaires.filter((b) =&gt; isFrance(b.pays));
        let foreignBenefs = beneficiaires.filter((b) =&gt; !isFrance(b.pays));

        // --- RENDU SOMMAIRE DISTRIBUTION ---
        function renderSummary() {
          let html = '&lt;div class="row"&gt;';
          html +=
            '&lt;div class="col-3"&gt;&lt;strong&gt;Date :&lt;/strong&gt;' +
            (details.date || "-") +
            "&lt;/div&gt;";
          html +=
            '&lt;div class="col-3"&gt;&lt;strong&gt;Type :&lt;/strong&gt;' +
            (details.type || "-") +
            "&lt;/div&gt;";
          html +=
            '&lt;div class="col-3"&gt;&lt;strong&gt;Source :&lt;/strong&gt;' +
            (details.source || "-") +
            "&lt;/div&gt;";
          html +=
            '&lt;div class="col-3"&gt;&lt;strong&gt;Montant :&lt;/strong&gt;' +
            (details.montant ? formatFrNumber(details.montant) : "-") +
            "&lt;/div&gt;";
          html += "&lt;/div&gt;";
          document.getElementById("distribution-summary").innerHTML = html;
        }

        // --- RENDU TABLEAU FR ---
        function renderFrTable() {
          let tbody = "";
          frBenefs.forEach((b, idx) =&gt; {
            let montant = parseFrNumber(b.montant);
            let qp = b.qp !== undefined ? parseFrNumber(b.qp) : b.qpInit * 100; // QP en %
            let cc = b.cc !== undefined ? parseFrNumber(b.cc) : 0;
            let pea = !!b.pea;
            let dispense = !!b.dispense;
            // Calculs
            let csg = -1 * Math.min((qp + cc) * 0.1, montant) * 0.186;
            let ir = pea || dispense ? 0 : -1 * montant * 0.128;
            let net = montant + csg + ir;
            tbody += '&lt;tr data-idx="' + idx + '"&gt;';
            tbody += "&lt;td&gt;" + b.name + "&lt;/td&gt;";
            tbody +=
              '&lt;td class="text-right"&gt;' + formatFrNumber(montant) + "&lt;/td&gt;";
            if (legalForm === "SARL") {
              tbody +=
                '&lt;td&gt;&lt;input class="form-control text-right qp-input" type="text" value="' +
                formatFrNumber(qp) +
                '" data-idx="' +
                idx +
                '" /&gt;&lt;/td&gt;';
              tbody +=
                '&lt;td&gt;&lt;input class="form-control text-right cc-input" type="text" value="' +
                formatFrNumber(cc) +
                '" data-idx="' +
                idx +
                '" /&gt;&lt;/td&gt;';
            } else {
              tbody += '&lt;td class="qp-col" style="display:none"&gt;&lt;/td&gt;';
              tbody += '&lt;td class="cc-col" style="display:none"&gt;&lt;/td&gt;';
            }
            tbody +=
              '&lt;td class="text-right csg-cell"&gt;' +
              formatFrNumber(csg) +
              "&lt;/td&gt;";
            tbody +=
              '&lt;td class="text-right ir-cell"&gt;' + formatFrNumber(ir) + "&lt;/td&gt;";
            tbody +=
              '&lt;td class="text-right net-cell"&gt;' +
              formatFrNumber(net) +
              "&lt;/td&gt;";
            tbody +=
              '&lt;td class="center"&gt;' +
              createToggleInput("pea-" + idx, pea) +
              "&lt;/td&gt;";
            tbody +=
              '&lt;td class="center"&gt;' +
              createToggleInput("dispense-" + idx, dispense) +
              "&lt;/td&gt;";
            tbody += "&lt;/tr&gt;";
          });
          document.querySelector("#fr-datatable tbody").innerHTML = tbody;
          // Affichage/masquage colonnes SARL
          let showSARL = legalForm === "SARL";
          document
            .querySelectorAll(".qp-col")
            .forEach((e) =&gt; (e.style.display = showSARL ? "" : "none"));
          document
            .querySelectorAll(".cc-col")
            .forEach((e) =&gt; (e.style.display = showSARL ? "" : "none"));
          // Totaux
          updateFrTotals();
        }

        function updateFrTotals() {
          let rows = document.querySelectorAll("#fr-datatable tbody tr");
          let totalMontant = 0,
            totalQP = 0,
            totalCC = 0,
            totalCSG = 0,
            totalIR = 0,
            totalNet = 0;
          rows.forEach((row) =&gt; {
            let idx = row.getAttribute("data-idx");
            let montant = parseFrNumber(frBenefs[idx].montant);
            let qp =
              legalForm === "SARL"
                ? parseFrNumber(row.querySelector(".qp-input").value)
                : 0;
            let cc =
              legalForm === "SARL"
                ? parseFrNumber(row.querySelector(".cc-input").value)
                : 0;
            let csg = parseFrNumber(row.querySelector(".csg-cell").textContent);
            let ir = parseFrNumber(row.querySelector(".ir-cell").textContent);
            let net = parseFrNumber(row.querySelector(".net-cell").textContent);
            totalMontant += montant;
            totalQP += qp;
            totalCC += cc;
            totalCSG += csg;
            totalIR += ir;
            totalNet += net;
          });
          document.getElementById("fr-total-montant").textContent =
            formatFrNumber(totalMontant);
          if (legalForm === "SARL") {
            document.getElementById("fr-total-qp").textContent =
              formatFrNumber(totalQP);
            document.getElementById("fr-total-cc").textContent =
              formatFrNumber(totalCC);
          } else {
            document.getElementById("fr-total-qp").textContent = "";
            document.getElementById("fr-total-cc").textContent = "";
          }
          document.getElementById("fr-total-csg").textContent =
            formatFrNumber(totalCSG);
          document.getElementById("fr-total-ir").textContent =
            formatFrNumber(totalIR);
          document.getElementById("fr-total-net").textContent =
            formatFrNumber(totalNet);
        }

        // --- RENDU TABLEAU ETRANGER ---
        function renderForeignTable() {
          let tbody = "";
          foreignBenefs.forEach((b, idx) =&gt; {
            let montant = parseFrNumber(b.montant);
            let taux = b.taux !== undefined ? parseFrNumber(b.taux) : 12.8;
            let retenue = -1 * montant * (taux / 100);
            let net = montant + retenue; // Correction: Montant NET = Montant + Retenue √† la source
            tbody += '&lt;tr data-idx="' + idx + '"&gt;';
            tbody += "&lt;td&gt;" + b.name + "&lt;/td&gt;";
            tbody +=
              '&lt;td class="text-right"&gt;' + formatFrNumber(montant) + "&lt;/td&gt;";
            tbody += "&lt;td&gt;" + createSelectTaux("taux-" + idx, taux) + "&lt;/td&gt;";
            tbody +=
              '&lt;td class="text-right retenue-cell"&gt;' +
              formatFrNumber(retenue) +
              "&lt;/td&gt;";
            tbody +=
              '&lt;td class="text-right net-cell"&gt;' +
              formatFrNumber(net) +
              "&lt;/td&gt;";
            tbody += "&lt;/tr&gt;";
          });
          document.querySelector("#foreign-datatable tbody").innerHTML = tbody;
          updateForeignTotals();
        }

        function updateForeignTotals() {
          let rows = document.querySelectorAll("#foreign-datatable tbody tr");
          let totalMontant = 0,
            totalRetenue = 0,
            totalNet = 0;
          rows.forEach((row) =&gt; {
            let idx = row.getAttribute("data-idx");
            let montant = parseFrNumber(foreignBenefs[idx].montant);
            let retenue = parseFrNumber(
              row.querySelector(".retenue-cell").textContent,
            );
            let net = parseFrNumber(row.querySelector(".net-cell").textContent);
            totalMontant += montant;
            totalRetenue += retenue;
            totalNet += net;
          });
          document.getElementById("foreign-total-montant").textContent =
            formatFrNumber(totalMontant);
          document.getElementById("foreign-total-retenue").textContent =
            formatFrNumber(totalRetenue);
          document.getElementById("foreign-total-net").textContent =
            formatFrNumber(totalNet);
        }

        // --- EVENTS ---
        function onFrInputChange(e) {
          let input = e.target;
          let idx = input.getAttribute("data-idx");
          let row = input.closest("tr");
          let qp =
            legalForm === "SARL"
              ? parseFrNumber(row.querySelector(".qp-input").value)
              : 0;
          let cc =
            legalForm === "SARL"
              ? parseFrNumber(row.querySelector(".cc-input").value)
              : 0;
          let pea = row.querySelector('input[id^="pea-"]').checked;
          let dispense = row.querySelector('input[id^="dispense-"]').checked;
          let montant = parseFrNumber(frBenefs[idx].montant);
          // Calculs
          let csg = -1 * Math.min((qp + cc) * 0.1, montant) * 0.186;
          let ir = pea || dispense ? 0 : -1 * montant * 0.128;
          let net = montant + csg + ir;
          row.querySelector(".csg-cell").textContent = formatFrNumber(csg);
          row.querySelector(".ir-cell").textContent = formatFrNumber(ir);
          row.querySelector(".net-cell").textContent = formatFrNumber(net);
          // Format input
          if (
            input.classList.contains("qp-input") ||
            input.classList.contains("cc-input")
          ) {
            input.value = formatFrNumber(parseFrNumber(input.value));
          }
          // MAJ √©tat
          if (legalForm === "SARL") {
            frBenefs[idx].qp = qp;
            frBenefs[idx].cc = cc;
          }
          frBenefs[idx].pea = pea;
          frBenefs[idx].dispense = dispense;
          updateFrTotals();
        }

        function onFrToggleChange(e) {
          let input = e.target;
          let row = input.closest("tr");
          // Forcer recalcul IR et net
          let idx = row.getAttribute("data-idx");
          let qp =
            legalForm === "SARL"
              ? parseFrNumber(
                  row.querySelector(".qp-input")
                    ? row.querySelector(".qp-input").value
                    : 0,
                )
              : 0;
          let cc =
            legalForm === "SARL"
              ? parseFrNumber(
                  row.querySelector(".cc-input")
                    ? row.querySelector(".cc-input").value
                    : 0,
                )
              : 0;
          let pea = row.querySelector('input[id^="pea-"]').checked;
          let dispense = row.querySelector('input[id^="dispense-"]').checked;
          let montant = parseFrNumber(frBenefs[idx].montant);
          let csg = -1 * Math.min((qp + cc) * 0.1, montant) * 0.186;
          let ir = pea || dispense ? 0 : -1 * montant * 0.128;
          let net = montant + csg + ir;
          row.querySelector(".csg-cell").textContent = formatFrNumber(csg);
          row.querySelector(".ir-cell").textContent = formatFrNumber(ir);
          row.querySelector(".net-cell").textContent = formatFrNumber(net);
          // MAJ √©tat
          if (legalForm === "SARL") {
            frBenefs[idx].qp = qp;
            frBenefs[idx].cc = cc;
          }
          frBenefs[idx].pea = pea;
          frBenefs[idx].dispense = dispense;
          updateFrTotals();
        }

        function onForeignTauxChange(e) {
          let select = e.target;
          let idx = select.id.split("-")[1];
          let row = select.closest("tr");
          let montant = parseFrNumber(foreignBenefs[idx].montant);
          let taux = parseFrNumber(select.value);
          let retenue = -1 * montant * (taux / 100);
          let net = montant + retenue; // Correction: Montant NET = Montant + Retenue √† la source
          row.querySelector(".retenue-cell").textContent =
            formatFrNumber(retenue);
          row.querySelector(".net-cell").textContent = formatFrNumber(net);
          // MAJ √©tat
          foreignBenefs[idx].taux = taux;
          updateForeignTotals();
        }

        function onFrInputBlur(e) {
          // Format input
          let input = e.target;
          input.value = formatFrNumber(parseFrNumber(input.value));
        }

        // --- INIT ---
        renderSummary();
        renderFrTable();
        renderForeignTable();

        // Listeners FR
        function bindFrListeners() {
          if (legalForm === "SARL") {
            document.querySelectorAll(".qp-input").forEach((input) =&gt; {
              input.addEventListener("input", onFrInputChange);
              input.addEventListener("blur", onFrInputBlur);
            });
            document.querySelectorAll(".cc-input").forEach((input) =&gt; {
              input.addEventListener("input", onFrInputChange);
              input.addEventListener("blur", onFrInputBlur);
            });
          }
          document.querySelectorAll('input[id^="pea-"]').forEach((input) =&gt; {
            input.addEventListener("change", onFrToggleChange);
          });
          document
            .querySelectorAll('input[id^="dispense-"]')
            .forEach((input) =&gt; {
              input.addEventListener("change", onFrToggleChange);
            });
        }

        function bindForeignListeners() {
          document.querySelectorAll(".taux-select").forEach((select) =&gt; {
            select.addEventListener("change", onForeignTauxChange);
            select.addEventListener("blur", function (e) {
              // Permet la saisie libre d'un taux
              let val = parseFrNumber(e.target.value);
              if (!isNaN(val) &amp;&amp; val &gt; 0) {
                e.target.value = val;
                onForeignTauxChange(e);
              }
            });
          });
        }

        bindFrListeners();
        bindForeignListeners();

        // --- SAUVEGARDE ---
        document
          .getElementById("btn-save-distribution")
          .addEventListener("click", function () {
            // En mode lecture seule : naviguer vers l‚Äô√©cran 1 sans sauvegarder
            if (localStorage.getItem("distributionMode") === "view") {
              window.parent.postMessage({ type: "po:navigate", action: "goto", index: 1 }, "*");
              return;
            }
            // Construction de l‚Äôobjet distribution √† sauvegarder
            let data = getDistributionsData();

            // üîπ si on vient d‚Äôun edit/view, l‚Äô√©cran 2 a pos√© cet id
            const editingId = Number(
              localStorage.getItem("distributionEditingId") || "0",
            );

            // id = update si edit, sinon create
            const idToUse = editingId
              ? editingId
              : data.length &gt; 0
                ? Math.max(...data.map((d) =&gt; Number(d.id || 0))) + 1
                : 1;

            // Construit l‚Äôobjet distribution
            let distribution = {
              id: idToUse,
              locked: false, // tu peux aussi garder l'ancien locked si tu veux
              details: details,
              legalForm: legalForm,
              beneficiaires: [],
            };

            // FR
            frBenefs.forEach((b, idx) =&gt; {
              let row = document.querySelector(
                '#fr-datatable tbody tr[data-idx="' + idx + '"]',
              );
              let montant = parseFrNumber(b.montant);
              let qp =
                legalForm === "SARL"
                  ? parseFrNumber(row.querySelector(".qp-input").value)
                  : 0;
              let cc =
                legalForm === "SARL"
                  ? parseFrNumber(row.querySelector(".cc-input").value)
                  : 0;
              let pea = row.querySelector('input[id^="pea-"]').checked;
              let dispense = row.querySelector(
                'input[id^="dispense-"]',
              ).checked;
              let csg = parseFrNumber(
                row.querySelector(".csg-cell").textContent,
              );
              let ir = parseFrNumber(row.querySelector(".ir-cell").textContent);
              let net = parseFrNumber(
                row.querySelector(".net-cell").textContent,
              );

              distribution.beneficiaires.push({
                id: b.id,
                name: b.name,
                pays: b.pays,
                montant: montant,
                pp: b.pp || 0,
                np: b.np || 0,
                u: b.u || 0,
                ppMontant: b.ppMontant || 0,
                npMontant: b.npMontant || 0,
                uMontant: b.uMontant || 0,
                qp: qp,
                cc: cc,
                pea: pea,
                dispense: dispense,
                csg: csg,
                ir: ir,
                net: net,
                type: "fr",
              });
            });

            // FOREIGN
            foreignBenefs.forEach((b, idx) =&gt; {
              let row = document.querySelector(
                '#foreign-datatable tbody tr[data-idx="' + idx + '"]',
              );
              let montant = parseFrNumber(b.montant);
              let taux = parseFrNumber(row.querySelector(".taux-select").value);
              let retenue = parseFrNumber(
                row.querySelector(".retenue-cell").textContent,
              );
              let net = parseFrNumber(
                row.querySelector(".net-cell").textContent,
              );

              distribution.beneficiaires.push({
                id: b.id,
                name: b.name,
                pays: b.pays,
                montant: montant,
                pp: b.pp || 0,
                np: b.np || 0,
                u: b.u || 0,
                ppMontant: b.ppMontant || 0,
                npMontant: b.npMontant || 0,
                uMontant: b.uMontant || 0,
                taux: taux,
                retenue: retenue,
                net: net,
                type: "foreign",
              });
            });

            // Ajout √† la liste

            if (editingId) {
              // UPDATE
              const idx = data.findIndex((d) =&gt; Number(d.id) === editingId);
              if (idx &gt;= 0) {
                // optionnel : conserver l'√©tat locked existant
                distribution.locked = !!data[idx].locked;
                data[idx] = distribution;
              } else {
                data.push(distribution); // fallback si pas trouv√©
              }
            } else {
              // CREATE
              data.push(distribution);
            }

            setDistributionsData(data);

            // Nettoyage du mode √©dition apr√®s sauvegarde
            localStorage.removeItem("distributionEditingId");
            localStorage.setItem(
              "distModalIntent",
              JSON.stringify({ action: "add" }),
            );
            localStorage.setItem("distributionMode", "add");
            // Navigation √©cran 1
            window.parent.postMessage(
              { type: "po:navigate", action: "goto", index: 1 },
              "*",
            );
          });

        // Rebind listeners apr√®s chaque render
        function rerenderAndBind() {
          renderFrTable();
          renderForeignTable();
          bindFrListeners();
          bindForeignListeners();
        }

        // Si jamais on veut rafra√Æchir dynamiquement (ex: changement de forme juridique)
        window.rerenderDistributionScreen = rerenderAndBind;

        // R√©-initialisation quand on navigue vers cet √©cran
        function activateScreen3() {
          legalForm = getLegalForm();
          details = getDistributionDetails();
          beneficiaires = getBeneficiaires();
          var totalPPNPLocal = beneficiaires.reduce(function (acc, b) {
            return acc + parseFrNumber(b.pp || 0) + parseFrNumber(b.np || 0);
          }, 0);
          beneficiaires.forEach(function (b) {
            b.qpInit = totalPPNPLocal
              ? (parseFrNumber(b.pp || 0) + parseFrNumber(b.np || 0)) / totalPPNPLocal
              : 0;
          });
          frBenefs = beneficiaires.filter(function (b) { return isFrance(b.pays); });
          foreignBenefs = beneficiaires.filter(function (b) { return !isFrance(b.pays); });
          renderSummary();
          rerenderAndBind();
          var mode = localStorage.getItem("distributionMode");
          var btnSave = document.getElementById("btn-save-distribution");
          if (mode === "view") {
            btnSave.textContent = "Fermer";
            document.querySelectorAll("input, select, textarea").forEach(function (el) {
              el.disabled = true;
            });
          } else {
            btnSave.textContent = "Sauvegarder";
            document.querySelectorAll("input, select, textarea").forEach(function (el) {
              el.disabled = false;
            });
          }
        }

        window.addEventListener("message", function (e) {
          var data = e.data || {};
          if (data.type === "po:activate" &amp;&amp; data.index === 3) {
            activateScreen3();
          }
        });
      })();
    &lt;/script&gt;
  

&lt;/body&gt;&lt;/html&gt;</pre></div><div class="chat-message assistant"><pre style="margin: 0px; white-space: pre-wrap; user-select: text;">ü§ñ Le probl√®me vient s√ªrement du contenu de l‚Äôobjet details utilis√© lors de la sauvegarde dans l‚Äô√©cran 3. 

Quand tu cliques sur "Sauvegarder", tu fais :
details: details,

Mais la variable details est r√©cup√©r√©e par getDistributionDetails(), qui lit localStorage.getItem("distributionDetails"). Si ce localStorage est vide ou mal rempli, alors details sera un objet vide ou incomplet, donc les champs date, type, source, montant seront undefined ou vides.

Sur l‚Äô√©cran 1, le tableau lit dist.details.date, dist.details.type, etc. Si details est vide, tout sera vide ou undefined.

V√©rifie que localStorage.setItem("distributionDetails", ...) est bien fait AVANT d‚Äôarriver sur l‚Äô√©cran 3, et que l‚Äôobjet contient bien les champs attendus (date, type, source, montant). Sinon, il faut corriger la sauvegarde de ces infos dans le localStorage avant d‚Äôarriver sur l‚Äô√©cran 3.

En r√©sum√© :  
- Le probl√®me vient d‚Äôun localStorage "distributionDetails" vide ou mal rempli.  
- Corrige la sauvegarde de "distributionDetails" avant l‚Äô√©cran 3.  
- V√©rifie son contenu dans le navigateur (onglet Application &gt; Local Storage).</pre></div><div class="chat-message user"><pre style="margin: 0px; white-space: pre-wrap; user-select: text;">üë§ bon, je te donne aussi le code de l'√©cran 2 . tu as tout (√©cran actuel, √©crans 2 et 3). trouve l'erreur (o√π et quand cela se sauvegarde dans le localstorage) &lt;!doctype html&gt;
&lt;html lang="fr"&gt;&lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;meta name="viewport" content="width=device-width,initial-scale=1"&gt;
    &lt;title&gt;Distribution - D√©tail&lt;/title&gt;
    &lt;link rel="stylesheet" href="vikta-task.css"&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h2&gt;D√©tail d'une distribution&lt;/h2&gt;
    &lt;form id="distribution-form" autocomplete="off"&gt;
      &lt;div class="form-group"&gt;
        &lt;label class="control-label" for="distribution-date"&gt;Date&lt;/label&gt;
        &lt;div&gt;
          &lt;input class="form-control" id="distribution-date" name="distribution-date" type="date" required="" style="max-width: 140px; width: 140px"&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div class="form-group"&gt;
        &lt;label class="control-label" for="distribution-type"&gt;Type&lt;/label&gt;
        &lt;div&gt;
          &lt;select class="viktaselect custom-select" id="distribution-type" name="distribution-type"&gt;
            &lt;option value="dividendes" selected=""&gt;Dividendes&lt;/option&gt;
            &lt;option value="interets"&gt;Int√©r√™ts&lt;/option&gt;
          &lt;/select&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div class="form-group"&gt;
        &lt;label class="control-label" for="distribution-legal-form"&gt;Forme Juridique&lt;/label&gt;
        &lt;div&gt;
          &lt;select class="viktaselect custom-select" id="distribution-legal-form" name="distribution-legal-form"&gt;
            &lt;option value="SARL" selected=""&gt;SARL&lt;/option&gt;
            &lt;option value="SAS"&gt;SAS&lt;/option&gt;
          &lt;/select&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div class="form-group"&gt;
        &lt;label class="control-label" for="distribution-source"&gt;Source&lt;/label&gt;
        &lt;div&gt;
          &lt;input class="form-control" id="distribution-source" name="distribution-source" type="text" placeholder="p.ex distribution de r√©serves du 20 d√©cembre..."&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div class="form-group"&gt;
        &lt;label class="control-label" for="distribution-amount"&gt;Montant&lt;/label&gt;
        &lt;div class="controls-input-with-buttons"&gt;
          &lt;input class="form-control text-right" id="distribution-amount" name="distribution-amount" type="text" value="0,00" style="max-width: 120px; width: 120px"&gt;
        &lt;/div&gt;
        &lt;div class="controls-buttons"&gt;
          &lt;button type="button" class="btn btn-primary" id="btn-repartir"&gt;
            R√©partir
          &lt;/button&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/form&gt;
    &lt;h3&gt;B√©n√©ficiaires de la distribution&lt;/h3&gt;
    &lt;table class="display datatable table table-hover dataTable" id="main-datatable"&gt;
      &lt;thead&gt;
        &lt;tr class="ve-table-header"&gt;
          &lt;th colspan="5"&gt;
            &lt;div class="row ve-datatable-heading" id="main-datatable-heading"&gt;
              &lt;div class="d-flex flex-fill"&gt;
                &lt;div class="ve-datatable-searchbox"&gt;&lt;/div&gt;
                &lt;div class="ve-datatable-filters"&gt;&lt;/div&gt;
                &lt;div&gt;&lt;/div&gt;
              &lt;/div&gt;
            &lt;/div&gt;
          &lt;/th&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;th&gt;&lt;/th&gt;
          &lt;th colspan="2" id="th-categorie-titre"&gt;Parts sociales&lt;/th&gt;
          &lt;th&gt;&lt;/th&gt;
          &lt;th&gt;&lt;/th&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;th&gt;B√©n√©ficiaire&lt;/th&gt;
          &lt;th&gt;Droits&lt;br&gt;&lt;small&gt;(PP/NP/U)&lt;/small&gt;&lt;/th&gt;
          &lt;th&gt;Montant&lt;/th&gt;
          &lt;th&gt;Total&lt;/th&gt;
          &lt;th&gt;&lt;/th&gt;
        &lt;/tr&gt;
      &lt;/thead&gt;
      &lt;tbody id="benef-table-body"&gt;&lt;/tbody&gt;
      &lt;tfoot&gt;
        &lt;tr&gt;
          &lt;td&gt;
            &lt;div class="row"&gt;
              &lt;div class="col-12"&gt;
                &lt;select class="viktaselect custom-select" id="benef-select" style="max-width: 180px"&gt;&lt;/select&gt;
                &lt;button type="button" class="btn btn-primary" id="btn-add-benef"&gt;
                  +
                &lt;/button&gt;
              &lt;/div&gt;
            &lt;/div&gt;
          &lt;/td&gt;
          &lt;td colspan="4"&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;td&gt;&lt;strong&gt;Total&lt;/strong&gt;&lt;/td&gt;
          &lt;td id="total-droits-cell"&gt;
            &lt;div&gt;
              &lt;span id="total-droits-pp"&gt;PP - 0&lt;/span&gt;&lt;br&gt;
              &lt;span id="total-droits-np"&gt;NP - 0&lt;/span&gt;&lt;br&gt;
              &lt;span id="total-droits-u"&gt;U - 0&lt;/span&gt;
            &lt;/div&gt;
          &lt;/td&gt;
          &lt;td id="total-montant-cell" class="text-right"&gt;
            &lt;strong&gt;0,00&lt;/strong&gt;
          &lt;/td&gt;
          &lt;td id="total-total-cell" class="text-right"&gt;
            &lt;strong&gt;0,00&lt;/strong&gt;
          &lt;/td&gt;
          &lt;td&gt;&lt;/td&gt;
        &lt;/tr&gt;
      &lt;/tfoot&gt;
    &lt;/table&gt;
    &lt;div class="row mt-4"&gt;
      &lt;div class="col-12 right"&gt;
        &lt;button type="button" class="btn btn-primary" id="btn-next"&gt;
          Suivant
        &lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="ui-dialog ui-corner-all ui-widget ui-widget-content ui-front no-title-bar dialog-x-none" id="droits-modal" style="
        display: none;
        position: fixed;
        top: 5vh;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        width: 600px;
        max-width: 95%;
        max-height: 90vh;
        overflow: auto;
      "&gt;
      &lt;div class="ui-dialog-titlebar ui-corner-all ui-widget-header ui-helper-clearfix ui-draggable-handle"&gt;&lt;/div&gt;
      &lt;div class="app-data-container app-dialog ui-dialog-content ui-widget-content" id="main-dialog"&gt;
        &lt;form id="droits-form"&gt;
          &lt;h4 id="modal-benef-name"&gt;&lt;/h4&gt;
          &lt;table class="display datatable table table-hover dataTable" id="droits-table"&gt;
            &lt;thead&gt;
              &lt;tr&gt;
                &lt;th&gt;Type de droits&lt;/th&gt;
                &lt;th&gt;Quantit√©&lt;/th&gt;
                &lt;th&gt;Montant&lt;/th&gt;
              &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody&gt;
              &lt;tr&gt;
                &lt;td&gt;PP&lt;/td&gt;
                &lt;td&gt;
                  &lt;input class="form-control text-right" type="text" id="droits-pp-qty" style="max-width: 90px; width: 90px"&gt;
                &lt;/td&gt;
                &lt;td&gt;
                  &lt;input class="form-control text-right" type="text" id="droits-pp-montant" style="max-width: 120px; width: 120px"&gt;
                &lt;/td&gt;
              &lt;/tr&gt;
              &lt;tr&gt;
                &lt;td&gt;NP&lt;/td&gt;
                &lt;td&gt;
                  &lt;input class="form-control text-right" type="text" id="droits-np-qty" style="max-width: 90px; width: 90px"&gt;
                &lt;/td&gt;
                &lt;td&gt;
                  &lt;input class="form-control text-right" type="text" id="droits-np-montant" style="max-width: 120px; width: 120px"&gt;
                &lt;/td&gt;
              &lt;/tr&gt;
              &lt;tr&gt;
                &lt;td&gt;U&lt;/td&gt;
                &lt;td&gt;
                  &lt;input class="form-control text-right" type="text" id="droits-u-qty" style="max-width: 90px; width: 90px"&gt;
                &lt;/td&gt;
                &lt;td&gt;
                  &lt;input class="form-control text-right" type="text" id="droits-u-montant" style="max-width: 120px; width: 120px"&gt;
                &lt;/td&gt;
              &lt;/tr&gt;
              &lt;tr&gt;
                &lt;td&gt;&lt;strong&gt;Total&lt;/strong&gt;&lt;/td&gt;
                &lt;td&gt;&lt;/td&gt;
                &lt;td&gt;
                  &lt;input class="form-control text-right" type="text" id="droits-total-montant" readonly="" style="max-width: 120px; width: 120px"&gt;
                &lt;/td&gt;
              &lt;/tr&gt;
            &lt;/tbody&gt;
          &lt;/table&gt;
          &lt;div class="row mt-4"&gt;
            &lt;div class="col-5"&gt;
              &lt;button type="button" class="btn btn-secondary ve-pending-recalculate" id="droits-cancel"&gt;
                Annuler
              &lt;/button&gt;
            &lt;/div&gt;
            &lt;div class="col-7 right"&gt;
              &lt;button type="submit" class="btn btn-primary ve-pending-recalculate" id="droits-validate"&gt;
                Valider
              &lt;/button&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/form&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;script&gt;
      // --- Etat interne des b√©n√©ficiaires de la distribution ---
      let distributionBenefs = [];
      let allBeneficiaires = [];
      let benefIdCounter = 1;
      // --- Etat interne de la forme juridique ---
      let formeJuridique = "SARL";
      // --- Pr√©noms et noms pour g√©n√©ration al√©atoire ---
      let details = {};
      const prenoms = [
        "Jean",
        "Marie",
        "Lucas",
        "Emma",
        "Thomas",
        "Sofia",
        "Hugo",
        "L√©a",
        "Paul",
        "In√®s",
      ];
      const noms = [
        "Dupont",
        "Martin",
        "Bernard",
        "Petit",
        "Moreau",
        "Garcia",
        "Silva",
        "Schmidt",
        "Rossi",
        "Dubois",
      ];

      function saveDistributionBenefs() {
        localStorage.setItem(
          "distributionBeneficiaires",
          JSON.stringify(distributionBenefs),
        );
      }
      function randomFrom(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
      }
      // --- Fonctions de formatage/fran√ßais ---
      function parseFrNumber(str) {
        if (typeof str !== "string") return 0;
        str = str.replace(/\s/g, "").replace(",", ".");
        let n = parseFloat(str);
        return isNaN(n) ? 0 : n;
      }
      function formatFrNumber(value) {
        return Number(value).toLocaleString("fr-FR", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      }
      // --- Sauvegarde et chargement de la forme juridique ---
      function saveFormeJuridique() {
        localStorage.setItem("distributionLegalForm", formeJuridique);
      }
      function loadFormeJuridique() {
        const val = localStorage.getItem("distributionLegalForm");
        if (val === "SAS" || val === "SARL") {
          formeJuridique = val;
          document.getElementById("distribution-legal-form").value =
            formeJuridique;
        }
      }
      // --- Sauvegarde et chargement des b√©n√©ficiaires disponibles (pour la liste d√©roulante) ---
      function saveAllBeneficiaires() {
        localStorage.setItem(
          "distributionAllBeneficiaires",
          JSON.stringify(allBeneficiaires),
        );
      }
      function loadAllBeneficiaires() {
        const raw = localStorage.getItem("distributionAllBeneficiaires");
        if (raw) {
          try {
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) {
              allBeneficiaires = parsed;
              benefIdCounter = Math.max(
                1,
                ...allBeneficiaires.map((b) =&gt; b.id + 1),
              );
              return;
            }
          } catch (e) {}
        }
        // Si rien, on cr√©e 5 b√©n√©ficiaires initiaux
        allBeneficiaires = [];
        for (let i = 0; i &lt; 5; i++) {
          const newId = benefIdCounter++;
          const pays = i % 2 === 0 ? "France" : "Etranger";
          const prenom = randomFrom(prenoms);
          const nom = randomFrom(noms);
          const fullName = prenom + " " + nom;
          allBeneficiaires.push({ id: newId, name: fullName, pays: pays });
        }
        saveAllBeneficiaires();
      }
      // --- Sauvegarde et chargement des b√©n√©ficiaires de la distribution (tableau principal) ---

      function applyViewModeIfNeeded() {
        const isView = localStorage.getItem("distributionMode") === "view";

        [
          "distribution-date",
          "distribution-type",
          "distribution-legal-form",
          "distribution-source",
          "distribution-amount",
        ].forEach((id) =&gt; {
          const el = document.getElementById(id);
          if (el) el.disabled = isView;
        });

        ["btn-repartir", "btn-add-benef"].forEach((id) =&gt; {
          const el = document.getElementById(id);
          if (el) el.disabled = isView;
        });

        // Montants et actions dans le tableau des b√©n√©ficiaires
        document.querySelectorAll(".montant-cell").forEach(function(el) { el.disabled = isView; });
        document.querySelectorAll(".btn-remove-benef").forEach(function(el) { el.disabled = isView; });
        document.querySelectorAll(".droits-cell").forEach(function(el) {
          el.style.pointerEvents = isView ? "none" : "";
          el.style.color = isView ? "inherit" : "";
          el.style.textDecoration = isView ? "none" : "";
        });

        const next = document.getElementById("btn-next");
        if (next) next.textContent = "Suivant";
      }

      // --- Rafra√Æchissement de la liste d√©roulante des b√©n√©ficiaires √† ajouter ---
      function refreshBenefSelect() {
        const select = document.getElementById("benef-select");
        select.innerHTML = "";
        // On ne propose que les b√©n√©ficiaires qui ne sont pas d√©j√† dans la distribution
        const idsInTable = new Set(distributionBenefs.map((b) =&gt; b.id));
        let hasOption = false;
        allBeneficiaires.forEach((benef) =&gt; {
          if (!idsInTable.has(benef.id)) {
            const opt = document.createElement("option");
            opt.value = benef.id;
            opt.textContent =
              benef.name + (benef.pays ? " (" + benef.pays + ")" : "");
            select.appendChild(opt);
            hasOption = true;
          }
        });
        if (!hasOption) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "Aucun b√©n√©ficiaire disponible";
          select.appendChild(opt);
        }
      }
      // --- Ajout d'un b√©n√©ficiaire √† la liste globale ou s√©lectionn√© (CORRIG√â) ---
      document
        .getElementById("btn-add-benef")
        .addEventListener("click", function () {
          const select = document.getElementById("benef-select");
          let benefId = select.value;
          const idsInTable = new Set(distributionBenefs.map((b) =&gt; b.id));
          // Cas 1 : aucun b√©n√©ficiaire s√©lectionn√© OU "Aucun b√©n√©ficiaire disponible"
          if (
            !benefId ||
            benefId === "" ||
            benefId === "Aucun b√©n√©ficiaire disponible"
          ) {
            // Ajout d'un nouveau b√©n√©ficiaire al√©atoire √† la liste globale
            const newId = benefIdCounter++;
            const prenom = randomFrom(prenoms);
            const nom = randomFrom(noms);
            const pays =
              allBeneficiaires.length % 2 === 0 ? "France" : "Etranger";
            const fullName = prenom + " " + nom;
            const newBenef = { id: newId, name: fullName, pays: pays };
            allBeneficiaires.push(newBenef);
            saveAllBeneficiaires();
            // Ajout imm√©diat √† la distribution
            distributionBenefs.push({
              id: newId,
              name: fullName,
              pays: pays,
              droits: {
                PP: { qty: 0, montant: 0 },
                NP: { qty: 0, montant: 0 },
                U: { qty: 0, montant: 0 },
              },
              montant: 0,
              montantManuel: false,
            });
            saveDistributionBenefs();
            refreshBenefTable();
            refreshBenefSelect();
          } else {
            // Ajout du b√©n√©ficiaire s√©lectionn√© √† la distribution S'IL N'Y EST PAS D√âJ√Ä
            benefId = parseInt(benefId, 10);
            if (idsInTable.has(benefId)) {
              alert("Ce b√©n√©ficiaire est d√©j√† dans la distribution.");
              return;
            }
            const benef = allBeneficiaires.find((b) =&gt; b.id == benefId);
            if (benef) {
              distributionBenefs.push({
                id: benef.id,
                name: benef.name,
                pays: benef.pays,
                droits: {
                  PP: { qty: 0, montant: 0 },
                  NP: { qty: 0, montant: 0 },
                  U: { qty: 0, montant: 0 },
                },
                montant: 0,
                montantManuel: false,
              });
              saveDistributionBenefs();
              refreshBenefTable();
              refreshBenefSelect();
            }
          }
        });
      // --- Rafra√Æchissement du tableau des b√©n√©ficiaires ---
      function refreshBenefTable() {
        const tbody = document.getElementById("benef-table-body");
        tbody.innerHTML = "";
        let totalMontant = 0;
        let totalTotal = 0;
        let sumPP = 0,
          sumNP = 0,
          sumU = 0;
        distributionBenefs.forEach((b, idx) =&gt; {
          // Calcul du total des droits
          const droits = b.droits;
          const droitsStr = [
            `PP - ${formatFrNumber(droits.PP.qty)} - ${formatFrNumber(droits.PP.montant)}`,
            `NP - ${formatFrNumber(droits.NP.qty)} - ${formatFrNumber(droits.NP.montant)}`,
            `U - ${formatFrNumber(droits.U.qty)} - ${formatFrNumber(droits.U.montant)}`,
          ].join("&lt;br&gt;");
          // Calcul du total du modal
          const totalModal =
            droits.PP.montant + droits.NP.montant + droits.U.montant;
          // Sommes pour la ligne total
          sumPP += droits.PP.qty;
          sumNP += droits.NP.qty;
          sumU += droits.U.qty;
          // Montant affich√©
          const montantAffiche = formatFrNumber(b.montant);
          totalMontant += b.montant;
          // Total (pour chaque b√©n√©ficiaire, ici = montant)
          totalTotal += b.montant;
          // Warning si √©cart
          const warning = Math.abs(b.montant - totalModal) &gt; 0.009;
          const warningIcon = warning
            ? '&lt;span title="Le montant ne correspond pas au total d√©fini par type de droits" style="color:orange;font-weight:bold;font-size:1.2em;vertical-align:middle;"&gt;&amp;#9888;&lt;/span&gt;'
            : "";
          // Ligne
          const tr = document.createElement("tr");
          tr.innerHTML = `&lt;td&gt;${b.name}&lt;br&gt;&lt;small style="color:gray;"&gt;${b.pays}&lt;/small&gt;&lt;/td&gt;&lt;td&gt;&lt;a href="#" class="droits-cell" data-idx="${idx}"&gt;${droitsStr}&lt;/a&gt;&lt;/td&gt;&lt;td class="text-right"&gt;&lt;div style="display:flex;align-items:center;"&gt;&lt;input class="form-control text-right montant-cell" type="text" data-idx="${idx}" value="${montantAffiche}" style="max-width: 120px; width: 120px;"&gt;${warningIcon}&lt;/div&gt;&lt;/td&gt;&lt;td class="text-right"&gt;${montantAffiche}&lt;/td&gt;&lt;td&gt;&lt;button type="button" class="btn btn-secondary btn-sm btn-remove-benef" data-idx="${idx}" title="Supprimer" data-custom-bg="1"&gt;Supprimer&lt;/button&gt;&lt;/td&gt;`;
          tbody.appendChild(tr);
        });
        // Mise √† jour ligne total
        document.getElementById("total-montant-cell").innerHTML =
          `&lt;strong&gt;${formatFrNumber(totalMontant)}&lt;/strong&gt;`;
        document.getElementById("total-total-cell").innerHTML =
          `&lt;strong&gt;${formatFrNumber(totalTotal)}&lt;/strong&gt;`;
        const incoherent = Math.abs(sumNP - sumU) &gt; 0.009;
        document.getElementById("total-droits-cell").innerHTML =
          `&lt;div&gt;&lt;span&gt;PP - ${formatFrNumber(sumPP)}&lt;/span&gt;&lt;br&gt;&lt;span&gt;NP - ${formatFrNumber(sumNP)}&lt;/span&gt;&lt;br&gt;&lt;span&gt;U - ${formatFrNumber(sumU)}&lt;/span&gt;${incoherent ? '&lt;br&gt;&lt;span style="color:orange;font-weight:bold;" title="Total NP diff√©rent du total U"&gt;&amp;#9888; D√©membrement incoh√©rent&lt;/span&gt;' : ""}&lt;/div&gt;`;
        // Listeners droits
        Array.from(document.getElementsByClassName("droits-cell")).forEach(
          (a) =&gt; {
            a.addEventListener("click", function (e) {
              e.preventDefault();
              openDroitsModal(parseInt(this.dataset.idx, 10));
            });
          },
        );
        // Listeners suppression
        Array.from(document.getElementsByClassName("btn-remove-benef")).forEach(
          (btn) =&gt; {
            btn.addEventListener("click", function () {
              const idx = parseInt(this.dataset.idx, 10);
              removeBenef(idx);
            });
            btn.style.backgroundColor = "#ff5082";
            btn.style.borderColor = "#ff5082";
            btn.style.color = "#fff";
          },
        );
        // Listeners montant
        Array.from(document.getElementsByClassName("montant-cell")).forEach(
          (input) =&gt; {
            input.addEventListener("blur", function () {
              const idx = parseInt(this.dataset.idx, 10);
              let val = parseFrNumber(this.value);
              if (isNaN(val)) val = 0;
              this.value = formatFrNumber(val);
              distributionBenefs[idx].montant = val;
              distributionBenefs[idx].montantManuel = true;
              saveDistributionBenefs();
              refreshBenefTable();
            });
            input.style.maxWidth = "120px";
            input.style.width = "120px";
          },
        );
        refreshBenefSelect();
      }
      // --- Suppression d'un b√©n√©ficiaire ---
      function removeBenef(idx) {
        // On retire le b√©n√©ficiaire du tableau principal
        const removed = distributionBenefs.splice(idx, 1)[0];
        saveDistributionBenefs();
        refreshBenefTable();
        refreshBenefSelect();
      }
      // --- Modal droits : ouverture et remplissage ---
      let currentModalBenefId = null;
      function openDroitsModal(idx) {
        currentModalBenefId = idx;
        const benef = distributionBenefs[idx];
        document.getElementById("modal-benef-name").textContent = benef.name;
        document.getElementById("droits-pp-qty").value = formatFrNumber(
          benef.droits.PP.qty,
        );
        document.getElementById("droits-pp-montant").value = formatFrNumber(
          benef.droits.PP.montant,
        );
        document.getElementById("droits-np-qty").value = formatFrNumber(
          benef.droits.NP.qty,
        );
        document.getElementById("droits-np-montant").value = formatFrNumber(
          benef.droits.NP.montant,
        );
        document.getElementById("droits-u-qty").value = formatFrNumber(
          benef.droits.U.qty,
        );
        document.getElementById("droits-u-montant").value = formatFrNumber(
          benef.droits.U.montant,
        );
        updateDroitsTotal();
        document.getElementById("droits-modal").style.display = "";
      }
      function closeDroitsModal() {
        document.getElementById("droits-modal").style.display = "none";
        currentModalBenefId = null;
      }
      // --- Modal droits : listeners blur pour formatage et calcul total ---
      [
        "droits-pp-qty",
        "droits-pp-montant",
        "droits-np-qty",
        "droits-np-montant",
        "droits-u-qty",
        "droits-u-montant",
      ].forEach((id) =&gt; {
        document.getElementById(id).addEventListener("blur", function () {
          let val = parseFrNumber(this.value);
          if (isNaN(val)) val = 0;
          this.value = formatFrNumber(val);
          updateDroitsTotal();
        });
        // R√©duction taille
        if (id.endsWith("qty")) {
          document.getElementById(id).style.maxWidth = "90px";
          document.getElementById(id).style.width = "90px";
        } else {
          document.getElementById(id).style.maxWidth = "120px";
          document.getElementById(id).style.width = "120px";
        }
      });
      // --- Calcul du total dans le modal droits ---
      function updateDroitsTotal() {
        const pp =
          parseFrNumber(document.getElementById("droits-pp-montant").value) ||
          0;
        const np =
          parseFrNumber(document.getElementById("droits-np-montant").value) ||
          0;
        const u =
          parseFrNumber(document.getElementById("droits-u-montant").value) || 0;
        document.getElementById("droits-total-montant").value = formatFrNumber(
          pp + np + u,
        );
      }
      // --- Validation du modal droits ---
      document
        .getElementById("droits-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          if (currentModalBenefId === null) return;
          const idx = currentModalBenefId;
          const benef = distributionBenefs[idx];
          benef.droits.PP.qty =
            parseFrNumber(document.getElementById("droits-pp-qty").value) || 0;
          benef.droits.PP.montant =
            parseFrNumber(document.getElementById("droits-pp-montant").value) ||
            0;
          benef.droits.NP.qty =
            parseFrNumber(document.getElementById("droits-np-qty").value) || 0;
          benef.droits.NP.montant =
            parseFrNumber(document.getElementById("droits-np-montant").value) ||
            0;
          benef.droits.U.qty =
            parseFrNumber(document.getElementById("droits-u-qty").value) || 0;
          benef.droits.U.montant =
            parseFrNumber(document.getElementById("droits-u-montant").value) ||
            0;
          // Calcul du total
          const total =
            benef.droits.PP.montant +
            benef.droits.NP.montant +
            benef.droits.U.montant;
          // Si le montant n'a pas √©t√© modifi√© manuellement, on synchronise
          if (!benef.montantManuel) {
            benef.montant = total;
          }
          saveDistributionBenefs();
          closeDroitsModal();
          refreshBenefTable();
        });
      document
        .getElementById("droits-cancel")
        .addEventListener("click", function () {
          closeDroitsModal();
        });
      // --- R√©partition automatique du montant principal ---
      document
        .getElementById("btn-repartir")
        .addEventListener("click", function () {
          const montantTotal =
            parseFrNumber(
              document.getElementById("distribution-amount").value,
            ) || 0;
          // Calcul du total des droits PP+U
          let totalPPU = 0;
          distributionBenefs.forEach((b) =&gt; {
            totalPPU += (b.droits.PP.qty || 0) + (b.droits.U.qty || 0);
          });
          if (totalPPU === 0) return;
          // R√©partition au prorata des droits PP+U, NP = 0
          let reste = montantTotal;
          distributionBenefs.forEach((b, idx) =&gt; {
            const droitsPPU = (b.droits.PP.qty || 0) + (b.droits.U.qty || 0);
            let part =
              Math.round(((montantTotal * droitsPPU) / totalPPU) * 100) / 100;
            if (idx === distributionBenefs.length - 1) part = reste;
            reste -= part;
            // R√©partition dans le modal
            let montantPP = 0,
              montantU = 0;
            if (droitsPPU &gt; 0) {
              montantPP =
                Math.round(
                  ((part * (b.droits.PP.qty || 0)) / droitsPPU) * 100,
                ) / 100;
              montantU = part - montantPP;
            }
            b.droits.PP.montant = montantPP;
            b.droits.NP.montant = 0;
            b.droits.U.montant = montantU;
            // Synchronisation du montant si pas manuel
            if (!b.montantManuel) {
              b.montant = montantPP + montantU;
            }
          });
          saveDistributionBenefs();
          refreshBenefTable();
        });
      // --- Formatage initial du champ montant principal ---
      document
        .getElementById("distribution-amount")
        .addEventListener("blur", function () {
          let val = parseFrNumber(this.value);
          if (isNaN(val)) val = 0;
          this.value = formatFrNumber(val);
        });
      // --- Listener sur la forme juridique ---
      document
        .getElementById("distribution-legal-form")
        .addEventListener("change", function () {
          formeJuridique = this.value;
          saveFormeJuridique();
          updateCategorieTitre();
        });
      // --- Mise √† jour du titre de cat√©gorie de titres selon la forme juridique ---
      function updateCategorieTitre() {
        let titre =
          formeJuridique === "SAS" ? "Actions ordinaires" : "Parts sociales";
        // Mise √† jour du th dans le thead
        var th = document.getElementById("th-categorie-titre");
        if (th) th.textContent = titre;
      }
      // --- Sauvegarde automatique des champs du formulaire de distribution ---
      function saveDistributionDetails() {
        const details = {
          date: document.getElementById("distribution-date").value || "",
          type: document.getElementById("distribution-type").value || "",
          source: document.getElementById("distribution-source").value || "",
          montant: document.getElementById("distribution-amount").value || "",
        };
        localStorage.setItem("distributionDetails", JSON.stringify(details));
      }
      function loadDistributionDetails() {
        const raw = localStorage.getItem("distributionDetails");
        if (raw) {
          try {
            const details = JSON.parse(raw);
            if (details &amp;&amp; typeof details === "object") {
              if (details.date)
                document.getElementById("distribution-date").value =
                  details.date;
              if (details.type)
                document.getElementById("distribution-type").value =
                  details.type;
              if (details.source)
                document.getElementById("distribution-source").value =
                  details.source;
              if (details.montant)
                document.getElementById("distribution-amount").value =
                  details.montant;
            }
          } catch (e) {}
        }
      }

      function applyIntentFromList() {
        let intent = null;
        try {
          intent = JSON.parse(
            localStorage.getItem("distModalIntent") || "null",
          );
        } catch {}

        if (!intent || !intent.action) return;

        // Mode ajout : on part sur un √©cran vide (ou les valeurs actuelles)
        if (intent.action === "add") {
          localStorage.removeItem("distributionEditingId");
          localStorage.setItem("distributionMode", "add");
          return;
        }

        // Mode edit / view : on charge la distribution depuis distributionsData
        if (
          (intent.action === "edit" || intent.action === "view") &amp;&amp;
          intent.id != null
        ) {
          let list = [];
          try {
            list = JSON.parse(
              localStorage.getItem("distributionsData") || "[]",
            );
          } catch {}

          const dist = list.find((d) =&gt; Number(d.id) === Number(intent.id));
          if (!dist) return;

          // Hydrate les stores utilis√©s par l'√©cran 2/3
          localStorage.setItem(
            "distributionDetails",
            JSON.stringify(dist.details || {}),
          );
          localStorage.setItem(
            "distributionLegalForm",
            dist.legalForm || "SARL",
          );
          localStorage.setItem(
            "distributionBeneficiaires",
            JSON.stringify(dist.beneficiaires || []),
          );

          localStorage.setItem("distributionEditingId", String(dist.id));
          localStorage.setItem("distributionMode", intent.action); // "edit" ou "view"
        }
      }

      function getLegalForm() {
        return localStorage.getItem("distributionLegalForm") || "SARL";
      }

      function getDistributionDetails() {
        try {
          return JSON.parse(
            localStorage.getItem("distributionDetails") || "{}",
          );
        } catch (e) {
          return {};
        }
      }

      // --- Initialisation ---

      function init() {
        // üîπ Lire l‚Äôintent
        let intent = null;
        try {
          intent = JSON.parse(
            localStorage.getItem("distModalIntent") || "null",
          );
        } catch {}

        const editingId = localStorage.getItem("distributionEditingId");

        // üîπ Cas √©dition / visualisation
        if (editingId) {
          const list = JSON.parse(
            localStorage.getItem("distributionsData") || "[]",
          );
          const dist = list.find((d) =&gt; d.id == editingId);

          if (dist) {
            details = dist.details || {};
            formeJuridique = dist.legalForm || "SARL";
            distributionBenefs = (dist.beneficiaires || []).map((b) =&gt; {
              return {
                id: b.id,
                name: b.name,
                pays: b.pays,
                droits: {
                  PP: { qty: b.pp || 0, montant: b.ppMontant || 0 },
                  NP: { qty: b.np || 0, montant: b.npMontant || 0 },
                  U: { qty: b.u || 0, montant: b.uMontant || 0 },
                },
                montant: b.montant || 0,
                montantManuel: true,
              };
            });
          }
        } else {
          // üîπ Cas nouvelle distribution
          details = {
            date: "",
            type: "dividendes",
            source: "",
            montant: "0,00",
          };
          distributionBenefs = [];
        }

        // üîπ Remplir formulaire
        document.getElementById("distribution-date").value = details.date || "";
        document.getElementById("distribution-type").value =
          details.type || "dividendes";
        document.getElementById("distribution-source").value =
          details.source || "";
        document.getElementById("distribution-amount").value =
          details.montant || "0,00";
        document.getElementById("distribution-legal-form").value =
          formeJuridique;

        // üîπ Rendu
        refreshBenefTable();
        refreshBenefSelect();

        // üîπ Mode read-only
        if (localStorage.getItem("distributionMode") === "view") {
          applyViewModeIfNeeded();
        }
      }

      init();
      // --- Bouton Suivant ---
      document
        .getElementById("btn-next")
        .addEventListener("click", function () {
          window.parent.postMessage(
            { type: "po:navigate", action: "goto", index: 3 },
            "*",
          );
        });
    &lt;/script&gt;
  

&lt;/body&gt;&lt;/html&gt;</pre></div><div class="chat-message assistant"><pre style="margin: 0px; white-space: pre-wrap; user-select: text;">ü§ñ L‚Äôerreur est que la fonction saveDistributionDetails() (qui sauvegarde la date, le type, la source et le montant dans le localStorage sous "distributionDetails") n‚Äôest jamais appel√©e automatiquement dans l‚Äô√©cran 2.

Donc, quand tu cliques sur "Suivant", les valeurs du formulaire ne sont pas enregistr√©es dans le localStorage. R√©sultat‚ÄØ: sur l‚Äô√©cran 3, les champs details sont vides ou undefined, et donc sur l‚Äô√©cran 1 aussi.

**O√π et quand cela devrait se sauvegarder‚ÄØ?**
Il faut appeler saveDistributionDetails() :
- soit √† chaque modification d‚Äôun champ du formulaire (date, type, source, montant)
- soit juste avant de passer √† l‚Äô√©cran 3 (dans le handler du bouton "Suivant")

**Correction simple‚ÄØ:**
Ajoute un appel √† saveDistributionDetails() dans le listener du bouton "Suivant"‚ÄØ:

document.getElementById("btn-next").addEventListener("click", function () {
  saveDistributionDetails();
  window.parent.postMessage(
    { type: "po:navigate", action: "goto", index: 3 },
    "*",
  );
});

Ou bien, ajoute un listener "change" ou "blur" sur chaque champ pour appeler saveDistributionDetails() √† chaque modification.

**R√©sum√©‚ÄØ:**
Tu dois appeler saveDistributionDetails() avant de quitter l‚Äô√©cran 2, sinon les infos ne sont pas sauvegard√©es dans le localStorage.</pre></div><div class="chat-message user"><pre style="margin: 0px; white-space: pre-wrap; user-select: text;">üë§ dis moi exactement apr√®s quelle ligne de l'√©cran 2 ajouter quoi au juste</pre></div><div class="chat-message assistant"><pre style="margin: 0px; white-space: pre-wrap; user-select: text;">ü§ñ Dans l‚Äô√©cran 2, tu dois ajouter l‚Äôappel √† la fonction saveDistributionDetails() juste avant la navigation vers l‚Äô√©cran 3.

Rep√®re ce bloc √† la fin du script de l‚Äô√©cran 2‚ÄØ:

document.getElementById("btn-next").addEventListener("click", function () {
  window.parent.postMessage(
    { type: "po:navigate", action: "goto", index: 3 },
    "*",
  );
});

**Tu dois modifier ce bloc ainsi‚ÄØ:**

document.getElementById("btn-next").addEventListener("click", function () {
  saveDistributionDetails();
  window.parent.postMessage(
    { type: "po:navigate", action: "goto", index: 3 },
    "*",
  );
});

**Donc, ajoute la ligne suivante juste avant window.parent.postMessage‚ÄØ:**

saveDistributionDetails();

**R√©sum√©‚ÄØ:**
Ajoute la ligne saveDistributionDetails(); juste avant la ligne window.parent.postMessage(...); dans le listener du bouton "Suivant" (btn-next).</pre></div></div><div class="chat-images" style="display:none"></div><div class="chat-files" style="display:none"></div><div class="chat-input"><textarea class="chat-text" placeholder="Ecrire prompt ici.">tu sais pourquoi le </textarea></div></div><div class="elements"><div class="elements-toolbar"><div class="toolbar-left"><label class="inline-inc"><input type="checkbox" checked="" id="inc-screen-1" value="on"> Inclure le HTML actuel</label><button class="btn brand" data-role="load">Charger un fichier HTML‚Ä¶</button><button class="btn brand gen" data-role="gen">G√©n√©rer avec l‚ÄôIA</button></div><div class="toolbar-right"><button class="btn" data-role="edit-html">‚úèÔ∏è √âditer HTML</button><button class="btn brand gen" data-role="export-html">Exporter HTML</button><button class="btn" data-role="chat">üí¨ Discuter</button><button class="btn danger" data-role="reset-html">Vider HTML</button></div></div><iframe class="frame" title="Aper√ßu de l‚Äô√©cran" srcdoc="&lt;!doctype html&gt;
&lt;html lang=&quot;fr&quot;&gt;&lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width,initial-scale=1&quot;&gt;
    &lt;title&gt;Liste des distributions - Dividendes et int√©r√™ts&lt;/title&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;vikta-task.css&quot;&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div class=&quot;container-fluid&quot;&gt;
      &lt;div class=&quot;row mb-3&quot;&gt;
        &lt;div class=&quot;col-12&quot;&gt;
          &lt;div class=&quot;d-flex justify-content-end&quot;&gt;
            &lt;button class=&quot;btn btn-primary btn-datatable-add&quot; id=&quot;btn-add-distribution&quot; type=&quot;button&quot;&gt;
              Ajouter une distribution
            &lt;/button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;table class=&quot;display datatable table table-hover dataTable&quot; id=&quot;main-datatable&quot;&gt;
        &lt;thead&gt;
          &lt;tr class=&quot;ve-table-header&quot;&gt;
            &lt;th class=&quot;sortable&quot; data-col=&quot;date&quot; scope=&quot;col&quot; aria-sort=&quot;none&quot;&gt;
              &lt;button type=&quot;button&quot; class=&quot;th-sort&quot;&gt;
                &lt;span class=&quot;label&quot;&gt;&lt;strong&gt;Date&lt;/strong&gt;&lt;/span&gt;
                &lt;span class=&quot;sort-icon&quot; aria-hidden=&quot;true&quot;&gt;&lt;/span&gt;
              &lt;/button&gt;
            &lt;/th&gt;

            &lt;th class=&quot;sortable&quot; data-col=&quot;type&quot; scope=&quot;col&quot; aria-sort=&quot;none&quot;&gt;
              &lt;button type=&quot;button&quot; class=&quot;th-sort&quot;&gt;
                &lt;span class=&quot;label&quot;&gt;&lt;strong&gt;Type&lt;/strong&gt;&lt;/span&gt;
                &lt;span class=&quot;sort-icon&quot; aria-hidden=&quot;true&quot;&gt;&lt;/span&gt;
              &lt;/button&gt;
            &lt;/th&gt;

            &lt;th class=&quot;sortable&quot; data-col=&quot;source&quot; scope=&quot;col&quot; aria-sort=&quot;none&quot;&gt;
              &lt;button type=&quot;button&quot; class=&quot;th-sort&quot;&gt;
                &lt;span class=&quot;label&quot;&gt;&lt;strong&gt;Source&lt;/strong&gt;&lt;/span&gt;
                &lt;span class=&quot;sort-icon&quot; aria-hidden=&quot;true&quot;&gt;&lt;/span&gt;
              &lt;/button&gt;
            &lt;/th&gt;

            &lt;th class=&quot;sortable text-right&quot; data-col=&quot;montant&quot; scope=&quot;col&quot; aria-sort=&quot;none&quot;&gt;
              &lt;button type=&quot;button&quot; class=&quot;th-sort&quot;&gt;
                &lt;span class=&quot;label&quot;&gt;&lt;strong&gt;Montant&lt;/strong&gt;&lt;/span&gt;
                &lt;span class=&quot;sort-icon&quot; aria-hidden=&quot;true&quot;&gt;&lt;/span&gt;
              &lt;/button&gt;
            &lt;/th&gt;

            &lt;th scope=&quot;col&quot;&gt;
              &lt;div class=&quot;ve-datatable-heading-label&quot;&gt;
                &lt;strong&gt;Actions&lt;/strong&gt;
              &lt;/div&gt;
            &lt;/th&gt;
          &lt;/tr&gt;
        &lt;/thead&gt;
        &lt;tbody id=&quot;distributions-tbody&quot;&gt;&lt;/tbody&gt;
      &lt;/table&gt;
    &lt;/div&gt;

    &lt;script&gt;
      // Donn√©es exemples
      let distributions = [];

      function loadDistributions() {
        const raw = localStorage.getItem(&quot;distributionsData&quot;);
        if (raw) {
          distributions = JSON.parse(raw);
        } else {
          distributions = [
            {
              id: 1,
              locked: false,
              details: {
                date: &quot;2024-03-15&quot;,
                type: &quot;Dividende&quot;,
                source: &quot;Soci√©t√© ABC&quot;,
                montant: &quot;3000&quot;,
              },
              beneficiaires: [],
            },
            {
              id: 2,
              locked: true,
              details: {
                date: &quot;2024-04-10&quot;,
                type: &quot;Int√©r√™t&quot;,
                source: &quot;Compte courant associ√©&quot;,
                montant: &quot;1500,5&quot;,
              },
              beneficiaires: [],
            },
            {
              id: 3,
              locked: false,
              details: {
                date: &quot;2024-05-05&quot;,
                type: &quot;Dividende&quot;,
                source: &quot;Soci√©t√© XYZ&quot;,
                montant: &quot;5000&quot;,
              },
              beneficiaires: [],
            },
          ];
          localStorage.setItem(
            &quot;distributionsData&quot;,
            JSON.stringify(distributions),
          );
        }
      }

      function saveDistributions() {
        localStorage.setItem(
          &quot;distributionsData&quot;,
          JSON.stringify(distributions),
        );
      }

      let sortState = { col: null, asc: true };

      function formatFrNumber(value) {
        return Number(value).toLocaleString(&quot;fr-FR&quot;, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      }
      function parseFrNumber(text) {
        if (!text) return 0;
        return Number(String(text).replace(/\s/g, &quot;&quot;).replace(&quot;,&quot;, &quot;.&quot;));
      }

      function renderTable() {
        const tbody = document.getElementById(&quot;distributions-tbody&quot;);
        tbody.innerHTML = &quot;&quot;;
        distributions.forEach((dist, idx) =&gt; {
          const d = dist.details || {};
          const formattedDate = d.date
            ? d.date.split(&quot;-&quot;).reverse().join(&quot;/&quot;)
            : &quot;&quot;;
          const tr = document.createElement(&quot;tr&quot;);
          // Coloration altern√©e
          if (idx % 2 === 1) {
            tr.style.background = &quot;#f6f9ff&quot;;
          }
          // Colonnes avec bordures verticales
          tr.innerHTML = `
      &lt;td style=&quot;border-right:2px solid #f6f9ff;&quot;&gt;&lt;span&gt;&lt;span&gt;${formattedDate}&lt;/span&gt;&lt;/span&gt;&lt;/td&gt;
      &lt;td style=&quot;border-right:2px solid #f6f9ff;&quot;&gt;&lt;span&gt;${d.type}&lt;/span&gt;&lt;/td&gt;
      &lt;td style=&quot;border-right:2px solid #f6f9ff;&quot;&gt;&lt;span&gt;${d.source}&lt;/span&gt;&lt;/td&gt;
      &lt;td style=&quot;border-right:2px solid #f6f9ff;&quot; class=&quot;text-right&quot;&gt;&lt;span&gt;${formatFrNumber(parseFrNumber(d.montant))}&lt;/span&gt;&lt;/td&gt;
      &lt;td&gt;
        &lt;button class=&quot;btn btn-link btn-action btn-edit&quot; title=&quot;${dist.locked ? &quot;Visualiser&quot; : &quot;√âditer&quot;}&quot; data-id=&quot;${dist.id}&quot; style=&quot;vertical-align:middle;${dist.locked ? &quot;display:none;&quot; : &quot;&quot;}&quot;&gt;
          &lt;svg viewBox=&quot;0 0 24 24&quot; aria-hidden=&quot;true&quot;&gt;
  &lt;path d=&quot;M3 21h6&quot;&gt;&lt;/path&gt;
  &lt;path d=&quot;M14.5 4.5l5 5&quot;&gt;&lt;/path&gt;
  &lt;path d=&quot;M12 7l5 5L7 22H2v-5z&quot;&gt;&lt;/path&gt;
&lt;/svg&gt;
        &lt;/button&gt;
        &lt;button class=&quot;btn btn-link btn-action btn-view&quot; title=&quot;Visualiser&quot; data-id=&quot;${dist.id}&quot; style=&quot;vertical-align:middle;${dist.locked ? &quot;&quot; : &quot;display:none;&quot;}&quot;&gt;
          &lt;svg viewBox=&quot;0 0 24 24&quot; aria-hidden=&quot;true&quot;&gt;
  &lt;path d=&quot;M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z&quot;&gt;&lt;/path&gt;
  &lt;circle cx=&quot;12&quot; cy=&quot;12&quot; r=&quot;3&quot;&gt;&lt;/circle&gt;
&lt;/svg&gt;
        &lt;/button&gt;
        &lt;button class=&quot;btn btn-link btn-action btn-delete&quot; title=&quot;Supprimer&quot; data-id=&quot;${dist.id}&quot; style=&quot;vertical-align:middle;&quot;&gt;
  &lt;svg viewBox=&quot;0 0 24 24&quot; aria-hidden=&quot;true&quot;&gt;
    &lt;path d=&quot;M3 6h18&quot;&gt;&lt;/path&gt;
    &lt;path d=&quot;M8 6V4h8v2&quot;&gt;&lt;/path&gt;
    &lt;path d=&quot;M6 6l1 16h10l1-16&quot;&gt;&lt;/path&gt;
    &lt;path d=&quot;M10 11v6&quot;&gt;&lt;/path&gt;
    &lt;path d=&quot;M14 11v6&quot;&gt;&lt;/path&gt;
  &lt;/svg&gt;
&lt;/button&gt;
        &lt;button class=&quot;btn btn-link btn-action btn-lock&quot; title=&quot;${dist.locked ? &quot;D√©verrouiller&quot; : &quot;Verrouiller&quot;}&quot; data-id=&quot;${dist.id}&quot; style=&quot;vertical-align:middle;&quot;&gt;
          ${
            dist.locked
              ? `&lt;svg viewBox=&quot;0 0 24 24&quot; aria-hidden=&quot;true&quot;&gt;
       &lt;path d=&quot;M8 11V8a4 4 0 0 1 8 0v3&quot;&gt;&lt;/path&gt;
       &lt;rect x=&quot;6&quot; y=&quot;11&quot; width=&quot;12&quot; height=&quot;10&quot; rx=&quot;2&quot;&gt;&lt;/rect&gt;
     &lt;/svg&gt;`
              : `&lt;svg viewBox=&quot;0 0 24 24&quot; aria-hidden=&quot;true&quot;&gt;
       &lt;path d=&quot;M8 11V8a4 4 0 0 1 7-2&quot;&gt;&lt;/path&gt;
       &lt;rect x=&quot;6&quot; y=&quot;11&quot; width=&quot;12&quot; height=&quot;10&quot; rx=&quot;2&quot;&gt;&lt;/rect&gt;
     &lt;/svg&gt;`
          }
        &lt;/button&gt;
      &lt;/td&gt;
    `;
          tbody.appendChild(tr);
        });
        updateSortIndicators();
      }

      // Tri
      function sortBy(col) {
        if (sortState.col === col) {
          sortState.asc = !sortState.asc;
        } else {
          sortState.col = col;
          sortState.asc = true;
        }
        distributions.sort((a, b) =&gt; {
          let va = (a.details || {})[col];
          let vb = (b.details || {})[col];
          if (col === &quot;montant&quot;) {
            va = Number(va);
            vb = Number(vb);
          } else if (col === &quot;date&quot;) {
            va = va;
            vb = vb;
          } else {
            va = String(va).toLowerCase();
            vb = String(vb).toLowerCase();
          }
          if (va &lt; vb) return sortState.asc ? -1 : 1;
          if (va &gt; vb) return sortState.asc ? 1 : -1;
          return 0;
        });
        renderTable();
      }

      // Actions

      window.addEventListener(&quot;message&quot;, function (e) {
        const data = e.data || {};
        if (data.type === &quot;po:activate&quot; &amp;&amp; data.index === 1) {
          loadDistributions();
          renderTable();
        }
      });
      document.addEventListener(&quot;click&quot;, function (e) {
        // Ajouter
        if (e.target.closest(&quot;#btn-add-distribution&quot;)) {
          localStorage.setItem(&quot;distModalIntent&quot;, JSON.stringify({ action: &quot;add&quot; }));
          localStorage.removeItem(&quot;distributionDetails&quot;);
          localStorage.removeItem(&quot;distributionBeneficiaires&quot;);
          localStorage.removeItem(&quot;distributionEditingId&quot;);
          localStorage.setItem(&quot;distributionMode&quot;, &quot;add&quot;);
          window.parent.postMessage({ type: &quot;po:navigate&quot;, action: &quot;goto&quot;, index: 2 }, &quot;*&quot;);
        }
        // Editer
        if (e.target.closest(&quot;.btn-edit&quot;)) {
          const id = Number(e.target.closest(&quot;.btn-edit&quot;).dataset.id);
          localStorage.setItem(&quot;distModalIntent&quot;, JSON.stringify({ action: &quot;edit&quot;, id }));
          localStorage.setItem(&quot;distributionEditingId&quot;, String(id));
          localStorage.setItem(&quot;distributionMode&quot;, &quot;edit&quot;);
          window.parent.postMessage({ type: &quot;po:navigate&quot;, action: &quot;goto&quot;, index: 2 }, &quot;*&quot;);
        }
        // Visualiser
        if (e.target.closest(&quot;.btn-view&quot;)) {
          const id = Number(e.target.closest(&quot;.btn-view&quot;).dataset.id);
          localStorage.setItem(&quot;distModalIntent&quot;, JSON.stringify({ action: &quot;view&quot;, id }));
          localStorage.setItem(&quot;distributionEditingId&quot;, String(id));
          localStorage.setItem(&quot;distributionMode&quot;, &quot;view&quot;);
          window.parent.postMessage({ type: &quot;po:navigate&quot;, action: &quot;goto&quot;, index: 2 }, &quot;*&quot;);
        }
        // Supprimer
        if (e.target.closest(&quot;.btn-delete&quot;)) {
          const id = Number(e.target.closest(&quot;.btn-delete&quot;).dataset.id);
          if (confirm(&quot;Supprimer cette distribution ?&quot;)) {
            distributions = distributions.filter((d) =&gt; d.id !== id);
            saveDistributions();
            renderTable();
          }
        }
        // Verrouiller/D√©verrouiller
        if (e.target.closest(&quot;.btn-lock&quot;)) {
          const id = Number(e.target.closest(&quot;.btn-lock&quot;).dataset.id);
          const dist = distributions.find((d) =&gt; d.id === id);
          dist.locked = !dist.locked;
          saveDistributions();
          renderTable();
        }
        // Tri (clic sur l'en-t√™te)
        const th = e.target.closest(&quot;th.sortable&quot;);
        if (th &amp;&amp; e.target.closest(&quot;button.th-sort&quot;)) {
          sortBy(th.dataset.col);
        }
      });

      // Met √† jour l'indicateur de tri sur la bonne colonne
      function updateSortIndicators() {
        document.querySelectorAll(&quot;th.sortable&quot;).forEach((th) =&gt; {
          const col = th.dataset.col;
          if (sortState.col !== col) {
            th.setAttribute(&quot;aria-sort&quot;, &quot;none&quot;);
            return;
          }
          th.setAttribute(
            &quot;aria-sort&quot;,
            sortState.asc ? &quot;ascending&quot; : &quot;descending&quot;,
          );
        });
      }

      // Initialisation
      loadDistributions();
      renderTable();
    &lt;/script&gt;
  

&lt;/body&gt;&lt;/html&gt;"></iframe><textarea class="html-source" style="display:none">&lt;!doctype html&gt;
&lt;html lang="fr"&gt;&lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;meta name="viewport" content="width=device-width,initial-scale=1"&gt;
    &lt;title&gt;Liste des distributions - Dividendes et int√©r√™ts&lt;/title&gt;
    &lt;link rel="stylesheet" href="vikta-task.css"&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div class="container-fluid"&gt;
      &lt;div class="row mb-3"&gt;
        &lt;div class="col-12"&gt;
          &lt;div class="d-flex justify-content-end"&gt;
            &lt;button class="btn btn-primary btn-datatable-add" id="btn-add-distribution" type="button"&gt;
              Ajouter une distribution
            &lt;/button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;table class="display datatable table table-hover dataTable" id="main-datatable"&gt;
        &lt;thead&gt;
          &lt;tr class="ve-table-header"&gt;
            &lt;th class="sortable" data-col="date" scope="col" aria-sort="none"&gt;
              &lt;button type="button" class="th-sort"&gt;
                &lt;span class="label"&gt;&lt;strong&gt;Date&lt;/strong&gt;&lt;/span&gt;
                &lt;span class="sort-icon" aria-hidden="true"&gt;&lt;/span&gt;
              &lt;/button&gt;
            &lt;/th&gt;

            &lt;th class="sortable" data-col="type" scope="col" aria-sort="none"&gt;
              &lt;button type="button" class="th-sort"&gt;
                &lt;span class="label"&gt;&lt;strong&gt;Type&lt;/strong&gt;&lt;/span&gt;
                &lt;span class="sort-icon" aria-hidden="true"&gt;&lt;/span&gt;
              &lt;/button&gt;
            &lt;/th&gt;

            &lt;th class="sortable" data-col="source" scope="col" aria-sort="none"&gt;
              &lt;button type="button" class="th-sort"&gt;
                &lt;span class="label"&gt;&lt;strong&gt;Source&lt;/strong&gt;&lt;/span&gt;
                &lt;span class="sort-icon" aria-hidden="true"&gt;&lt;/span&gt;
              &lt;/button&gt;
            &lt;/th&gt;

            &lt;th class="sortable text-right" data-col="montant" scope="col" aria-sort="none"&gt;
              &lt;button type="button" class="th-sort"&gt;
                &lt;span class="label"&gt;&lt;strong&gt;Montant&lt;/strong&gt;&lt;/span&gt;
                &lt;span class="sort-icon" aria-hidden="true"&gt;&lt;/span&gt;
              &lt;/button&gt;
            &lt;/th&gt;

            &lt;th scope="col"&gt;
              &lt;div class="ve-datatable-heading-label"&gt;
                &lt;strong&gt;Actions&lt;/strong&gt;
              &lt;/div&gt;
            &lt;/th&gt;
          &lt;/tr&gt;
        &lt;/thead&gt;
        &lt;tbody id="distributions-tbody"&gt;&lt;/tbody&gt;
      &lt;/table&gt;
    &lt;/div&gt;

    &lt;script&gt;
      // Donn√©es exemples
      let distributions = [];

      function loadDistributions() {
        const raw = localStorage.getItem("distributionsData");
        if (raw) {
          distributions = JSON.parse(raw);
        } else {
          distributions = [
            {
              id: 1,
              locked: false,
              details: {
                date: "2024-03-15",
                type: "Dividende",
                source: "Soci√©t√© ABC",
                montant: "3000",
              },
              beneficiaires: [],
            },
            {
              id: 2,
              locked: true,
              details: {
                date: "2024-04-10",
                type: "Int√©r√™t",
                source: "Compte courant associ√©",
                montant: "1500,5",
              },
              beneficiaires: [],
            },
            {
              id: 3,
              locked: false,
              details: {
                date: "2024-05-05",
                type: "Dividende",
                source: "Soci√©t√© XYZ",
                montant: "5000",
              },
              beneficiaires: [],
            },
          ];
          localStorage.setItem(
            "distributionsData",
            JSON.stringify(distributions),
          );
        }
      }

      function saveDistributions() {
        localStorage.setItem(
          "distributionsData",
          JSON.stringify(distributions),
        );
      }

      let sortState = { col: null, asc: true };

      function formatFrNumber(value) {
        return Number(value).toLocaleString("fr-FR", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      }
      function parseFrNumber(text) {
        if (!text) return 0;
        return Number(String(text).replace(/\s/g, "").replace(",", "."));
      }

      function renderTable() {
        const tbody = document.getElementById("distributions-tbody");
        tbody.innerHTML = "";
        distributions.forEach((dist, idx) =&gt; {
          const d = dist.details || {};
          const formattedDate = d.date
            ? d.date.split("-").reverse().join("/")
            : "";
          const tr = document.createElement("tr");
          // Coloration altern√©e
          if (idx % 2 === 1) {
            tr.style.background = "#f6f9ff";
          }
          // Colonnes avec bordures verticales
          tr.innerHTML = `
      &lt;td style="border-right:2px solid #f6f9ff;"&gt;&lt;span&gt;&lt;span&gt;${formattedDate}&lt;/span&gt;&lt;/span&gt;&lt;/td&gt;
      &lt;td style="border-right:2px solid #f6f9ff;"&gt;&lt;span&gt;${d.type}&lt;/span&gt;&lt;/td&gt;
      &lt;td style="border-right:2px solid #f6f9ff;"&gt;&lt;span&gt;${d.source}&lt;/span&gt;&lt;/td&gt;
      &lt;td style="border-right:2px solid #f6f9ff;" class="text-right"&gt;&lt;span&gt;${formatFrNumber(parseFrNumber(d.montant))}&lt;/span&gt;&lt;/td&gt;
      &lt;td&gt;
        &lt;button class="btn btn-link btn-action btn-edit" title="${dist.locked ? "Visualiser" : "√âditer"}" data-id="${dist.id}" style="vertical-align:middle;${dist.locked ? "display:none;" : ""}"&gt;
          &lt;svg viewBox="0 0 24 24" aria-hidden="true"&gt;
  &lt;path d="M3 21h6"&gt;&lt;/path&gt;
  &lt;path d="M14.5 4.5l5 5"&gt;&lt;/path&gt;
  &lt;path d="M12 7l5 5L7 22H2v-5z"&gt;&lt;/path&gt;
&lt;/svg&gt;
        &lt;/button&gt;
        &lt;button class="btn btn-link btn-action btn-view" title="Visualiser" data-id="${dist.id}" style="vertical-align:middle;${dist.locked ? "" : "display:none;"}"&gt;
          &lt;svg viewBox="0 0 24 24" aria-hidden="true"&gt;
  &lt;path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"&gt;&lt;/path&gt;
  &lt;circle cx="12" cy="12" r="3"&gt;&lt;/circle&gt;
&lt;/svg&gt;
        &lt;/button&gt;
        &lt;button class="btn btn-link btn-action btn-delete" title="Supprimer" data-id="${dist.id}" style="vertical-align:middle;"&gt;
  &lt;svg viewBox="0 0 24 24" aria-hidden="true"&gt;
    &lt;path d="M3 6h18"&gt;&lt;/path&gt;
    &lt;path d="M8 6V4h8v2"&gt;&lt;/path&gt;
    &lt;path d="M6 6l1 16h10l1-16"&gt;&lt;/path&gt;
    &lt;path d="M10 11v6"&gt;&lt;/path&gt;
    &lt;path d="M14 11v6"&gt;&lt;/path&gt;
  &lt;/svg&gt;
&lt;/button&gt;
        &lt;button class="btn btn-link btn-action btn-lock" title="${dist.locked ? "D√©verrouiller" : "Verrouiller"}" data-id="${dist.id}" style="vertical-align:middle;"&gt;
          ${
            dist.locked
              ? `&lt;svg viewBox="0 0 24 24" aria-hidden="true"&gt;
       &lt;path d="M8 11V8a4 4 0 0 1 8 0v3"&gt;&lt;/path&gt;
       &lt;rect x="6" y="11" width="12" height="10" rx="2"&gt;&lt;/rect&gt;
     &lt;/svg&gt;`
              : `&lt;svg viewBox="0 0 24 24" aria-hidden="true"&gt;
       &lt;path d="M8 11V8a4 4 0 0 1 7-2"&gt;&lt;/path&gt;
       &lt;rect x="6" y="11" width="12" height="10" rx="2"&gt;&lt;/rect&gt;
     &lt;/svg&gt;`
          }
        &lt;/button&gt;
      &lt;/td&gt;
    `;
          tbody.appendChild(tr);
        });
        updateSortIndicators();
      }

      // Tri
      function sortBy(col) {
        if (sortState.col === col) {
          sortState.asc = !sortState.asc;
        } else {
          sortState.col = col;
          sortState.asc = true;
        }
        distributions.sort((a, b) =&gt; {
          let va = (a.details || {})[col];
          let vb = (b.details || {})[col];
          if (col === "montant") {
            va = Number(va);
            vb = Number(vb);
          } else if (col === "date") {
            va = va;
            vb = vb;
          } else {
            va = String(va).toLowerCase();
            vb = String(vb).toLowerCase();
          }
          if (va &lt; vb) return sortState.asc ? -1 : 1;
          if (va &gt; vb) return sortState.asc ? 1 : -1;
          return 0;
        });
        renderTable();
      }

      // Actions

      window.addEventListener("message", function (e) {
        const data = e.data || {};
        if (data.type === "po:activate" &amp;&amp; data.index === 1) {
          loadDistributions();
          renderTable();
        }
      });
      document.addEventListener("click", function (e) {
        // Ajouter
        if (e.target.closest("#btn-add-distribution")) {
          localStorage.setItem("distModalIntent", JSON.stringify({ action: "add" }));
          localStorage.removeItem("distributionDetails");
          localStorage.removeItem("distributionBeneficiaires");
          localStorage.removeItem("distributionEditingId");
          localStorage.setItem("distributionMode", "add");
          window.parent.postMessage({ type: "po:navigate", action: "goto", index: 2 }, "*");
        }
        // Editer
        if (e.target.closest(".btn-edit")) {
          const id = Number(e.target.closest(".btn-edit").dataset.id);
          localStorage.setItem("distModalIntent", JSON.stringify({ action: "edit", id }));
          localStorage.setItem("distributionEditingId", String(id));
          localStorage.setItem("distributionMode", "edit");
          window.parent.postMessage({ type: "po:navigate", action: "goto", index: 2 }, "*");
        }
        // Visualiser
        if (e.target.closest(".btn-view")) {
          const id = Number(e.target.closest(".btn-view").dataset.id);
          localStorage.setItem("distModalIntent", JSON.stringify({ action: "view", id }));
          localStorage.setItem("distributionEditingId", String(id));
          localStorage.setItem("distributionMode", "view");
          window.parent.postMessage({ type: "po:navigate", action: "goto", index: 2 }, "*");
        }
        // Supprimer
        if (e.target.closest(".btn-delete")) {
          const id = Number(e.target.closest(".btn-delete").dataset.id);
          if (confirm("Supprimer cette distribution ?")) {
            distributions = distributions.filter((d) =&gt; d.id !== id);
            saveDistributions();
            renderTable();
          }
        }
        // Verrouiller/D√©verrouiller
        if (e.target.closest(".btn-lock")) {
          const id = Number(e.target.closest(".btn-lock").dataset.id);
          const dist = distributions.find((d) =&gt; d.id === id);
          dist.locked = !dist.locked;
          saveDistributions();
          renderTable();
        }
        // Tri (clic sur l'en-t√™te)
        const th = e.target.closest("th.sortable");
        if (th &amp;&amp; e.target.closest("button.th-sort")) {
          sortBy(th.dataset.col);
        }
      });

      // Met √† jour l'indicateur de tri sur la bonne colonne
      function updateSortIndicators() {
        document.querySelectorAll("th.sortable").forEach((th) =&gt; {
          const col = th.dataset.col;
          if (sortState.col !== col) {
            th.setAttribute("aria-sort", "none");
            return;
          }
          th.setAttribute(
            "aria-sort",
            sortState.asc ? "ascending" : "descending",
          );
        });
      }

      // Initialisation
      loadDistributions();
      renderTable();
    &lt;/script&gt;
  

&lt;/body&gt;&lt;/html&gt;</textarea></div></div></div><div class="screen collapsible" id="screen-2" aria-expanded="false" draggable="true" data-index="2"><div class="screen-head"><div class="screen-left"><div class="drag-handle" title="Glisser pour r√©ordonner">‚ãÆ‚ãÆ</div><div class="screen-num" aria-label="Num√©ro d'√©cran">√âcran 2</div><input class="screen-title" placeholder="Titre de l‚Äô√©cran" value="D√©tail d'une distribution - premier √©cran"></div><div class="screen-actions"><button class="chevron" data-role="toggle" title="Plier / d√©plier" aria-expanded="false"></button><button class="btn" data-role="focus" title="Masquer texte et outils, garder l‚Äôaper√ßu en grand">Focus aper√ßu</button><button class="btn warn" data-role="delete">Supprimer</button></div></div><div class="collapsible-body"><label>Zone explicative</label><div class="rte-wrap explication"><div class="rte-toolbar"><button class="btn" data-cmd="bold" data-value="">B</button><button class="btn" data-cmd="italic" data-value="">I</button><button class="btn" data-cmd="formatBlock" data-value="H2">H2</button><button class="btn" data-cmd="insertUnorderedList" data-value="">‚Ä¢ Liste</button><button class="btn" data-cmd="insertOrderedList" data-value="">1. Liste</button><button class="btn" data-cmd="removeFormat" data-value="">Effacer</button></div><div class="rte" contenteditable="true" data-placeholder="But de l‚Äô√©cran, r√®gles, comportements attendus‚Ä¶">Cet √©cran donne le d√©tail d'une distribution entre les b√©n√©ficiaires en tenant compte des d√©membrements √©ventuels.<div>le bouton "R√©partir" permet de r√©partir le montant global entre les titulaires de PP et de U. L'user reste autoris√© √† modifier tous les montants.</div><div>Un check est r√©alis√© si le d√©membrement n'est pas coh√©rent (somme des NP != somme des U)</div></div></div><label>Discussion &amp; √©l√©ments (g√©n√©ration + aper√ßu)</label><div class="chat"><div class="chat-head"><div class="title">Discussion / Prompt IA</div></div><div class="chat-body"><div class="chat-message user"><pre style="margin: 0px; white-space: pre-wrap; user-select: text;">üë§ le bouton r√©partir ne r√©partit plus le montant entre les b√©n√©ficiaires. pourquoi?</pre></div><div class="chat-message assistant"><pre style="margin: 0px; white-space: pre-wrap; user-select: text;">ü§ñ Le bouton "R√©partir" ne r√©partit plus le montant car la r√©partition d√©pend du total des droits PP et U (pleine propri√©t√© et usufruit) de chaque b√©n√©ficiaire. Si tous les b√©n√©ficiaires ont 0 en PP et U (quantit√© de droits), alors la fonction de r√©partition ne fait rien. Il faut donc v√©rifier que chaque b√©n√©ficiaire a bien un nombre de droits PP ou U sup√©rieur √† z√©ro pour que la r√©partition fonctionne.</pre></div><div class="chat-message user"><pre style="margin: 0px; white-space: pre-wrap; user-select: text;">üë§ c'est la colonne montant en r√©alit√© qui ne se met pas √† jour quand on clique sur r√©partir. dans le modal c'est bon. mai sla colonne montant n'est pas mise √† jour</pre></div><div class="chat-message assistant"><pre style="margin: 0px; white-space: pre-wrap; user-select: text;">ü§ñ Le probl√®me vient du fait que la colonne "Montant" ne se met √† jour que si le champ montantManuel du b√©n√©ficiaire est √† false. Or, d√®s qu‚Äôon modifie manuellement un montant dans la colonne (m√™me une seule fois), montantManuel passe √† true pour ce b√©n√©ficiaire, et la r√©partition automatique ne modifie plus ce montant.

Donc, si tu veux que la colonne "Montant" soit toujours mise √† jour par le bouton "R√©partir", il faut soit :
- Remettre montantManuel √† false pour tous les b√©n√©ficiaires avant la r√©partition,
- Ou ajouter une option pour forcer la r√©partition m√™me si montantManuel est √† true.

Actuellement, le comportement est voulu pour ne pas √©craser une saisie manuelle. Si tu veux que le bouton "R√©partir" √©crase tout, il faut modifier ce comportement dans le code.</pre></div><div class="chat-message user"><pre style="margin: 0px; white-space: pre-wrap; user-select: text;">üë§ dis moi juste o√π changer cela dans le code - quelle ligne pr√©cise</pre></div><div class="chat-message assistant"><pre style="margin: 0px; white-space: pre-wrap; user-select: text;">ü§ñ Dans ton code, le comportement qui bloque la mise √† jour automatique de la colonne "Montant" se trouve dans la fonction appel√©e lors du clic sur le bouton "R√©partir". Plus pr√©cis√©ment, c‚Äôest ce bloc :

if (!b.montantManuel) {
  b.montant = montantPP + montantU;
}

Pour forcer la mise √† jour de la colonne "Montant" pour tous les b√©n√©ficiaires (m√™me ceux avec montantManuel √† true), il faut soit :
- Supprimer la condition if (!b.montantManuel) { ... }
- Ou mettre b.montantManuel √† false pour tous avant la boucle.

Dans ton code, cela se trouve autour de la ligne qui commence par :
if (!b.montantManuel) { b.montant = montantPP + montantU; }

Tu peux remplacer ce bloc par simplement :
b.montant = montantPP + montantU;

Cela forcera la mise √† jour du montant pour tous les b√©n√©ficiaires √† chaque clic sur "R√©partir".</pre></div></div><div class="chat-images" style="display:none"></div><div class="chat-files" style="display:none"></div><div class="chat-input"><textarea class="chat-text" placeholder="Ecrire prompt ici.">dis moi juste o√π changer cela dans le code - quelle ligne pr√©cise</textarea></div></div><div class="elements"><div class="elements-toolbar"><div class="toolbar-left"><label class="inline-inc"><input type="checkbox" checked="" id="inc-screen-2" value="on"> Inclure le HTML actuel</label><button class="btn brand" data-role="load">Charger un fichier HTML‚Ä¶</button><button class="btn brand gen" data-role="gen">G√©n√©rer avec l‚ÄôIA</button></div><div class="toolbar-right"><button class="btn" data-role="edit-html">‚úèÔ∏è √âditer HTML</button><button class="btn brand gen" data-role="export-html">Exporter HTML</button><button class="btn" data-role="chat">üí¨ Discuter</button><button class="btn danger" data-role="reset-html">Vider HTML</button></div></div><iframe class="frame" title="Aper√ßu de l‚Äô√©cran" srcdoc="&lt;!doctype html&gt;
&lt;html lang=&quot;fr&quot;&gt;&lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width,initial-scale=1&quot;&gt;
    &lt;title&gt;Distribution - D√©tail&lt;/title&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;vikta-task.css&quot;&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h2&gt;D√©tail d'une distribution&lt;/h2&gt;
    &lt;form id=&quot;distribution-form&quot; autocomplete=&quot;off&quot;&gt;
      &lt;div class=&quot;form-group&quot;&gt;
        &lt;label class=&quot;control-label&quot; for=&quot;distribution-date&quot;&gt;Date&lt;/label&gt;
        &lt;div&gt;
          &lt;input class=&quot;form-control&quot; id=&quot;distribution-date&quot; name=&quot;distribution-date&quot; type=&quot;date&quot; required=&quot;&quot; style=&quot;max-width: 140px; width: 140px&quot;&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div class=&quot;form-group&quot;&gt;
        &lt;label class=&quot;control-label&quot; for=&quot;distribution-type&quot;&gt;Type&lt;/label&gt;
        &lt;div&gt;
          &lt;select class=&quot;viktaselect custom-select&quot; id=&quot;distribution-type&quot; name=&quot;distribution-type&quot;&gt;
            &lt;option value=&quot;dividendes&quot; selected=&quot;&quot;&gt;Dividendes&lt;/option&gt;
            &lt;option value=&quot;interets&quot;&gt;Int√©r√™ts&lt;/option&gt;
          &lt;/select&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div class=&quot;form-group&quot;&gt;
        &lt;label class=&quot;control-label&quot; for=&quot;distribution-legal-form&quot;&gt;Forme Juridique&lt;/label&gt;
        &lt;div&gt;
          &lt;select class=&quot;viktaselect custom-select&quot; id=&quot;distribution-legal-form&quot; name=&quot;distribution-legal-form&quot;&gt;
            &lt;option value=&quot;SARL&quot; selected=&quot;&quot;&gt;SARL&lt;/option&gt;
            &lt;option value=&quot;SAS&quot;&gt;SAS&lt;/option&gt;
          &lt;/select&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div class=&quot;form-group&quot;&gt;
        &lt;label class=&quot;control-label&quot; for=&quot;distribution-source&quot;&gt;Source&lt;/label&gt;
        &lt;div&gt;
          &lt;input class=&quot;form-control&quot; id=&quot;distribution-source&quot; name=&quot;distribution-source&quot; type=&quot;text&quot; placeholder=&quot;p.ex distribution de r√©serves du 20 d√©cembre...&quot;&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div class=&quot;form-group&quot;&gt;
        &lt;label class=&quot;control-label&quot; for=&quot;distribution-amount&quot;&gt;Montant&lt;/label&gt;
        &lt;div class=&quot;controls-input-with-buttons&quot;&gt;
          &lt;input class=&quot;form-control text-right&quot; id=&quot;distribution-amount&quot; name=&quot;distribution-amount&quot; type=&quot;text&quot; value=&quot;0,00&quot; style=&quot;max-width: 120px; width: 120px&quot;&gt;
        &lt;/div&gt;
        &lt;div class=&quot;controls-buttons&quot;&gt;
          &lt;button type=&quot;button&quot; class=&quot;btn btn-primary&quot; id=&quot;btn-repartir&quot;&gt;
            R√©partir
          &lt;/button&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/form&gt;
    &lt;h3&gt;B√©n√©ficiaires de la distribution&lt;/h3&gt;
    &lt;table class=&quot;display datatable table table-hover dataTable&quot; id=&quot;main-datatable&quot;&gt;
      &lt;thead&gt;
        &lt;tr class=&quot;ve-table-header&quot;&gt;
          &lt;th colspan=&quot;5&quot;&gt;
            &lt;div class=&quot;row ve-datatable-heading&quot; id=&quot;main-datatable-heading&quot;&gt;
              &lt;div class=&quot;d-flex flex-fill&quot;&gt;
                &lt;div class=&quot;ve-datatable-searchbox&quot;&gt;&lt;/div&gt;
                &lt;div class=&quot;ve-datatable-filters&quot;&gt;&lt;/div&gt;
                &lt;div&gt;&lt;/div&gt;
              &lt;/div&gt;
            &lt;/div&gt;
          &lt;/th&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;th&gt;&lt;/th&gt;
          &lt;th colspan=&quot;2&quot; id=&quot;th-categorie-titre&quot;&gt;Parts sociales&lt;/th&gt;
          &lt;th&gt;&lt;/th&gt;
          &lt;th&gt;&lt;/th&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;th&gt;B√©n√©ficiaire&lt;/th&gt;
          &lt;th&gt;Droits&lt;br&gt;&lt;small&gt;(PP/NP/U)&lt;/small&gt;&lt;/th&gt;
          &lt;th&gt;Montant&lt;/th&gt;
          &lt;th&gt;Total&lt;/th&gt;
          &lt;th&gt;&lt;/th&gt;
        &lt;/tr&gt;
      &lt;/thead&gt;
      &lt;tbody id=&quot;benef-table-body&quot;&gt;&lt;/tbody&gt;
      &lt;tfoot&gt;
        &lt;tr&gt;
          &lt;td&gt;
            &lt;div class=&quot;row&quot;&gt;
              &lt;div class=&quot;col-12&quot;&gt;
                &lt;select class=&quot;viktaselect custom-select&quot; id=&quot;benef-select&quot; style=&quot;max-width: 180px&quot;&gt;&lt;/select&gt;
                &lt;button type=&quot;button&quot; class=&quot;btn btn-primary&quot; id=&quot;btn-add-benef&quot;&gt;
                  +
                &lt;/button&gt;
              &lt;/div&gt;
            &lt;/div&gt;
          &lt;/td&gt;
          &lt;td colspan=&quot;4&quot;&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;td&gt;&lt;strong&gt;Total&lt;/strong&gt;&lt;/td&gt;
          &lt;td id=&quot;total-droits-cell&quot;&gt;
            &lt;div&gt;
              &lt;span id=&quot;total-droits-pp&quot;&gt;PP - 0&lt;/span&gt;&lt;br&gt;
              &lt;span id=&quot;total-droits-np&quot;&gt;NP - 0&lt;/span&gt;&lt;br&gt;
              &lt;span id=&quot;total-droits-u&quot;&gt;U - 0&lt;/span&gt;
            &lt;/div&gt;
          &lt;/td&gt;
          &lt;td id=&quot;total-montant-cell&quot; class=&quot;text-right&quot;&gt;
            &lt;strong&gt;0,00&lt;/strong&gt;
          &lt;/td&gt;
          &lt;td id=&quot;total-total-cell&quot; class=&quot;text-right&quot;&gt;
            &lt;strong&gt;0,00&lt;/strong&gt;
          &lt;/td&gt;
          &lt;td&gt;&lt;/td&gt;
        &lt;/tr&gt;
      &lt;/tfoot&gt;
    &lt;/table&gt;
    &lt;div class=&quot;row mt-4&quot;&gt;
      &lt;div class=&quot;col-12 right&quot;&gt;
        &lt;button type=&quot;button&quot; class=&quot;btn btn-primary&quot; id=&quot;btn-next&quot;&gt;
          Suivant
        &lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;ui-dialog ui-corner-all ui-widget ui-widget-content ui-front no-title-bar dialog-x-none&quot; id=&quot;droits-modal&quot; style=&quot;
        display: none;
        position: fixed;
        top: 5vh;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        width: 600px;
        max-width: 95%;
        max-height: 90vh;
        overflow: auto;
      &quot;&gt;
      &lt;div class=&quot;ui-dialog-titlebar ui-corner-all ui-widget-header ui-helper-clearfix ui-draggable-handle&quot;&gt;&lt;/div&gt;
      &lt;div class=&quot;app-data-container app-dialog ui-dialog-content ui-widget-content&quot; id=&quot;main-dialog&quot;&gt;
        &lt;form id=&quot;droits-form&quot;&gt;
          &lt;h4 id=&quot;modal-benef-name&quot;&gt;&lt;/h4&gt;
          &lt;table class=&quot;display datatable table table-hover dataTable&quot; id=&quot;droits-table&quot;&gt;
            &lt;thead&gt;
              &lt;tr&gt;
                &lt;th&gt;Type de droits&lt;/th&gt;
                &lt;th&gt;Quantit√©&lt;/th&gt;
                &lt;th&gt;Montant&lt;/th&gt;
              &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody&gt;
              &lt;tr&gt;
                &lt;td&gt;PP&lt;/td&gt;
                &lt;td&gt;
                  &lt;input class=&quot;form-control text-right&quot; type=&quot;text&quot; id=&quot;droits-pp-qty&quot; style=&quot;max-width: 90px; width: 90px&quot;&gt;
                &lt;/td&gt;
                &lt;td&gt;
                  &lt;input class=&quot;form-control text-right&quot; type=&quot;text&quot; id=&quot;droits-pp-montant&quot; style=&quot;max-width: 120px; width: 120px&quot;&gt;
                &lt;/td&gt;
              &lt;/tr&gt;
              &lt;tr&gt;
                &lt;td&gt;NP&lt;/td&gt;
                &lt;td&gt;
                  &lt;input class=&quot;form-control text-right&quot; type=&quot;text&quot; id=&quot;droits-np-qty&quot; style=&quot;max-width: 90px; width: 90px&quot;&gt;
                &lt;/td&gt;
                &lt;td&gt;
                  &lt;input class=&quot;form-control text-right&quot; type=&quot;text&quot; id=&quot;droits-np-montant&quot; style=&quot;max-width: 120px; width: 120px&quot;&gt;
                &lt;/td&gt;
              &lt;/tr&gt;
              &lt;tr&gt;
                &lt;td&gt;U&lt;/td&gt;
                &lt;td&gt;
                  &lt;input class=&quot;form-control text-right&quot; type=&quot;text&quot; id=&quot;droits-u-qty&quot; style=&quot;max-width: 90px; width: 90px&quot;&gt;
                &lt;/td&gt;
                &lt;td&gt;
                  &lt;input class=&quot;form-control text-right&quot; type=&quot;text&quot; id=&quot;droits-u-montant&quot; style=&quot;max-width: 120px; width: 120px&quot;&gt;
                &lt;/td&gt;
              &lt;/tr&gt;
              &lt;tr&gt;
                &lt;td&gt;&lt;strong&gt;Total&lt;/strong&gt;&lt;/td&gt;
                &lt;td&gt;&lt;/td&gt;
                &lt;td&gt;
                  &lt;input class=&quot;form-control text-right&quot; type=&quot;text&quot; id=&quot;droits-total-montant&quot; readonly=&quot;&quot; style=&quot;max-width: 120px; width: 120px&quot;&gt;
                &lt;/td&gt;
              &lt;/tr&gt;
            &lt;/tbody&gt;
          &lt;/table&gt;
          &lt;div class=&quot;row mt-4&quot;&gt;
            &lt;div class=&quot;col-5&quot;&gt;
              &lt;button type=&quot;button&quot; class=&quot;btn btn-secondary ve-pending-recalculate&quot; id=&quot;droits-cancel&quot;&gt;
                Annuler
              &lt;/button&gt;
            &lt;/div&gt;
            &lt;div class=&quot;col-7 right&quot;&gt;
              &lt;button type=&quot;submit&quot; class=&quot;btn btn-primary ve-pending-recalculate&quot; id=&quot;droits-validate&quot;&gt;
                Valider
              &lt;/button&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/form&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;script&gt;
      // --- Etat interne des b√©n√©ficiaires de la distribution ---
      let distributionBenefs = [];
      let allBeneficiaires = [];
      let benefIdCounter = 1;
      // --- Etat interne de la forme juridique ---
      let formeJuridique = &quot;SARL&quot;;
      // --- Pr√©noms et noms pour g√©n√©ration al√©atoire ---
      let details = {};
      const prenoms = [
        &quot;Jean&quot;,
        &quot;Marie&quot;,
        &quot;Lucas&quot;,
        &quot;Emma&quot;,
        &quot;Thomas&quot;,
        &quot;Sofia&quot;,
        &quot;Hugo&quot;,
        &quot;L√©a&quot;,
        &quot;Paul&quot;,
        &quot;In√®s&quot;,
      ];
      const noms = [
        &quot;Dupont&quot;,
        &quot;Martin&quot;,
        &quot;Bernard&quot;,
        &quot;Petit&quot;,
        &quot;Moreau&quot;,
        &quot;Garcia&quot;,
        &quot;Silva&quot;,
        &quot;Schmidt&quot;,
        &quot;Rossi&quot;,
        &quot;Dubois&quot;,
      ];

      function saveDistributionBenefs() {
        localStorage.setItem(
          &quot;distributionBeneficiaires&quot;,
          JSON.stringify(distributionBenefs),
        );
      }
      function randomFrom(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
      }
      // --- Fonctions de formatage/fran√ßais ---
      function parseFrNumber(str) {
        if (typeof str !== &quot;string&quot;) return 0;
        str = str.replace(/\s/g, &quot;&quot;).replace(&quot;,&quot;, &quot;.&quot;);
        let n = parseFloat(str);
        return isNaN(n) ? 0 : n;
      }
      function formatFrNumber(value) {
        return Number(value).toLocaleString(&quot;fr-FR&quot;, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      }
      // --- Sauvegarde et chargement de la forme juridique ---
      function saveFormeJuridique() {
        localStorage.setItem(&quot;distributionLegalForm&quot;, formeJuridique);
      }
      function loadFormeJuridique() {
        const val = localStorage.getItem(&quot;distributionLegalForm&quot;);
        if (val === &quot;SAS&quot; || val === &quot;SARL&quot;) {
          formeJuridique = val;
          document.getElementById(&quot;distribution-legal-form&quot;).value =
            formeJuridique;
        }
      }
      // --- Sauvegarde et chargement des b√©n√©ficiaires disponibles (pour la liste d√©roulante) ---
      function saveAllBeneficiaires() {
        localStorage.setItem(
          &quot;distributionAllBeneficiaires&quot;,
          JSON.stringify(allBeneficiaires),
        );
      }
      function loadAllBeneficiaires() {
        const raw = localStorage.getItem(&quot;distributionAllBeneficiaires&quot;);
        if (raw) {
          try {
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) {
              allBeneficiaires = parsed;
              benefIdCounter = Math.max(
                1,
                ...allBeneficiaires.map((b) =&gt; b.id + 1),
              );
              return;
            }
          } catch (e) {}
        }
        // Si rien, on cr√©e 5 b√©n√©ficiaires initiaux
        allBeneficiaires = [];
        for (let i = 0; i &lt; 5; i++) {
          const newId = benefIdCounter++;
          const pays = i % 2 === 0 ? &quot;France&quot; : &quot;Etranger&quot;;
          const prenom = randomFrom(prenoms);
          const nom = randomFrom(noms);
          const fullName = prenom + &quot; &quot; + nom;
          allBeneficiaires.push({ id: newId, name: fullName, pays: pays });
        }
        saveAllBeneficiaires();
      }
      // --- Sauvegarde et chargement des b√©n√©ficiaires de la distribution (tableau principal) ---

      function applyViewModeIfNeeded() {
        const isView = localStorage.getItem(&quot;distributionMode&quot;) === &quot;view&quot;;

        [
          &quot;distribution-date&quot;,
          &quot;distribution-type&quot;,
          &quot;distribution-legal-form&quot;,
          &quot;distribution-source&quot;,
          &quot;distribution-amount&quot;,
        ].forEach((id) =&gt; {
          const el = document.getElementById(id);
          if (el) el.disabled = isView;
        });

        [&quot;btn-repartir&quot;, &quot;btn-add-benef&quot;].forEach((id) =&gt; {
          const el = document.getElementById(id);
          if (el) el.disabled = isView;
        });

        // Montants et actions dans le tableau des b√©n√©ficiaires
        document.querySelectorAll(&quot;.montant-cell&quot;).forEach(function(el) { el.disabled = isView; });
        document.querySelectorAll(&quot;.btn-remove-benef&quot;).forEach(function(el) { el.disabled = isView; });
        document.querySelectorAll(&quot;.droits-cell&quot;).forEach(function(el) {
          el.style.pointerEvents = isView ? &quot;none&quot; : &quot;&quot;;
          el.style.color = isView ? &quot;inherit&quot; : &quot;&quot;;
          el.style.textDecoration = isView ? &quot;none&quot; : &quot;&quot;;
        });

        const next = document.getElementById(&quot;btn-next&quot;);
        if (next) next.textContent = &quot;Suivant&quot;;
      }

      // --- Rafra√Æchissement de la liste d√©roulante des b√©n√©ficiaires √† ajouter ---
      function refreshBenefSelect() {
        const select = document.getElementById(&quot;benef-select&quot;);
        select.innerHTML = &quot;&quot;;
        // On ne propose que les b√©n√©ficiaires qui ne sont pas d√©j√† dans la distribution
        const idsInTable = new Set(distributionBenefs.map((b) =&gt; b.id));
        let hasOption = false;
        allBeneficiaires.forEach((benef) =&gt; {
          if (!idsInTable.has(benef.id)) {
            const opt = document.createElement(&quot;option&quot;);
            opt.value = benef.id;
            opt.textContent =
              benef.name + (benef.pays ? &quot; (&quot; + benef.pays + &quot;)&quot; : &quot;&quot;);
            select.appendChild(opt);
            hasOption = true;
          }
        });
        if (!hasOption) {
          const opt = document.createElement(&quot;option&quot;);
          opt.value = &quot;&quot;;
          opt.textContent = &quot;Aucun b√©n√©ficiaire disponible&quot;;
          select.appendChild(opt);
        }
      }
      // --- Ajout d'un b√©n√©ficiaire √† la liste globale ou s√©lectionn√© (CORRIG√â) ---
      document
        .getElementById(&quot;btn-add-benef&quot;)
        .addEventListener(&quot;click&quot;, function () {
          const select = document.getElementById(&quot;benef-select&quot;);
          let benefId = select.value;
          const idsInTable = new Set(distributionBenefs.map((b) =&gt; b.id));
          // Cas 1 : aucun b√©n√©ficiaire s√©lectionn√© OU &quot;Aucun b√©n√©ficiaire disponible&quot;
          if (
            !benefId ||
            benefId === &quot;&quot; ||
            benefId === &quot;Aucun b√©n√©ficiaire disponible&quot;
          ) {
            // Ajout d'un nouveau b√©n√©ficiaire al√©atoire √† la liste globale
            const newId = benefIdCounter++;
            const prenom = randomFrom(prenoms);
            const nom = randomFrom(noms);
            const pays =
              allBeneficiaires.length % 2 === 0 ? &quot;France&quot; : &quot;Etranger&quot;;
            const fullName = prenom + &quot; &quot; + nom;
            const newBenef = { id: newId, name: fullName, pays: pays };
            allBeneficiaires.push(newBenef);
            saveAllBeneficiaires();
            // Ajout imm√©diat √† la distribution
            distributionBenefs.push({
              id: newId,
              name: fullName,
              pays: pays,
              droits: {
                PP: { qty: 0, montant: 0 },
                NP: { qty: 0, montant: 0 },
                U: { qty: 0, montant: 0 },
              },
              montant: 0,
              montantManuel: false,
            });
            saveDistributionBenefs();
            refreshBenefTable();
            refreshBenefSelect();
          } else {
            // Ajout du b√©n√©ficiaire s√©lectionn√© √† la distribution S'IL N'Y EST PAS D√âJ√Ä
            benefId = parseInt(benefId, 10);
            if (idsInTable.has(benefId)) {
              alert(&quot;Ce b√©n√©ficiaire est d√©j√† dans la distribution.&quot;);
              return;
            }
            const benef = allBeneficiaires.find((b) =&gt; b.id == benefId);
            if (benef) {
              distributionBenefs.push({
                id: benef.id,
                name: benef.name,
                pays: benef.pays,
                droits: {
                  PP: { qty: 0, montant: 0 },
                  NP: { qty: 0, montant: 0 },
                  U: { qty: 0, montant: 0 },
                },
                montant: 0,
                montantManuel: false,
              });
              saveDistributionBenefs();
              refreshBenefTable();
              refreshBenefSelect();
            }
          }
        });
      // --- Rafra√Æchissement du tableau des b√©n√©ficiaires ---
      function refreshBenefTable() {
        const tbody = document.getElementById(&quot;benef-table-body&quot;);
        tbody.innerHTML = &quot;&quot;;
        let totalMontant = 0;
        let totalTotal = 0;
        let sumPP = 0,
          sumNP = 0,
          sumU = 0;
        distributionBenefs.forEach((b, idx) =&gt; {
          // Calcul du total des droits
          const droits = b.droits;
          const droitsStr = [
            `PP - ${formatFrNumber(droits.PP.qty)} - ${formatFrNumber(droits.PP.montant)}`,
            `NP - ${formatFrNumber(droits.NP.qty)} - ${formatFrNumber(droits.NP.montant)}`,
            `U - ${formatFrNumber(droits.U.qty)} - ${formatFrNumber(droits.U.montant)}`,
          ].join(&quot;&lt;br&gt;&quot;);
          // Calcul du total du modal
          const totalModal =
            droits.PP.montant + droits.NP.montant + droits.U.montant;
          // Sommes pour la ligne total
          sumPP += droits.PP.qty;
          sumNP += droits.NP.qty;
          sumU += droits.U.qty;
          // Montant affich√©
          const montantAffiche = formatFrNumber(b.montant);
          totalMontant += b.montant;
          // Total (pour chaque b√©n√©ficiaire, ici = montant)
          totalTotal += b.montant;
          // Warning si √©cart
          const warning = Math.abs(b.montant - totalModal) &gt; 0.009;
          const warningIcon = warning
            ? '&lt;span title=&quot;Le montant ne correspond pas au total d√©fini par type de droits&quot; style=&quot;color:orange;font-weight:bold;font-size:1.2em;vertical-align:middle;&quot;&gt;&amp;#9888;&lt;/span&gt;'
            : &quot;&quot;;
          // Ligne
          const tr = document.createElement(&quot;tr&quot;);
          tr.innerHTML = `&lt;td&gt;${b.name}&lt;br&gt;&lt;small style=&quot;color:gray;&quot;&gt;${b.pays}&lt;/small&gt;&lt;/td&gt;&lt;td&gt;&lt;a href=&quot;#&quot; class=&quot;droits-cell&quot; data-idx=&quot;${idx}&quot;&gt;${droitsStr}&lt;/a&gt;&lt;/td&gt;&lt;td class=&quot;text-right&quot;&gt;&lt;div style=&quot;display:flex;align-items:center;&quot;&gt;&lt;input class=&quot;form-control text-right montant-cell&quot; type=&quot;text&quot; data-idx=&quot;${idx}&quot; value=&quot;${montantAffiche}&quot; style=&quot;max-width: 120px; width: 120px;&quot;&gt;${warningIcon}&lt;/div&gt;&lt;/td&gt;&lt;td class=&quot;text-right&quot;&gt;${montantAffiche}&lt;/td&gt;&lt;td&gt;&lt;button type=&quot;button&quot; class=&quot;btn btn-secondary btn-sm btn-remove-benef&quot; data-idx=&quot;${idx}&quot; title=&quot;Supprimer&quot; data-custom-bg=&quot;1&quot;&gt;Supprimer&lt;/button&gt;&lt;/td&gt;`;
          tbody.appendChild(tr);
        });
        // Mise √† jour ligne total
        document.getElementById(&quot;total-montant-cell&quot;).innerHTML =
          `&lt;strong&gt;${formatFrNumber(totalMontant)}&lt;/strong&gt;`;
        document.getElementById(&quot;total-total-cell&quot;).innerHTML =
          `&lt;strong&gt;${formatFrNumber(totalTotal)}&lt;/strong&gt;`;
        const incoherent = Math.abs(sumNP - sumU) &gt; 0.009;
        document.getElementById(&quot;total-droits-cell&quot;).innerHTML =
          `&lt;div&gt;&lt;span&gt;PP - ${formatFrNumber(sumPP)}&lt;/span&gt;&lt;br&gt;&lt;span&gt;NP - ${formatFrNumber(sumNP)}&lt;/span&gt;&lt;br&gt;&lt;span&gt;U - ${formatFrNumber(sumU)}&lt;/span&gt;${incoherent ? '&lt;br&gt;&lt;span style=&quot;color:orange;font-weight:bold;&quot; title=&quot;Total NP diff√©rent du total U&quot;&gt;&amp;#9888; D√©membrement incoh√©rent&lt;/span&gt;' : &quot;&quot;}&lt;/div&gt;`;
        // Listeners droits
        Array.from(document.getElementsByClassName(&quot;droits-cell&quot;)).forEach(
          (a) =&gt; {
            a.addEventListener(&quot;click&quot;, function (e) {
              e.preventDefault();
              openDroitsModal(parseInt(this.dataset.idx, 10));
            });
          },
        );
        // Listeners suppression
        Array.from(document.getElementsByClassName(&quot;btn-remove-benef&quot;)).forEach(
          (btn) =&gt; {
            btn.addEventListener(&quot;click&quot;, function () {
              const idx = parseInt(this.dataset.idx, 10);
              removeBenef(idx);
            });
            btn.style.backgroundColor = &quot;#ff5082&quot;;
            btn.style.borderColor = &quot;#ff5082&quot;;
            btn.style.color = &quot;#fff&quot;;
          },
        );
        // Listeners montant
        Array.from(document.getElementsByClassName(&quot;montant-cell&quot;)).forEach(
          (input) =&gt; {
            input.addEventListener(&quot;blur&quot;, function () {
              const idx = parseInt(this.dataset.idx, 10);
              let val = parseFrNumber(this.value);
              if (isNaN(val)) val = 0;
              this.value = formatFrNumber(val);
              distributionBenefs[idx].montant = val;
              distributionBenefs[idx].montantManuel = true;
              saveDistributionBenefs();
              refreshBenefTable();
            });
            input.style.maxWidth = &quot;120px&quot;;
            input.style.width = &quot;120px&quot;;
          },
        );
        refreshBenefSelect();
      }
      // --- Suppression d'un b√©n√©ficiaire ---
      function removeBenef(idx) {
        // On retire le b√©n√©ficiaire du tableau principal
        const removed = distributionBenefs.splice(idx, 1)[0];
        saveDistributionBenefs();
        refreshBenefTable();
        refreshBenefSelect();
      }
      // --- Modal droits : ouverture et remplissage ---
      let currentModalBenefId = null;
      function openDroitsModal(idx) {
        currentModalBenefId = idx;
        const benef = distributionBenefs[idx];
        document.getElementById(&quot;modal-benef-name&quot;).textContent = benef.name;
        document.getElementById(&quot;droits-pp-qty&quot;).value = formatFrNumber(
          benef.droits.PP.qty,
        );
        document.getElementById(&quot;droits-pp-montant&quot;).value = formatFrNumber(
          benef.droits.PP.montant,
        );
        document.getElementById(&quot;droits-np-qty&quot;).value = formatFrNumber(
          benef.droits.NP.qty,
        );
        document.getElementById(&quot;droits-np-montant&quot;).value = formatFrNumber(
          benef.droits.NP.montant,
        );
        document.getElementById(&quot;droits-u-qty&quot;).value = formatFrNumber(
          benef.droits.U.qty,
        );
        document.getElementById(&quot;droits-u-montant&quot;).value = formatFrNumber(
          benef.droits.U.montant,
        );
        updateDroitsTotal();
        document.getElementById(&quot;droits-modal&quot;).style.display = &quot;&quot;;
      }
      function closeDroitsModal() {
        document.getElementById(&quot;droits-modal&quot;).style.display = &quot;none&quot;;
        currentModalBenefId = null;
      }
      // --- Modal droits : listeners blur pour formatage et calcul total ---
      [
        &quot;droits-pp-qty&quot;,
        &quot;droits-pp-montant&quot;,
        &quot;droits-np-qty&quot;,
        &quot;droits-np-montant&quot;,
        &quot;droits-u-qty&quot;,
        &quot;droits-u-montant&quot;,
      ].forEach((id) =&gt; {
        document.getElementById(id).addEventListener(&quot;blur&quot;, function () {
          let val = parseFrNumber(this.value);
          if (isNaN(val)) val = 0;
          this.value = formatFrNumber(val);
          updateDroitsTotal();
        });
        // R√©duction taille
        if (id.endsWith(&quot;qty&quot;)) {
          document.getElementById(id).style.maxWidth = &quot;90px&quot;;
          document.getElementById(id).style.width = &quot;90px&quot;;
        } else {
          document.getElementById(id).style.maxWidth = &quot;120px&quot;;
          document.getElementById(id).style.width = &quot;120px&quot;;
        }
      });
      // --- Calcul du total dans le modal droits ---
      function updateDroitsTotal() {
        const pp =
          parseFrNumber(document.getElementById(&quot;droits-pp-montant&quot;).value) ||
          0;
        const np =
          parseFrNumber(document.getElementById(&quot;droits-np-montant&quot;).value) ||
          0;
        const u =
          parseFrNumber(document.getElementById(&quot;droits-u-montant&quot;).value) || 0;
        document.getElementById(&quot;droits-total-montant&quot;).value = formatFrNumber(
          pp + np + u,
        );
      }
      // --- Validation du modal droits ---
      document
        .getElementById(&quot;droits-form&quot;)
        .addEventListener(&quot;submit&quot;, function (e) {
          e.preventDefault();
          if (currentModalBenefId === null) return;
          const idx = currentModalBenefId;
          const benef = distributionBenefs[idx];
          benef.droits.PP.qty =
            parseFrNumber(document.getElementById(&quot;droits-pp-qty&quot;).value) || 0;
          benef.droits.PP.montant =
            parseFrNumber(document.getElementById(&quot;droits-pp-montant&quot;).value) ||
            0;
          benef.droits.NP.qty =
            parseFrNumber(document.getElementById(&quot;droits-np-qty&quot;).value) || 0;
          benef.droits.NP.montant =
            parseFrNumber(document.getElementById(&quot;droits-np-montant&quot;).value) ||
            0;
          benef.droits.U.qty =
            parseFrNumber(document.getElementById(&quot;droits-u-qty&quot;).value) || 0;
          benef.droits.U.montant =
            parseFrNumber(document.getElementById(&quot;droits-u-montant&quot;).value) ||
            0;
          // Calcul du total
          const total =
            benef.droits.PP.montant +
            benef.droits.NP.montant +
            benef.droits.U.montant;
          // Si le montant n'a pas √©t√© modifi√© manuellement, on synchronise
          if (!benef.montantManuel) {
            benef.montant = total;
          }
          saveDistributionBenefs();
          closeDroitsModal();
          refreshBenefTable();
        });
      document
        .getElementById(&quot;droits-cancel&quot;)
        .addEventListener(&quot;click&quot;, function () {
          closeDroitsModal();
        });
      // --- R√©partition automatique du montant principal ---
      document
        .getElementById(&quot;btn-repartir&quot;)
        .addEventListener(&quot;click&quot;, function () {
          const montantTotal =
            parseFrNumber(
              document.getElementById(&quot;distribution-amount&quot;).value,
            ) || 0;
          // Calcul du total des droits PP+U
          let totalPPU = 0;
          distributionBenefs.forEach((b) =&gt; {
            totalPPU += (b.droits.PP.qty || 0) + (b.droits.U.qty || 0);
          });
          if (totalPPU === 0) return;
          // R√©partition au prorata des droits PP+U, NP = 0
          let reste = montantTotal;
          distributionBenefs.forEach((b, idx) =&gt; {
            const droitsPPU = (b.droits.PP.qty || 0) + (b.droits.U.qty || 0);
            let part =
              Math.round(((montantTotal * droitsPPU) / totalPPU) * 100) / 100;
            if (idx === distributionBenefs.length - 1) part = reste;
            reste -= part;
            // R√©partition dans le modal
            let montantPP = 0,
              montantU = 0;
            if (droitsPPU &gt; 0) {
              montantPP =
                Math.round(
                  ((part * (b.droits.PP.qty || 0)) / droitsPPU) * 100,
                ) / 100;
              montantU = part - montantPP;
            }
            b.droits.PP.montant = montantPP;
            b.droits.NP.montant = 0;
            b.droits.U.montant = montantU;
            // Synchronisation du montant 
            
              b.montant = montantPP + montantU;
            
          });
          saveDistributionBenefs();
          refreshBenefTable();
        });
      // --- Formatage initial du champ montant principal ---
      document
        .getElementById(&quot;distribution-amount&quot;)
        .addEventListener(&quot;blur&quot;, function () {
          let val = parseFrNumber(this.value);
          if (isNaN(val)) val = 0;
          this.value = formatFrNumber(val);
        });
      // --- Listener sur la forme juridique ---
      document
        .getElementById(&quot;distribution-legal-form&quot;)
        .addEventListener(&quot;change&quot;, function () {
          formeJuridique = this.value;
          saveFormeJuridique();
          updateCategorieTitre();
        });
      // --- Mise √† jour du titre de cat√©gorie de titres selon la forme juridique ---
      function updateCategorieTitre() {
        let titre =
          formeJuridique === &quot;SAS&quot; ? &quot;Actions ordinaires&quot; : &quot;Parts sociales&quot;;
        // Mise √† jour du th dans le thead
        var th = document.getElementById(&quot;th-categorie-titre&quot;);
        if (th) th.textContent = titre;
      }
      // --- Sauvegarde automatique des champs du formulaire de distribution ---
      function saveDistributionDetails() {
        const details = {
          date: document.getElementById(&quot;distribution-date&quot;).value || &quot;&quot;,
          type: document.getElementById(&quot;distribution-type&quot;).value || &quot;&quot;,
          source: document.getElementById(&quot;distribution-source&quot;).value || &quot;&quot;,
          montant: document.getElementById(&quot;distribution-amount&quot;).value || &quot;&quot;,
        };
        localStorage.setItem(&quot;distributionDetails&quot;, JSON.stringify(details));
      }
      function loadDistributionDetails() {
        const raw = localStorage.getItem(&quot;distributionDetails&quot;);
        if (raw) {
          try {
            const details = JSON.parse(raw);
            if (details &amp;&amp; typeof details === &quot;object&quot;) {
              if (details.date)
                document.getElementById(&quot;distribution-date&quot;).value =
                  details.date;
              if (details.type)
                document.getElementById(&quot;distribution-type&quot;).value =
                  details.type;
              if (details.source)
                document.getElementById(&quot;distribution-source&quot;).value =
                  details.source;
              if (details.montant)
                document.getElementById(&quot;distribution-amount&quot;).value =
                  details.montant;
            }
          } catch (e) {}
        }
      }

      function applyIntentFromList() {
        let intent = null;
        try {
          intent = JSON.parse(
            localStorage.getItem(&quot;distModalIntent&quot;) || &quot;null&quot;,
          );
        } catch {}

        if (!intent || !intent.action) return;

        // Mode ajout : on part sur un √©cran vide (ou les valeurs actuelles)
        if (intent.action === &quot;add&quot;) {
          localStorage.removeItem(&quot;distributionEditingId&quot;);
          localStorage.setItem(&quot;distributionMode&quot;, &quot;add&quot;);
          return;
        }

        // Mode edit / view : on charge la distribution depuis distributionsData
        if (
          (intent.action === &quot;edit&quot; || intent.action === &quot;view&quot;) &amp;&amp;
          intent.id != null
        ) {
          let list = [];
          try {
            list = JSON.parse(
              localStorage.getItem(&quot;distributionsData&quot;) || &quot;[]&quot;,
            );
          } catch {}

          const dist = list.find((d) =&gt; Number(d.id) === Number(intent.id));
          if (!dist) return;

          // Hydrate les stores utilis√©s par l'√©cran 2/3
          localStorage.setItem(
            &quot;distributionDetails&quot;,
            JSON.stringify(dist.details || {}),
          );
          localStorage.setItem(
            &quot;distributionLegalForm&quot;,
            dist.legalForm || &quot;SARL&quot;,
          );
          localStorage.setItem(
            &quot;distributionBeneficiaires&quot;,
            JSON.stringify(dist.beneficiaires || []),
          );

          localStorage.setItem(&quot;distributionEditingId&quot;, String(dist.id));
          localStorage.setItem(&quot;distributionMode&quot;, intent.action); // &quot;edit&quot; ou &quot;view&quot;
        }
      }

      function getLegalForm() {
        return localStorage.getItem(&quot;distributionLegalForm&quot;) || &quot;SARL&quot;;
      }

      function getDistributionDetails() {
        try {
          return JSON.parse(
            localStorage.getItem(&quot;distributionDetails&quot;) || &quot;{}&quot;,
          );
        } catch (e) {
          return {};
        }
      }

      // --- Initialisation ---

      function init() {
        // üîπ Lire l‚Äôintent
        let intent = null;
        try {
          intent = JSON.parse(
            localStorage.getItem(&quot;distModalIntent&quot;) || &quot;null&quot;,
          );
        } catch {}

        const editingId = localStorage.getItem(&quot;distributionEditingId&quot;);

        // üîπ Cas √©dition / visualisation
        if (editingId) {
          const list = JSON.parse(
            localStorage.getItem(&quot;distributionsData&quot;) || &quot;[]&quot;,
          );
          const dist = list.find((d) =&gt; d.id == editingId);

          if (dist) {
            details = dist.details || {};
            formeJuridique = dist.legalForm || &quot;SARL&quot;;
            distributionBenefs = (dist.beneficiaires || []).map((b) =&gt; {
              return {
                id: b.id,
                name: b.name,
                pays: b.pays,
                droits: {
                  PP: { qty: b.pp || 0, montant: b.ppMontant || 0 },
                  NP: { qty: b.np || 0, montant: b.npMontant || 0 },
                  U: { qty: b.u || 0, montant: b.uMontant || 0 },
                },
                montant: b.montant || 0,
                montantManuel: true,
              };
            });
          }
        } else {
          // üîπ Cas nouvelle distribution
          details = {
            date: &quot;&quot;,
            type: &quot;dividendes&quot;,
            source: &quot;&quot;,
            montant: &quot;0,00&quot;,
          };
          distributionBenefs = [];
        }

        // üîπ Remplir formulaire
        document.getElementById(&quot;distribution-date&quot;).value = details.date || &quot;&quot;;
        document.getElementById(&quot;distribution-type&quot;).value =
          details.type || &quot;dividendes&quot;;
        document.getElementById(&quot;distribution-source&quot;).value =
          details.source || &quot;&quot;;
        document.getElementById(&quot;distribution-amount&quot;).value =
          details.montant || &quot;0,00&quot;;
        document.getElementById(&quot;distribution-legal-form&quot;).value =
          formeJuridique;

        // üîπ Rendu
        refreshBenefTable();
        refreshBenefSelect();

        // üîπ Appliquer le mode (lecture seule ou √©dition) ‚Äî toujours
        applyViewModeIfNeeded();
      }

      init();

      // R√©-initialisation quand on navigue vers cet √©cran
      window.addEventListener(&quot;message&quot;, function (e) {
        const data = e.data || {};
        if (data.type === &quot;po:activate&quot; &amp;&amp; data.index === 2) {
          applyIntentFromList();
          init();
        }
      });

      // --- Bouton Suivant ---
      document
        .getElementById(&quot;btn-next&quot;)
        .addEventListener(&quot;click&quot;, function () {
          saveDistributionDetails();
          // Merge : pr√©server les champs de l'√©cran 3 (taux, qp, cc, pea, dispense)
          var existingBenefs = [];
          try { existingBenefs = JSON.parse(localStorage.getItem(&quot;distributionBeneficiaires&quot;) || &quot;[]&quot;); } catch(e) {}
          var existingById = {};
          existingBenefs.forEach(function(b) { existingById[String(b.id)] = b; });
          var benefs = distributionBenefs.map(function(b) {
            var existing = existingById[String(b.id)] || {};
            return Object.assign({}, existing, {
              id: b.id,
              name: b.name,
              pays: b.pays,
              montant: b.montant,
              pp: b.droits.PP.qty,
              np: b.droits.NP.qty,
              u: b.droits.U.qty,
              ppMontant: b.droits.PP.montant,
              npMontant: b.droits.NP.montant,
              uMontant: b.droits.U.montant,
            });
          });
          localStorage.setItem(&quot;distributionBeneficiaires&quot;, JSON.stringify(benefs));
          window.parent.postMessage(
            { type: &quot;po:navigate&quot;, action: &quot;goto&quot;, index: 3 },
            &quot;*&quot;,
          );
        });
    &lt;/script&gt;


&lt;/body&gt;&lt;/html&gt;"></iframe><textarea class="html-source" style="display: none; min-height: 260px; font-family: monospace; white-space: pre; width: 100%;">&lt;!doctype html&gt;
&lt;html lang="fr"&gt;&lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;meta name="viewport" content="width=device-width,initial-scale=1"&gt;
    &lt;title&gt;Distribution - D√©tail&lt;/title&gt;
    &lt;link rel="stylesheet" href="vikta-task.css"&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h2&gt;D√©tail d'une distribution&lt;/h2&gt;
    &lt;form id="distribution-form" autocomplete="off"&gt;
      &lt;div class="form-group"&gt;
        &lt;label class="control-label" for="distribution-date"&gt;Date&lt;/label&gt;
        &lt;div&gt;
          &lt;input class="form-control" id="distribution-date" name="distribution-date" type="date" required="" style="max-width: 140px; width: 140px"&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div class="form-group"&gt;
        &lt;label class="control-label" for="distribution-type"&gt;Type&lt;/label&gt;
        &lt;div&gt;
          &lt;select class="viktaselect custom-select" id="distribution-type" name="distribution-type"&gt;
            &lt;option value="dividendes" selected=""&gt;Dividendes&lt;/option&gt;
            &lt;option value="interets"&gt;Int√©r√™ts&lt;/option&gt;
          &lt;/select&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div class="form-group"&gt;
        &lt;label class="control-label" for="distribution-legal-form"&gt;Forme Juridique&lt;/label&gt;
        &lt;div&gt;
          &lt;select class="viktaselect custom-select" id="distribution-legal-form" name="distribution-legal-form"&gt;
            &lt;option value="SARL" selected=""&gt;SARL&lt;/option&gt;
            &lt;option value="SAS"&gt;SAS&lt;/option&gt;
          &lt;/select&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div class="form-group"&gt;
        &lt;label class="control-label" for="distribution-source"&gt;Source&lt;/label&gt;
        &lt;div&gt;
          &lt;input class="form-control" id="distribution-source" name="distribution-source" type="text" placeholder="p.ex distribution de r√©serves du 20 d√©cembre..."&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div class="form-group"&gt;
        &lt;label class="control-label" for="distribution-amount"&gt;Montant&lt;/label&gt;
        &lt;div class="controls-input-with-buttons"&gt;
          &lt;input class="form-control text-right" id="distribution-amount" name="distribution-amount" type="text" value="0,00" style="max-width: 120px; width: 120px"&gt;
        &lt;/div&gt;
        &lt;div class="controls-buttons"&gt;
          &lt;button type="button" class="btn btn-primary" id="btn-repartir"&gt;
            R√©partir
          &lt;/button&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/form&gt;
    &lt;h3&gt;B√©n√©ficiaires de la distribution&lt;/h3&gt;
    &lt;table class="display datatable table table-hover dataTable" id="main-datatable"&gt;
      &lt;thead&gt;
        &lt;tr class="ve-table-header"&gt;
          &lt;th colspan="5"&gt;
            &lt;div class="row ve-datatable-heading" id="main-datatable-heading"&gt;
              &lt;div class="d-flex flex-fill"&gt;
                &lt;div class="ve-datatable-searchbox"&gt;&lt;/div&gt;
                &lt;div class="ve-datatable-filters"&gt;&lt;/div&gt;
                &lt;div&gt;&lt;/div&gt;
              &lt;/div&gt;
            &lt;/div&gt;
          &lt;/th&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;th&gt;&lt;/th&gt;
          &lt;th colspan="2" id="th-categorie-titre"&gt;Parts sociales&lt;/th&gt;
          &lt;th&gt;&lt;/th&gt;
          &lt;th&gt;&lt;/th&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;th&gt;B√©n√©ficiaire&lt;/th&gt;
          &lt;th&gt;Droits&lt;br&gt;&lt;small&gt;(PP/NP/U)&lt;/small&gt;&lt;/th&gt;
          &lt;th&gt;Montant&lt;/th&gt;
          &lt;th&gt;Total&lt;/th&gt;
          &lt;th&gt;&lt;/th&gt;
        &lt;/tr&gt;
      &lt;/thead&gt;
      &lt;tbody id="benef-table-body"&gt;&lt;/tbody&gt;
      &lt;tfoot&gt;
        &lt;tr&gt;
          &lt;td&gt;
            &lt;div class="row"&gt;
              &lt;div class="col-12"&gt;
                &lt;select class="viktaselect custom-select" id="benef-select" style="max-width: 180px"&gt;&lt;/select&gt;
                &lt;button type="button" class="btn btn-primary" id="btn-add-benef"&gt;
                  +
                &lt;/button&gt;
              &lt;/div&gt;
            &lt;/div&gt;
          &lt;/td&gt;
          &lt;td colspan="4"&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;td&gt;&lt;strong&gt;Total&lt;/strong&gt;&lt;/td&gt;
          &lt;td id="total-droits-cell"&gt;
            &lt;div&gt;
              &lt;span id="total-droits-pp"&gt;PP - 0&lt;/span&gt;&lt;br&gt;
              &lt;span id="total-droits-np"&gt;NP - 0&lt;/span&gt;&lt;br&gt;
              &lt;span id="total-droits-u"&gt;U - 0&lt;/span&gt;
            &lt;/div&gt;
          &lt;/td&gt;
          &lt;td id="total-montant-cell" class="text-right"&gt;
            &lt;strong&gt;0,00&lt;/strong&gt;
          &lt;/td&gt;
          &lt;td id="total-total-cell" class="text-right"&gt;
            &lt;strong&gt;0,00&lt;/strong&gt;
          &lt;/td&gt;
          &lt;td&gt;&lt;/td&gt;
        &lt;/tr&gt;
      &lt;/tfoot&gt;
    &lt;/table&gt;
    &lt;div class="row mt-4"&gt;
      &lt;div class="col-12 right"&gt;
        &lt;button type="button" class="btn btn-primary" id="btn-next"&gt;
          Suivant
        &lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="ui-dialog ui-corner-all ui-widget ui-widget-content ui-front no-title-bar dialog-x-none" id="droits-modal" style="
        display: none;
        position: fixed;
        top: 5vh;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        width: 600px;
        max-width: 95%;
        max-height: 90vh;
        overflow: auto;
      "&gt;
      &lt;div class="ui-dialog-titlebar ui-corner-all ui-widget-header ui-helper-clearfix ui-draggable-handle"&gt;&lt;/div&gt;
      &lt;div class="app-data-container app-dialog ui-dialog-content ui-widget-content" id="main-dialog"&gt;
        &lt;form id="droits-form"&gt;
          &lt;h4 id="modal-benef-name"&gt;&lt;/h4&gt;
          &lt;table class="display datatable table table-hover dataTable" id="droits-table"&gt;
            &lt;thead&gt;
              &lt;tr&gt;
                &lt;th&gt;Type de droits&lt;/th&gt;
                &lt;th&gt;Quantit√©&lt;/th&gt;
                &lt;th&gt;Montant&lt;/th&gt;
              &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody&gt;
              &lt;tr&gt;
                &lt;td&gt;PP&lt;/td&gt;
                &lt;td&gt;
                  &lt;input class="form-control text-right" type="text" id="droits-pp-qty" style="max-width: 90px; width: 90px"&gt;
                &lt;/td&gt;
                &lt;td&gt;
                  &lt;input class="form-control text-right" type="text" id="droits-pp-montant" style="max-width: 120px; width: 120px"&gt;
                &lt;/td&gt;
              &lt;/tr&gt;
              &lt;tr&gt;
                &lt;td&gt;NP&lt;/td&gt;
                &lt;td&gt;
                  &lt;input class="form-control text-right" type="text" id="droits-np-qty" style="max-width: 90px; width: 90px"&gt;
                &lt;/td&gt;
                &lt;td&gt;
                  &lt;input class="form-control text-right" type="text" id="droits-np-montant" style="max-width: 120px; width: 120px"&gt;
                &lt;/td&gt;
              &lt;/tr&gt;
              &lt;tr&gt;
                &lt;td&gt;U&lt;/td&gt;
                &lt;td&gt;
                  &lt;input class="form-control text-right" type="text" id="droits-u-qty" style="max-width: 90px; width: 90px"&gt;
                &lt;/td&gt;
                &lt;td&gt;
                  &lt;input class="form-control text-right" type="text" id="droits-u-montant" style="max-width: 120px; width: 120px"&gt;
                &lt;/td&gt;
              &lt;/tr&gt;
              &lt;tr&gt;
                &lt;td&gt;&lt;strong&gt;Total&lt;/strong&gt;&lt;/td&gt;
                &lt;td&gt;&lt;/td&gt;
                &lt;td&gt;
                  &lt;input class="form-control text-right" type="text" id="droits-total-montant" readonly="" style="max-width: 120px; width: 120px"&gt;
                &lt;/td&gt;
              &lt;/tr&gt;
            &lt;/tbody&gt;
          &lt;/table&gt;
          &lt;div class="row mt-4"&gt;
            &lt;div class="col-5"&gt;
              &lt;button type="button" class="btn btn-secondary ve-pending-recalculate" id="droits-cancel"&gt;
                Annuler
              &lt;/button&gt;
            &lt;/div&gt;
            &lt;div class="col-7 right"&gt;
              &lt;button type="submit" class="btn btn-primary ve-pending-recalculate" id="droits-validate"&gt;
                Valider
              &lt;/button&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/form&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;script&gt;
      // --- Etat interne des b√©n√©ficiaires de la distribution ---
      let distributionBenefs = [];
      let allBeneficiaires = [];
      let benefIdCounter = 1;
      // --- Etat interne de la forme juridique ---
      let formeJuridique = "SARL";
      // --- Pr√©noms et noms pour g√©n√©ration al√©atoire ---
      let details = {};
      const prenoms = [
        "Jean",
        "Marie",
        "Lucas",
        "Emma",
        "Thomas",
        "Sofia",
        "Hugo",
        "L√©a",
        "Paul",
        "In√®s",
      ];
      const noms = [
        "Dupont",
        "Martin",
        "Bernard",
        "Petit",
        "Moreau",
        "Garcia",
        "Silva",
        "Schmidt",
        "Rossi",
        "Dubois",
      ];

      function saveDistributionBenefs() {
        localStorage.setItem(
          "distributionBeneficiaires",
          JSON.stringify(distributionBenefs),
        );
      }
      function randomFrom(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
      }
      // --- Fonctions de formatage/fran√ßais ---
      function parseFrNumber(str) {
        if (typeof str !== "string") return 0;
        str = str.replace(/\s/g, "").replace(",", ".");
        let n = parseFloat(str);
        return isNaN(n) ? 0 : n;
      }
      function formatFrNumber(value) {
        return Number(value).toLocaleString("fr-FR", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      }
      // --- Sauvegarde et chargement de la forme juridique ---
      function saveFormeJuridique() {
        localStorage.setItem("distributionLegalForm", formeJuridique);
      }
      function loadFormeJuridique() {
        const val = localStorage.getItem("distributionLegalForm");
        if (val === "SAS" || val === "SARL") {
          formeJuridique = val;
          document.getElementById("distribution-legal-form").value =
            formeJuridique;
        }
      }
      // --- Sauvegarde et chargement des b√©n√©ficiaires disponibles (pour la liste d√©roulante) ---
      function saveAllBeneficiaires() {
        localStorage.setItem(
          "distributionAllBeneficiaires",
          JSON.stringify(allBeneficiaires),
        );
      }
      function loadAllBeneficiaires() {
        const raw = localStorage.getItem("distributionAllBeneficiaires");
        if (raw) {
          try {
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) {
              allBeneficiaires = parsed;
              benefIdCounter = Math.max(
                1,
                ...allBeneficiaires.map((b) =&gt; b.id + 1),
              );
              return;
            }
          } catch (e) {}
        }
        // Si rien, on cr√©e 5 b√©n√©ficiaires initiaux
        allBeneficiaires = [];
        for (let i = 0; i &lt; 5; i++) {
          const newId = benefIdCounter++;
          const pays = i % 2 === 0 ? "France" : "Etranger";
          const prenom = randomFrom(prenoms);
          const nom = randomFrom(noms);
          const fullName = prenom + " " + nom;
          allBeneficiaires.push({ id: newId, name: fullName, pays: pays });
        }
        saveAllBeneficiaires();
      }
      // --- Sauvegarde et chargement des b√©n√©ficiaires de la distribution (tableau principal) ---

      function applyViewModeIfNeeded() {
        const isView = localStorage.getItem("distributionMode") === "view";

        [
          "distribution-date",
          "distribution-type",
          "distribution-legal-form",
          "distribution-source",
          "distribution-amount",
        ].forEach((id) =&gt; {
          const el = document.getElementById(id);
          if (el) el.disabled = isView;
        });

        ["btn-repartir", "btn-add-benef"].forEach((id) =&gt; {
          const el = document.getElementById(id);
          if (el) el.disabled = isView;
        });

        // Montants et actions dans le tableau des b√©n√©ficiaires
        document.querySelectorAll(".montant-cell").forEach(function(el) { el.disabled = isView; });
        document.querySelectorAll(".btn-remove-benef").forEach(function(el) { el.disabled = isView; });
        document.querySelectorAll(".droits-cell").forEach(function(el) {
          el.style.pointerEvents = isView ? "none" : "";
          el.style.color = isView ? "inherit" : "";
          el.style.textDecoration = isView ? "none" : "";
        });

        const next = document.getElementById("btn-next");
        if (next) next.textContent = "Suivant";
      }

      // --- Rafra√Æchissement de la liste d√©roulante des b√©n√©ficiaires √† ajouter ---
      function refreshBenefSelect() {
        const select = document.getElementById("benef-select");
        select.innerHTML = "";
        // On ne propose que les b√©n√©ficiaires qui ne sont pas d√©j√† dans la distribution
        const idsInTable = new Set(distributionBenefs.map((b) =&gt; b.id));
        let hasOption = false;
        allBeneficiaires.forEach((benef) =&gt; {
          if (!idsInTable.has(benef.id)) {
            const opt = document.createElement("option");
            opt.value = benef.id;
            opt.textContent =
              benef.name + (benef.pays ? " (" + benef.pays + ")" : "");
            select.appendChild(opt);
            hasOption = true;
          }
        });
        if (!hasOption) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "Aucun b√©n√©ficiaire disponible";
          select.appendChild(opt);
        }
      }
      // --- Ajout d'un b√©n√©ficiaire √† la liste globale ou s√©lectionn√© (CORRIG√â) ---
      document
        .getElementById("btn-add-benef")
        .addEventListener("click", function () {
          const select = document.getElementById("benef-select");
          let benefId = select.value;
          const idsInTable = new Set(distributionBenefs.map((b) =&gt; b.id));
          // Cas 1 : aucun b√©n√©ficiaire s√©lectionn√© OU "Aucun b√©n√©ficiaire disponible"
          if (
            !benefId ||
            benefId === "" ||
            benefId === "Aucun b√©n√©ficiaire disponible"
          ) {
            // Ajout d'un nouveau b√©n√©ficiaire al√©atoire √† la liste globale
            const newId = benefIdCounter++;
            const prenom = randomFrom(prenoms);
            const nom = randomFrom(noms);
            const pays =
              allBeneficiaires.length % 2 === 0 ? "France" : "Etranger";
            const fullName = prenom + " " + nom;
            const newBenef = { id: newId, name: fullName, pays: pays };
            allBeneficiaires.push(newBenef);
            saveAllBeneficiaires();
            // Ajout imm√©diat √† la distribution
            distributionBenefs.push({
              id: newId,
              name: fullName,
              pays: pays,
              droits: {
                PP: { qty: 0, montant: 0 },
                NP: { qty: 0, montant: 0 },
                U: { qty: 0, montant: 0 },
              },
              montant: 0,
              montantManuel: false,
            });
            saveDistributionBenefs();
            refreshBenefTable();
            refreshBenefSelect();
          } else {
            // Ajout du b√©n√©ficiaire s√©lectionn√© √† la distribution S'IL N'Y EST PAS D√âJ√Ä
            benefId = parseInt(benefId, 10);
            if (idsInTable.has(benefId)) {
              alert("Ce b√©n√©ficiaire est d√©j√† dans la distribution.");
              return;
            }
            const benef = allBeneficiaires.find((b) =&gt; b.id == benefId);
            if (benef) {
              distributionBenefs.push({
                id: benef.id,
                name: benef.name,
                pays: benef.pays,
                droits: {
                  PP: { qty: 0, montant: 0 },
                  NP: { qty: 0, montant: 0 },
                  U: { qty: 0, montant: 0 },
                },
                montant: 0,
                montantManuel: false,
              });
              saveDistributionBenefs();
              refreshBenefTable();
              refreshBenefSelect();
            }
          }
        });
      // --- Rafra√Æchissement du tableau des b√©n√©ficiaires ---
      function refreshBenefTable() {
        const tbody = document.getElementById("benef-table-body");
        tbody.innerHTML = "";
        let totalMontant = 0;
        let totalTotal = 0;
        let sumPP = 0,
          sumNP = 0,
          sumU = 0;
        distributionBenefs.forEach((b, idx) =&gt; {
          // Calcul du total des droits
          const droits = b.droits;
          const droitsStr = [
            `PP - ${formatFrNumber(droits.PP.qty)} - ${formatFrNumber(droits.PP.montant)}`,
            `NP - ${formatFrNumber(droits.NP.qty)} - ${formatFrNumber(droits.NP.montant)}`,
            `U - ${formatFrNumber(droits.U.qty)} - ${formatFrNumber(droits.U.montant)}`,
          ].join("&lt;br&gt;");
          // Calcul du total du modal
          const totalModal =
            droits.PP.montant + droits.NP.montant + droits.U.montant;
          // Sommes pour la ligne total
          sumPP += droits.PP.qty;
          sumNP += droits.NP.qty;
          sumU += droits.U.qty;
          // Montant affich√©
          const montantAffiche = formatFrNumber(b.montant);
          totalMontant += b.montant;
          // Total (pour chaque b√©n√©ficiaire, ici = montant)
          totalTotal += b.montant;
          // Warning si √©cart
          const warning = Math.abs(b.montant - totalModal) &gt; 0.009;
          const warningIcon = warning
            ? '&lt;span title="Le montant ne correspond pas au total d√©fini par type de droits" style="color:orange;font-weight:bold;font-size:1.2em;vertical-align:middle;"&gt;&amp;#9888;&lt;/span&gt;'
            : "";
          // Ligne
          const tr = document.createElement("tr");
          tr.innerHTML = `&lt;td&gt;${b.name}&lt;br&gt;&lt;small style="color:gray;"&gt;${b.pays}&lt;/small&gt;&lt;/td&gt;&lt;td&gt;&lt;a href="#" class="droits-cell" data-idx="${idx}"&gt;${droitsStr}&lt;/a&gt;&lt;/td&gt;&lt;td class="text-right"&gt;&lt;div style="display:flex;align-items:center;"&gt;&lt;input class="form-control text-right montant-cell" type="text" data-idx="${idx}" value="${montantAffiche}" style="max-width: 120px; width: 120px;"&gt;${warningIcon}&lt;/div&gt;&lt;/td&gt;&lt;td class="text-right"&gt;${montantAffiche}&lt;/td&gt;&lt;td&gt;&lt;button type="button" class="btn btn-secondary btn-sm btn-remove-benef" data-idx="${idx}" title="Supprimer" data-custom-bg="1"&gt;Supprimer&lt;/button&gt;&lt;/td&gt;`;
          tbody.appendChild(tr);
        });
        // Mise √† jour ligne total
        document.getElementById("total-montant-cell").innerHTML =
          `&lt;strong&gt;${formatFrNumber(totalMontant)}&lt;/strong&gt;`;
        document.getElementById("total-total-cell").innerHTML =
          `&lt;strong&gt;${formatFrNumber(totalTotal)}&lt;/strong&gt;`;
        const incoherent = Math.abs(sumNP - sumU) &gt; 0.009;
        document.getElementById("total-droits-cell").innerHTML =
          `&lt;div&gt;&lt;span&gt;PP - ${formatFrNumber(sumPP)}&lt;/span&gt;&lt;br&gt;&lt;span&gt;NP - ${formatFrNumber(sumNP)}&lt;/span&gt;&lt;br&gt;&lt;span&gt;U - ${formatFrNumber(sumU)}&lt;/span&gt;${incoherent ? '&lt;br&gt;&lt;span style="color:orange;font-weight:bold;" title="Total NP diff√©rent du total U"&gt;&amp;#9888; D√©membrement incoh√©rent&lt;/span&gt;' : ""}&lt;/div&gt;`;
        // Listeners droits
        Array.from(document.getElementsByClassName("droits-cell")).forEach(
          (a) =&gt; {
            a.addEventListener("click", function (e) {
              e.preventDefault();
              openDroitsModal(parseInt(this.dataset.idx, 10));
            });
          },
        );
        // Listeners suppression
        Array.from(document.getElementsByClassName("btn-remove-benef")).forEach(
          (btn) =&gt; {
            btn.addEventListener("click", function () {
              const idx = parseInt(this.dataset.idx, 10);
              removeBenef(idx);
            });
            btn.style.backgroundColor = "#ff5082";
            btn.style.borderColor = "#ff5082";
            btn.style.color = "#fff";
          },
        );
        // Listeners montant
        Array.from(document.getElementsByClassName("montant-cell")).forEach(
          (input) =&gt; {
            input.addEventListener("blur", function () {
              const idx = parseInt(this.dataset.idx, 10);
              let val = parseFrNumber(this.value);
              if (isNaN(val)) val = 0;
              this.value = formatFrNumber(val);
              distributionBenefs[idx].montant = val;
              distributionBenefs[idx].montantManuel = true;
              saveDistributionBenefs();
              refreshBenefTable();
            });
            input.style.maxWidth = "120px";
            input.style.width = "120px";
          },
        );
        refreshBenefSelect();
      }
      // --- Suppression d'un b√©n√©ficiaire ---
      function removeBenef(idx) {
        // On retire le b√©n√©ficiaire du tableau principal
        const removed = distributionBenefs.splice(idx, 1)[0];
        saveDistributionBenefs();
        refreshBenefTable();
        refreshBenefSelect();
      }
      // --- Modal droits : ouverture et remplissage ---
      let currentModalBenefId = null;
      function openDroitsModal(idx) {
        currentModalBenefId = idx;
        const benef = distributionBenefs[idx];
        document.getElementById("modal-benef-name").textContent = benef.name;
        document.getElementById("droits-pp-qty").value = formatFrNumber(
          benef.droits.PP.qty,
        );
        document.getElementById("droits-pp-montant").value = formatFrNumber(
          benef.droits.PP.montant,
        );
        document.getElementById("droits-np-qty").value = formatFrNumber(
          benef.droits.NP.qty,
        );
        document.getElementById("droits-np-montant").value = formatFrNumber(
          benef.droits.NP.montant,
        );
        document.getElementById("droits-u-qty").value = formatFrNumber(
          benef.droits.U.qty,
        );
        document.getElementById("droits-u-montant").value = formatFrNumber(
          benef.droits.U.montant,
        );
        updateDroitsTotal();
        document.getElementById("droits-modal").style.display = "";
      }
      function closeDroitsModal() {
        document.getElementById("droits-modal").style.display = "none";
        currentModalBenefId = null;
      }
      // --- Modal droits : listeners blur pour formatage et calcul total ---
      [
        "droits-pp-qty",
        "droits-pp-montant",
        "droits-np-qty",
        "droits-np-montant",
        "droits-u-qty",
        "droits-u-montant",
      ].forEach((id) =&gt; {
        document.getElementById(id).addEventListener("blur", function () {
          let val = parseFrNumber(this.value);
          if (isNaN(val)) val = 0;
          this.value = formatFrNumber(val);
          updateDroitsTotal();
        });
        // R√©duction taille
        if (id.endsWith("qty")) {
          document.getElementById(id).style.maxWidth = "90px";
          document.getElementById(id).style.width = "90px";
        } else {
          document.getElementById(id).style.maxWidth = "120px";
          document.getElementById(id).style.width = "120px";
        }
      });
      // --- Calcul du total dans le modal droits ---
      function updateDroitsTotal() {
        const pp =
          parseFrNumber(document.getElementById("droits-pp-montant").value) ||
          0;
        const np =
          parseFrNumber(document.getElementById("droits-np-montant").value) ||
          0;
        const u =
          parseFrNumber(document.getElementById("droits-u-montant").value) || 0;
        document.getElementById("droits-total-montant").value = formatFrNumber(
          pp + np + u,
        );
      }
      // --- Validation du modal droits ---
      document
        .getElementById("droits-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          if (currentModalBenefId === null) return;
          const idx = currentModalBenefId;
          const benef = distributionBenefs[idx];
          benef.droits.PP.qty =
            parseFrNumber(document.getElementById("droits-pp-qty").value) || 0;
          benef.droits.PP.montant =
            parseFrNumber(document.getElementById("droits-pp-montant").value) ||
            0;
          benef.droits.NP.qty =
            parseFrNumber(document.getElementById("droits-np-qty").value) || 0;
          benef.droits.NP.montant =
            parseFrNumber(document.getElementById("droits-np-montant").value) ||
            0;
          benef.droits.U.qty =
            parseFrNumber(document.getElementById("droits-u-qty").value) || 0;
          benef.droits.U.montant =
            parseFrNumber(document.getElementById("droits-u-montant").value) ||
            0;
          // Calcul du total
          const total =
            benef.droits.PP.montant +
            benef.droits.NP.montant +
            benef.droits.U.montant;
          // Si le montant n'a pas √©t√© modifi√© manuellement, on synchronise
          if (!benef.montantManuel) {
            benef.montant = total;
          }
          saveDistributionBenefs();
          closeDroitsModal();
          refreshBenefTable();
        });
      document
        .getElementById("droits-cancel")
        .addEventListener("click", function () {
          closeDroitsModal();
        });
      // --- R√©partition automatique du montant principal ---
      document
        .getElementById("btn-repartir")
        .addEventListener("click", function () {
          const montantTotal =
            parseFrNumber(
              document.getElementById("distribution-amount").value,
            ) || 0;
          // Calcul du total des droits PP+U
          let totalPPU = 0;
          distributionBenefs.forEach((b) =&gt; {
            totalPPU += (b.droits.PP.qty || 0) + (b.droits.U.qty || 0);
          });
          if (totalPPU === 0) return;
          // R√©partition au prorata des droits PP+U, NP = 0
          let reste = montantTotal;
          distributionBenefs.forEach((b, idx) =&gt; {
            const droitsPPU = (b.droits.PP.qty || 0) + (b.droits.U.qty || 0);
            let part =
              Math.round(((montantTotal * droitsPPU) / totalPPU) * 100) / 100;
            if (idx === distributionBenefs.length - 1) part = reste;
            reste -= part;
            // R√©partition dans le modal
            let montantPP = 0,
              montantU = 0;
            if (droitsPPU &gt; 0) {
              montantPP =
                Math.round(
                  ((part * (b.droits.PP.qty || 0)) / droitsPPU) * 100,
                ) / 100;
              montantU = part - montantPP;
            }
            b.droits.PP.montant = montantPP;
            b.droits.NP.montant = 0;
            b.droits.U.montant = montantU;
            // Synchronisation du montant 
            
              b.montant = montantPP + montantU;
            
          });
          saveDistributionBenefs();
          refreshBenefTable();
        });
      // --- Formatage initial du champ montant principal ---
      document
        .getElementById("distribution-amount")
        .addEventListener("blur", function () {
          let val = parseFrNumber(this.value);
          if (isNaN(val)) val = 0;
          this.value = formatFrNumber(val);
        });
      // --- Listener sur la forme juridique ---
      document
        .getElementById("distribution-legal-form")
        .addEventListener("change", function () {
          formeJuridique = this.value;
          saveFormeJuridique();
          updateCategorieTitre();
        });
      // --- Mise √† jour du titre de cat√©gorie de titres selon la forme juridique ---
      function updateCategorieTitre() {
        let titre =
          formeJuridique === "SAS" ? "Actions ordinaires" : "Parts sociales";
        // Mise √† jour du th dans le thead
        var th = document.getElementById("th-categorie-titre");
        if (th) th.textContent = titre;
      }
      // --- Sauvegarde automatique des champs du formulaire de distribution ---
      function saveDistributionDetails() {
        const details = {
          date: document.getElementById("distribution-date").value || "",
          type: document.getElementById("distribution-type").value || "",
          source: document.getElementById("distribution-source").value || "",
          montant: document.getElementById("distribution-amount").value || "",
        };
        localStorage.setItem("distributionDetails", JSON.stringify(details));
      }
      function loadDistributionDetails() {
        const raw = localStorage.getItem("distributionDetails");
        if (raw) {
          try {
            const details = JSON.parse(raw);
            if (details &amp;&amp; typeof details === "object") {
              if (details.date)
                document.getElementById("distribution-date").value =
                  details.date;
              if (details.type)
                document.getElementById("distribution-type").value =
                  details.type;
              if (details.source)
                document.getElementById("distribution-source").value =
                  details.source;
              if (details.montant)
                document.getElementById("distribution-amount").value =
                  details.montant;
            }
          } catch (e) {}
        }
      }

      function applyIntentFromList() {
        let intent = null;
        try {
          intent = JSON.parse(
            localStorage.getItem("distModalIntent") || "null",
          );
        } catch {}

        if (!intent || !intent.action) return;

        // Mode ajout : on part sur un √©cran vide (ou les valeurs actuelles)
        if (intent.action === "add") {
          localStorage.removeItem("distributionEditingId");
          localStorage.setItem("distributionMode", "add");
          return;
        }

        // Mode edit / view : on charge la distribution depuis distributionsData
        if (
          (intent.action === "edit" || intent.action === "view") &amp;&amp;
          intent.id != null
        ) {
          let list = [];
          try {
            list = JSON.parse(
              localStorage.getItem("distributionsData") || "[]",
            );
          } catch {}

          const dist = list.find((d) =&gt; Number(d.id) === Number(intent.id));
          if (!dist) return;

          // Hydrate les stores utilis√©s par l'√©cran 2/3
          localStorage.setItem(
            "distributionDetails",
            JSON.stringify(dist.details || {}),
          );
          localStorage.setItem(
            "distributionLegalForm",
            dist.legalForm || "SARL",
          );
          localStorage.setItem(
            "distributionBeneficiaires",
            JSON.stringify(dist.beneficiaires || []),
          );

          localStorage.setItem("distributionEditingId", String(dist.id));
          localStorage.setItem("distributionMode", intent.action); // "edit" ou "view"
        }
      }

      function getLegalForm() {
        return localStorage.getItem("distributionLegalForm") || "SARL";
      }

      function getDistributionDetails() {
        try {
          return JSON.parse(
            localStorage.getItem("distributionDetails") || "{}",
          );
        } catch (e) {
          return {};
        }
      }

      // --- Initialisation ---

      function init() {
        // üîπ Lire l‚Äôintent
        let intent = null;
        try {
          intent = JSON.parse(
            localStorage.getItem("distModalIntent") || "null",
          );
        } catch {}

        const editingId = localStorage.getItem("distributionEditingId");

        // üîπ Cas √©dition / visualisation
        if (editingId) {
          const list = JSON.parse(
            localStorage.getItem("distributionsData") || "[]",
          );
          const dist = list.find((d) =&gt; d.id == editingId);

          if (dist) {
            details = dist.details || {};
            formeJuridique = dist.legalForm || "SARL";
            distributionBenefs = (dist.beneficiaires || []).map((b) =&gt; {
              return {
                id: b.id,
                name: b.name,
                pays: b.pays,
                droits: {
                  PP: { qty: b.pp || 0, montant: b.ppMontant || 0 },
                  NP: { qty: b.np || 0, montant: b.npMontant || 0 },
                  U: { qty: b.u || 0, montant: b.uMontant || 0 },
                },
                montant: b.montant || 0,
                montantManuel: true,
              };
            });
          }
        } else {
          // üîπ Cas nouvelle distribution
          details = {
            date: "",
            type: "dividendes",
            source: "",
            montant: "0,00",
          };
          distributionBenefs = [];
        }

        // üîπ Remplir formulaire
        document.getElementById("distribution-date").value = details.date || "";
        document.getElementById("distribution-type").value =
          details.type || "dividendes";
        document.getElementById("distribution-source").value =
          details.source || "";
        document.getElementById("distribution-amount").value =
          details.montant || "0,00";
        document.getElementById("distribution-legal-form").value =
          formeJuridique;

        // üîπ Rendu
        refreshBenefTable();
        refreshBenefSelect();

        // üîπ Appliquer le mode (lecture seule ou √©dition) ‚Äî toujours
        applyViewModeIfNeeded();
      }

      init();

      // R√©-initialisation quand on navigue vers cet √©cran
      window.addEventListener("message", function (e) {
        const data = e.data || {};
        if (data.type === "po:activate" &amp;&amp; data.index === 2) {
          applyIntentFromList();
          init();
        }
      });

      // --- Bouton Suivant ---
      document
        .getElementById("btn-next")
        .addEventListener("click", function () {
          saveDistributionDetails();
          // Merge : pr√©server les champs de l'√©cran 3 (taux, qp, cc, pea, dispense)
          var existingBenefs = [];
          try { existingBenefs = JSON.parse(localStorage.getItem("distributionBeneficiaires") || "[]"); } catch(e) {}
          var existingById = {};
          existingBenefs.forEach(function(b) { existingById[String(b.id)] = b; });
          var benefs = distributionBenefs.map(function(b) {
            var existing = existingById[String(b.id)] || {};
            return Object.assign({}, existing, {
              id: b.id,
              name: b.name,
              pays: b.pays,
              montant: b.montant,
              pp: b.droits.PP.qty,
              np: b.droits.NP.qty,
              u: b.droits.U.qty,
              ppMontant: b.droits.PP.montant,
              npMontant: b.droits.NP.montant,
              uMontant: b.droits.U.montant,
            });
          });
          localStorage.setItem("distributionBeneficiaires", JSON.stringify(benefs));
          window.parent.postMessage(
            { type: "po:navigate", action: "goto", index: 3 },
            "*",
          );
        });
    &lt;/script&gt;


&lt;/body&gt;&lt;/html&gt;</textarea></div></div></div><div class="screen collapsible" id="screen-3" aria-expanded="true" draggable="true" data-index="3"><div class="screen-head"><div class="screen-left"><div class="drag-handle" title="Glisser pour r√©ordonner">‚ãÆ‚ãÆ</div><div class="screen-num" aria-label="Num√©ro d'√©cran">√âcran 3</div><input class="screen-title" placeholder="Titre de l‚Äô√©cran" value="Pr√©l√®vements et retenues"></div><div class="screen-actions"><button class="chevron" data-role="toggle" title="Plier / d√©plier" aria-expanded="true"></button><button class="btn" data-role="focus" title="Masquer texte et outils, garder l‚Äôaper√ßu en grand">Focus aper√ßu</button><button class="btn warn" data-role="delete">Supprimer</button></div></div><div class="collapsible-body"><label>Zone explicative</label><div class="rte-wrap explication"><div class="rte-toolbar"><button class="btn" data-cmd="bold" data-value="">B</button><button class="btn" data-cmd="italic" data-value="">I</button><button class="btn" data-cmd="formatBlock" data-value="H2">H2</button><button class="btn" data-cmd="insertUnorderedList" data-value="">‚Ä¢ Liste</button><button class="btn" data-cmd="insertOrderedList" data-value="">1. Liste</button><button class="btn" data-cmd="removeFormat" data-value="">Effacer</button></div><div class="rte" contenteditable="true" data-placeholder="But de l‚Äô√©cran, r√®gles, comportements attendus‚Ä¶">Cet √©cran comporte 2 tableaux potentiellement :<div><ol><li>Tableau pour les r√©sidents fran√ßais.&nbsp;</li><li>Tableau pour les r√©sidents √©trangers</li></ol><div>Chaque tableau √† une ligne "Total" qui fait la somme des lignes pour les montants mon√©taires</div><div>Le tableau pour les r√©sidents fran√ßais comporte les colonnes :</div></div><div><br></div><div><ul><li>B√©n√©ficiaire</li><li>Montant</li><li>QP du capital . cette colonne est visible seulement si la forme juridique est SARL&nbsp;</li><li>C/C moyen . cette colonne est visible seulement si la forme juridique est SARL</li><li>CSG/CRDS/PS</li><li>IR</li><li>Montant NET</li><li>Toggle "PEA"</li><li>Toggle "Demande de dispense"</li></ul><div>Le tableau est rempli comme suit :</div><div>B√©n√©ficiaire : lecture seule : le nom du b√©n√©ficiaire</div><div>Montant : lecture seule : le montant total de l'√©cran pr√©c√©dent pour le b√©n√©ficiaire</div><div>QP du capital : modifiable par l'utilisateur. Montanr pr√©rempli avec la quote part du capital d√©tenu par ce b√©n√©ficiaire. La QP de capital d√©tenu est √©gale √† al somme PP+NP du b√©n√©ficiaire divis√© par la somme totale des PP+NP au niveau de la soci√©t√©</div><div>C/C moyen : montant saisissable librement</div><div>CSG/CRDS/PS : lecture seule. La valeur est: -1* ("QP du capital" + "C/C moyenr") * 10 % * 18.4%</div><div>IR : lecture seule. La valeur est:&nbsp;-1*"Montant" * 12.8%</div><div>Montant NET : lecture seule.&nbsp; La valeur est: "Montant" + "CSG/CRDS/PS" + "IR"</div><div><br></div><div>Si un des 2 toggles "PEA" ou "Demande de dispense" est activ√© alors "IR" = 0. Si les deux toggles sont d√©sactiv√©s alors "IR" revient = -1*"Montant" * 12.8%</div><div><br></div><div>Le tableau pour les r√©sidents √©trangers&nbsp; comporte les colonnes :</div></div><div><ul><li>B√©n√©ficiare</li><li>Montant</li><li>Taux&nbsp;</li><li>Retenue √† la source</li><li>Montant net</li></ul><div><div>Le tableau est rempli comme suit :</div><div>B√©n√©ficiaire : lecture seule : le nom du b√©n√©ficiaire</div><div>Montant : lecture seule : le montant total de l'√©cran pr√©c√©dent pour le b√©n√©ficiaire</div></div></div><div>Taux : liste d√©roulante. taux charg√©s : 5%,5%,10%,12%,12,5%,12,8%,15%,20%,25%,75%. L'user doit √™tre capable de saisir aussi un autre taux</div><div>Retenue √† la source : lecture seule. La valeur est : -1* "Montant" * "Taux"</div><div>Montant net : lecture seule. la valeur est : "Montant" - "Retenue √† la source"</div><div><br></div><div>un bouton "Sauvegarder" permet de sauvegarder la distribution et rajoute une ligne dans le tableau des distributions √† l'√©cran 1.</div></div></div><label>Discussion &amp; √©l√©ments (g√©n√©ration + aper√ßu)</label><div class="chat"><div class="chat-head"><div class="title">Discussion / Prompt IA</div></div><div class="chat-body"><div class="chat-message user"><pre style="margin: 0px; white-space: pre-wrap; user-select: text;">üë§ test tu est quelle ia?</pre></div><div class="chat-message assistant"><pre style="margin: 0px; white-space: pre-wrap; user-select: text;">ü§ñ Je suis Claude, une intelligence artificielle cr√©√©e par Anthropic.

Je suis configur√© ici comme assistant pour l'application VIKTA, qui g√®re des pr√©l√®vements et retenues sur des distributions √† des b√©n√©ficiaires. Je peux t'aider sur le fonctionnement de cette application.</pre></div><div class="chat-message user"><pre style="margin: 0px; white-space: pre-wrap; user-select: text;">üë§ test tu est quelle ia?</pre></div><div class="chat-message assistant"><pre style="margin: 0px; white-space: pre-wrap; user-select: text;">ü§ñ Je suis Claude, une intelligence artificielle cr√©√©e par Anthropic, configur√©e ici comme assistant pour l‚Äôapplication VIKTA.</pre></div></div><div class="chat-images" style="display:none"></div><div class="chat-files" style="display:none"></div><div class="chat-input"><textarea class="chat-text" placeholder="Ecrire prompt ici.">test tu est quelle ia?</textarea></div></div><div class="elements"><div class="elements-toolbar"><div class="toolbar-left"><label class="inline-inc"><input type="checkbox" checked="" id="inc-screen-3" value="on"> Inclure le HTML actuel</label><button class="btn brand" data-role="load">Charger un fichier HTML‚Ä¶</button><button class="btn brand gen" data-role="gen">G√©n√©rer avec l‚ÄôIA</button></div><div class="toolbar-right"><button class="btn" data-role="edit-html">‚úèÔ∏è √âditer HTML</button><button class="btn brand gen" data-role="export-html">Exporter HTML</button><button class="btn" data-role="chat">üí¨ Discuter</button><button class="btn danger" data-role="reset-html">Vider HTML</button></div></div><iframe class="frame" title="Aper√ßu de l‚Äô√©cran" srcdoc="&lt;!doctype html&gt;
&lt;html lang=&quot;fr&quot;&gt;&lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width,initial-scale=1&quot;&gt;
    &lt;title&gt;Pr√©l√®vements et retenues ‚Äî Distribution&lt;/title&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;vikta-task.css&quot;&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h2&gt;Pr√©l√®vements et retenues&lt;/h2&gt;
    &lt;div id=&quot;distribution-summary&quot; class=&quot;mb-4&quot;&gt;&lt;/div&gt;

    &lt;div id=&quot;fr-residents-section&quot;&gt;
      &lt;h3&gt;B√©n√©ficiaires r√©sidents fran√ßais&lt;/h3&gt;
      &lt;table class=&quot;display datatable table table-hover dataTable&quot; id=&quot;fr-datatable&quot;&gt;
        &lt;thead&gt;
          &lt;tr&gt;
            &lt;th&gt;B√©n√©ficiaire&lt;/th&gt;
            &lt;th&gt;Montant&lt;/th&gt;
            &lt;th class=&quot;qp-col&quot;&gt;QP du capital&lt;/th&gt;
            &lt;th class=&quot;cc-col&quot;&gt;C/C moyen&lt;/th&gt;
            &lt;th&gt;CSG/CRDS/PS&lt;/th&gt;
            &lt;th&gt;IR&lt;/th&gt;
            &lt;th&gt;Montant NET&lt;/th&gt;
            &lt;th&gt;PEA&lt;/th&gt;
            &lt;th&gt;Demande de dispense&lt;/th&gt;
          &lt;/tr&gt;
        &lt;/thead&gt;
        &lt;tbody&gt;&lt;/tbody&gt;
        &lt;tfoot&gt;
          &lt;tr&gt;
            &lt;th&gt;Total&lt;/th&gt;
            &lt;th id=&quot;fr-total-montant&quot; class=&quot;text-right&quot;&gt;&lt;/th&gt;
            &lt;th class=&quot;qp-col&quot; id=&quot;fr-total-qp&quot;&gt;&lt;/th&gt;
            &lt;th class=&quot;cc-col&quot; id=&quot;fr-total-cc&quot;&gt;&lt;/th&gt;
            &lt;th id=&quot;fr-total-csg&quot; class=&quot;text-right&quot;&gt;&lt;/th&gt;
            &lt;th id=&quot;fr-total-ir&quot; class=&quot;text-right&quot;&gt;&lt;/th&gt;
            &lt;th id=&quot;fr-total-net&quot; class=&quot;text-right&quot;&gt;&lt;/th&gt;
            &lt;th&gt;&lt;/th&gt;
            &lt;th&gt;&lt;/th&gt;
          &lt;/tr&gt;
        &lt;/tfoot&gt;
      &lt;/table&gt;
    &lt;/div&gt;

    &lt;div id=&quot;foreign-residents-section&quot; class=&quot;mt-5&quot;&gt;
      &lt;h3&gt;B√©n√©ficiaires r√©sidents √©trangers&lt;/h3&gt;
      &lt;table class=&quot;display datatable table table-hover dataTable&quot; id=&quot;foreign-datatable&quot;&gt;
        &lt;thead&gt;
          &lt;tr&gt;
            &lt;th&gt;B√©n√©ficiaire&lt;/th&gt;
            &lt;th&gt;Montant&lt;/th&gt;
            &lt;th&gt;Taux&lt;/th&gt;
            &lt;th&gt;Retenue √† la source&lt;/th&gt;
            &lt;th&gt;Montant NET&lt;/th&gt;
          &lt;/tr&gt;
        &lt;/thead&gt;
        &lt;tbody&gt;&lt;/tbody&gt;
        &lt;tfoot&gt;
          &lt;tr&gt;
            &lt;th&gt;Total&lt;/th&gt;
            &lt;th id=&quot;foreign-total-montant&quot; class=&quot;text-right&quot;&gt;&lt;/th&gt;
            &lt;th&gt;&lt;/th&gt;
            &lt;th id=&quot;foreign-total-retenue&quot; class=&quot;text-right&quot;&gt;&lt;/th&gt;
            &lt;th id=&quot;foreign-total-net&quot; class=&quot;text-right&quot;&gt;&lt;/th&gt;
          &lt;/tr&gt;
        &lt;/tfoot&gt;
      &lt;/table&gt;
    &lt;/div&gt;

    &lt;div class=&quot;row mt-4&quot;&gt;
      &lt;div class=&quot;col-5&quot;&gt;&lt;/div&gt;
      &lt;div class=&quot;col-7 right&quot;&gt;
        &lt;button type=&quot;button&quot; class=&quot;btn btn-primary&quot; id=&quot;btn-save-distribution&quot;&gt;
          Sauvegarder
        &lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;script&gt;
      (function () {
        // --- UTILS ---
        function parseFrNumber(str) {
          if (!str) return 0;
          return Number(String(str).replace(/\s/g, &quot;&quot;).replace(&quot;,&quot;, &quot;.&quot;)) || 0;
        }
        function formatFrNumber(value) {
          return Number(value).toLocaleString(&quot;fr-FR&quot;, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
        }
        function sum(arr, fn) {
          return arr.reduce((acc, x) =&gt; acc + (fn ? fn(x) : x), 0);
        }
        function getLegalForm() {
          return localStorage.getItem(&quot;distributionLegalForm&quot;) || &quot;&quot;;
        }
        function getDistributionDetails() {
          try {
            return JSON.parse(
              localStorage.getItem(&quot;distributionDetails&quot;) || &quot;{}&quot;,
            );
          } catch (e) {
            return {};
          }
        }
        function getBeneficiaires() {
          try {
            return JSON.parse(
              localStorage.getItem(&quot;distributionBeneficiaires&quot;) || &quot;[]&quot;,
            );
          } catch (e) {
            return [];
          }
        }
        function getDistributionsData() {
          try {
            return JSON.parse(
              localStorage.getItem(&quot;distributionsData&quot;) || &quot;[]&quot;,
            );
          } catch (e) {
            return [];
          }
        }
        function setDistributionsData(data) {
          localStorage.setItem(&quot;distributionsData&quot;, JSON.stringify(data));
        }
        function isFrance(pays) {
          if (!pays) return true;
          return (
            pays.trim().toLowerCase() === &quot;france&quot; ||
            pays.trim().toLowerCase() === &quot;fr&quot;
          );
        }
        function createToggleInput(id, checked) {
          return (
            '&lt;input type=&quot;checkbox&quot; id=&quot;' +
            id +
            '&quot; ' +
            (checked ? &quot;checked&quot; : &quot;&quot;) +
            &quot;&gt;&quot;
          );
        }
        function createSelectTaux(id, value) {
          const tauxList = [
            &quot;5&quot;,
            &quot;10&quot;,
            &quot;12&quot;,
            &quot;12.5&quot;,
            &quot;12.8&quot;,
            &quot;15&quot;,
            &quot;20&quot;,
            &quot;25&quot;,
            &quot;75&quot;,
          ];
          let options = tauxList
            .map((t) =&gt; {
              let v = t.replace(&quot;,&quot;, &quot;.&quot;);
              let label = t.replace(&quot;.&quot;, &quot;,&quot;) + &quot; %&quot;;
              return (
                '&lt;option value=&quot;' +
                v +
                '&quot;' +
                (parseFloat(value) == parseFloat(v) ? &quot; selected&quot; : &quot;&quot;) +
                &quot;&gt;&quot; +
                label +
                &quot;&lt;/option&gt;&quot;
              );
            })
            .join(&quot;&quot;);
          // Ajout d'une option personnalis√©e si la valeur n'est pas dans la liste
          if (
            value &amp;&amp;
            !tauxList.some((t) =&gt; parseFloat(t) === parseFloat(value))
          ) {
            options +=
              '&lt;option value=&quot;' +
              value +
              '&quot; selected&gt;' +
              formatFrNumber(value) +
              &quot; %&lt;/option&gt;&quot;;
          }
          return (
            '&lt;select class=&quot;viktaselect custom-select taux-select&quot; id=&quot;' +
            id +
            '&quot;&gt;' +
            options +
            &quot;&lt;/select&gt;&quot;
          );
        }

        // --- ETAT ---
        let legalForm = getLegalForm();
        let details = getDistributionDetails();
        let beneficiaires = getBeneficiaires();

        // Calcul QP du capital total (somme PP+NP de tous les b√©n√©ficiaires)
        let totalPPNP = sum(
          beneficiaires,
          (b) =&gt; parseFrNumber(b.pp || 0) + parseFrNumber(b.np || 0),
        );
        // Pour chaque b√©n√©ficiaire, calculer QP du capital initial
        beneficiaires.forEach((b) =&gt; {
          b.qpInit = totalPPNP
            ? (parseFrNumber(b.pp || 0) + parseFrNumber(b.np || 0)) / totalPPNP
            : 0;
        });

        // S√©paration FR/√©trangers
        let frBenefs = beneficiaires.filter((b) =&gt; isFrance(b.pays));
        let foreignBenefs = beneficiaires.filter((b) =&gt; !isFrance(b.pays));

        // --- RENDU SOMMAIRE DISTRIBUTION ---
        function renderSummary() {
          let html = '&lt;div class=&quot;row&quot;&gt;';
          html +=
            '&lt;div class=&quot;col-3&quot;&gt;&lt;strong&gt;Date :&lt;/strong&gt;' +
            (details.date || &quot;-&quot;) +
            &quot;&lt;/div&gt;&quot;;
          html +=
            '&lt;div class=&quot;col-3&quot;&gt;&lt;strong&gt;Type :&lt;/strong&gt;' +
            (details.type || &quot;-&quot;) +
            &quot;&lt;/div&gt;&quot;;
          html +=
            '&lt;div class=&quot;col-3&quot;&gt;&lt;strong&gt;Source :&lt;/strong&gt;' +
            (details.source || &quot;-&quot;) +
            &quot;&lt;/div&gt;&quot;;
          html +=
            '&lt;div class=&quot;col-3&quot;&gt;&lt;strong&gt;Montant :&lt;/strong&gt;' +
            (details.montant ? formatFrNumber(details.montant) : &quot;-&quot;) +
            &quot;&lt;/div&gt;&quot;;
          html += &quot;&lt;/div&gt;&quot;;
          document.getElementById(&quot;distribution-summary&quot;).innerHTML = html;
        }

        // --- RENDU TABLEAU FR ---
        function renderFrTable() {
          let tbody = &quot;&quot;;
          frBenefs.forEach((b, idx) =&gt; {
            let montant = parseFrNumber(b.montant);
            let qp = b.qp !== undefined ? parseFrNumber(b.qp) : b.qpInit * 100; // QP en %
            let cc = b.cc !== undefined ? parseFrNumber(b.cc) : 0;
            let pea = !!b.pea;
            let dispense = !!b.dispense;
            // Calculs
            let csg = -1 * Math.min((qp + cc) * 0.1, montant) * 0.186;
            let ir = pea || dispense ? 0 : -1 * montant * 0.128;
            let net = montant + csg + ir;
            tbody += '&lt;tr data-idx=&quot;' + idx + '&quot;&gt;';
            tbody += &quot;&lt;td&gt;&quot; + b.name + &quot;&lt;/td&gt;&quot;;
            tbody +=
              '&lt;td class=&quot;text-right&quot;&gt;' + formatFrNumber(montant) + &quot;&lt;/td&gt;&quot;;
            if (legalForm === &quot;SARL&quot;) {
              tbody +=
                '&lt;td&gt;&lt;input class=&quot;form-control text-right qp-input&quot; type=&quot;text&quot; value=&quot;' +
                formatFrNumber(qp) +
                '&quot; data-idx=&quot;' +
                idx +
                '&quot; /&gt;&lt;/td&gt;';
              tbody +=
                '&lt;td&gt;&lt;input class=&quot;form-control text-right cc-input&quot; type=&quot;text&quot; value=&quot;' +
                formatFrNumber(cc) +
                '&quot; data-idx=&quot;' +
                idx +
                '&quot; /&gt;&lt;/td&gt;';
            } else {
              tbody += '&lt;td class=&quot;qp-col&quot; style=&quot;display:none&quot;&gt;&lt;/td&gt;';
              tbody += '&lt;td class=&quot;cc-col&quot; style=&quot;display:none&quot;&gt;&lt;/td&gt;';
            }
            tbody +=
              '&lt;td class=&quot;text-right csg-cell&quot;&gt;' +
              formatFrNumber(csg) +
              &quot;&lt;/td&gt;&quot;;
            tbody +=
              '&lt;td class=&quot;text-right ir-cell&quot;&gt;' + formatFrNumber(ir) + &quot;&lt;/td&gt;&quot;;
            tbody +=
              '&lt;td class=&quot;text-right net-cell&quot;&gt;' +
              formatFrNumber(net) +
              &quot;&lt;/td&gt;&quot;;
            tbody +=
              '&lt;td class=&quot;center&quot;&gt;' +
              createToggleInput(&quot;pea-&quot; + idx, pea) +
              &quot;&lt;/td&gt;&quot;;
            tbody +=
              '&lt;td class=&quot;center&quot;&gt;' +
              createToggleInput(&quot;dispense-&quot; + idx, dispense) +
              &quot;&lt;/td&gt;&quot;;
            tbody += &quot;&lt;/tr&gt;&quot;;
          });
          document.querySelector(&quot;#fr-datatable tbody&quot;).innerHTML = tbody;
          // Affichage/masquage colonnes SARL
          let showSARL = legalForm === &quot;SARL&quot;;
          document
            .querySelectorAll(&quot;.qp-col&quot;)
            .forEach((e) =&gt; (e.style.display = showSARL ? &quot;&quot; : &quot;none&quot;));
          document
            .querySelectorAll(&quot;.cc-col&quot;)
            .forEach((e) =&gt; (e.style.display = showSARL ? &quot;&quot; : &quot;none&quot;));
          // Totaux
          updateFrTotals();
        }

        function updateFrTotals() {
          let rows = document.querySelectorAll(&quot;#fr-datatable tbody tr&quot;);
          let totalMontant = 0,
            totalQP = 0,
            totalCC = 0,
            totalCSG = 0,
            totalIR = 0,
            totalNet = 0;
          rows.forEach((row) =&gt; {
            let idx = row.getAttribute(&quot;data-idx&quot;);
            let montant = parseFrNumber(frBenefs[idx].montant);
            let qp =
              legalForm === &quot;SARL&quot;
                ? parseFrNumber(row.querySelector(&quot;.qp-input&quot;).value)
                : 0;
            let cc =
              legalForm === &quot;SARL&quot;
                ? parseFrNumber(row.querySelector(&quot;.cc-input&quot;).value)
                : 0;
            let csg = parseFrNumber(row.querySelector(&quot;.csg-cell&quot;).textContent);
            let ir = parseFrNumber(row.querySelector(&quot;.ir-cell&quot;).textContent);
            let net = parseFrNumber(row.querySelector(&quot;.net-cell&quot;).textContent);
            totalMontant += montant;
            totalQP += qp;
            totalCC += cc;
            totalCSG += csg;
            totalIR += ir;
            totalNet += net;
          });
          document.getElementById(&quot;fr-total-montant&quot;).textContent =
            formatFrNumber(totalMontant);
          if (legalForm === &quot;SARL&quot;) {
            document.getElementById(&quot;fr-total-qp&quot;).textContent =
              formatFrNumber(totalQP);
            document.getElementById(&quot;fr-total-cc&quot;).textContent =
              formatFrNumber(totalCC);
          } else {
            document.getElementById(&quot;fr-total-qp&quot;).textContent = &quot;&quot;;
            document.getElementById(&quot;fr-total-cc&quot;).textContent = &quot;&quot;;
          }
          document.getElementById(&quot;fr-total-csg&quot;).textContent =
            formatFrNumber(totalCSG);
          document.getElementById(&quot;fr-total-ir&quot;).textContent =
            formatFrNumber(totalIR);
          document.getElementById(&quot;fr-total-net&quot;).textContent =
            formatFrNumber(totalNet);
        }

        // --- RENDU TABLEAU ETRANGER ---
        function renderForeignTable() {
          let tbody = &quot;&quot;;
          foreignBenefs.forEach((b, idx) =&gt; {
            let montant = parseFrNumber(b.montant);
            let taux = b.taux !== undefined ? parseFrNumber(b.taux) : 12.8;
            let retenue = -1 * montant * (taux / 100);
            let net = montant + retenue; // Correction: Montant NET = Montant + Retenue √† la source
            tbody += '&lt;tr data-idx=&quot;' + idx + '&quot;&gt;';
            tbody += &quot;&lt;td&gt;&quot; + b.name + &quot;&lt;/td&gt;&quot;;
            tbody +=
              '&lt;td class=&quot;text-right&quot;&gt;' + formatFrNumber(montant) + &quot;&lt;/td&gt;&quot;;
            tbody += &quot;&lt;td&gt;&quot; + createSelectTaux(&quot;taux-&quot; + idx, taux) + &quot;&lt;/td&gt;&quot;;
            tbody +=
              '&lt;td class=&quot;text-right retenue-cell&quot;&gt;' +
              formatFrNumber(retenue) +
              &quot;&lt;/td&gt;&quot;;
            tbody +=
              '&lt;td class=&quot;text-right net-cell&quot;&gt;' +
              formatFrNumber(net) +
              &quot;&lt;/td&gt;&quot;;
            tbody += &quot;&lt;/tr&gt;&quot;;
          });
          document.querySelector(&quot;#foreign-datatable tbody&quot;).innerHTML = tbody;
          updateForeignTotals();
        }

        function updateForeignTotals() {
          let rows = document.querySelectorAll(&quot;#foreign-datatable tbody tr&quot;);
          let totalMontant = 0,
            totalRetenue = 0,
            totalNet = 0;
          rows.forEach((row) =&gt; {
            let idx = row.getAttribute(&quot;data-idx&quot;);
            let montant = parseFrNumber(foreignBenefs[idx].montant);
            let retenue = parseFrNumber(
              row.querySelector(&quot;.retenue-cell&quot;).textContent,
            );
            let net = parseFrNumber(row.querySelector(&quot;.net-cell&quot;).textContent);
            totalMontant += montant;
            totalRetenue += retenue;
            totalNet += net;
          });
          document.getElementById(&quot;foreign-total-montant&quot;).textContent =
            formatFrNumber(totalMontant);
          document.getElementById(&quot;foreign-total-retenue&quot;).textContent =
            formatFrNumber(totalRetenue);
          document.getElementById(&quot;foreign-total-net&quot;).textContent =
            formatFrNumber(totalNet);
        }

        // --- EVENTS ---
        function onFrInputChange(e) {
          let input = e.target;
          let idx = input.getAttribute(&quot;data-idx&quot;);
          let row = input.closest(&quot;tr&quot;);
          let qp =
            legalForm === &quot;SARL&quot;
              ? parseFrNumber(row.querySelector(&quot;.qp-input&quot;).value)
              : 0;
          let cc =
            legalForm === &quot;SARL&quot;
              ? parseFrNumber(row.querySelector(&quot;.cc-input&quot;).value)
              : 0;
          let pea = row.querySelector('input[id^=&quot;pea-&quot;]').checked;
          let dispense = row.querySelector('input[id^=&quot;dispense-&quot;]').checked;
          let montant = parseFrNumber(frBenefs[idx].montant);
          // Calculs
          let csg = -1 * Math.min((qp + cc) * 0.1, montant) * 0.186;
          let ir = pea || dispense ? 0 : -1 * montant * 0.128;
          let net = montant + csg + ir;
          row.querySelector(&quot;.csg-cell&quot;).textContent = formatFrNumber(csg);
          row.querySelector(&quot;.ir-cell&quot;).textContent = formatFrNumber(ir);
          row.querySelector(&quot;.net-cell&quot;).textContent = formatFrNumber(net);
          // Format input
          if (
            input.classList.contains(&quot;qp-input&quot;) ||
            input.classList.contains(&quot;cc-input&quot;)
          ) {
            input.value = formatFrNumber(parseFrNumber(input.value));
          }
          // MAJ √©tat
          if (legalForm === &quot;SARL&quot;) {
            frBenefs[idx].qp = qp;
            frBenefs[idx].cc = cc;
          }
          frBenefs[idx].pea = pea;
          frBenefs[idx].dispense = dispense;
          updateFrTotals();
        }

        function onFrToggleChange(e) {
          let input = e.target;
          let row = input.closest(&quot;tr&quot;);
          // Forcer recalcul IR et net
          let idx = row.getAttribute(&quot;data-idx&quot;);
          let qp =
            legalForm === &quot;SARL&quot;
              ? parseFrNumber(
                  row.querySelector(&quot;.qp-input&quot;)
                    ? row.querySelector(&quot;.qp-input&quot;).value
                    : 0,
                )
              : 0;
          let cc =
            legalForm === &quot;SARL&quot;
              ? parseFrNumber(
                  row.querySelector(&quot;.cc-input&quot;)
                    ? row.querySelector(&quot;.cc-input&quot;).value
                    : 0,
                )
              : 0;
          let pea = row.querySelector('input[id^=&quot;pea-&quot;]').checked;
          let dispense = row.querySelector('input[id^=&quot;dispense-&quot;]').checked;
          let montant = parseFrNumber(frBenefs[idx].montant);
          let csg = -1 * Math.min((qp + cc) * 0.1, montant) * 0.186;
          let ir = pea || dispense ? 0 : -1 * montant * 0.128;
          let net = montant + csg + ir;
          row.querySelector(&quot;.csg-cell&quot;).textContent = formatFrNumber(csg);
          row.querySelector(&quot;.ir-cell&quot;).textContent = formatFrNumber(ir);
          row.querySelector(&quot;.net-cell&quot;).textContent = formatFrNumber(net);
          // MAJ √©tat
          if (legalForm === &quot;SARL&quot;) {
            frBenefs[idx].qp = qp;
            frBenefs[idx].cc = cc;
          }
          frBenefs[idx].pea = pea;
          frBenefs[idx].dispense = dispense;
          updateFrTotals();
        }

        function onForeignTauxChange(e) {
          let select = e.target;
          let idx = select.id.split(&quot;-&quot;)[1];
          let row = select.closest(&quot;tr&quot;);
          let montant = parseFrNumber(foreignBenefs[idx].montant);
          let taux = parseFrNumber(select.value);
          let retenue = -1 * montant * (taux / 100);
          let net = montant + retenue; // Correction: Montant NET = Montant + Retenue √† la source
          row.querySelector(&quot;.retenue-cell&quot;).textContent =
            formatFrNumber(retenue);
          row.querySelector(&quot;.net-cell&quot;).textContent = formatFrNumber(net);
          // MAJ √©tat
          foreignBenefs[idx].taux = taux;
          updateForeignTotals();
        }

        function onFrInputBlur(e) {
          // Format input
          let input = e.target;
          input.value = formatFrNumber(parseFrNumber(input.value));
        }

        // --- INIT ---
        renderSummary();
        renderFrTable();
        renderForeignTable();

        // Listeners FR
        function bindFrListeners() {
          if (legalForm === &quot;SARL&quot;) {
            document.querySelectorAll(&quot;.qp-input&quot;).forEach((input) =&gt; {
              input.addEventListener(&quot;input&quot;, onFrInputChange);
              input.addEventListener(&quot;blur&quot;, onFrInputBlur);
            });
            document.querySelectorAll(&quot;.cc-input&quot;).forEach((input) =&gt; {
              input.addEventListener(&quot;input&quot;, onFrInputChange);
              input.addEventListener(&quot;blur&quot;, onFrInputBlur);
            });
          }
          document.querySelectorAll('input[id^=&quot;pea-&quot;]').forEach((input) =&gt; {
            input.addEventListener(&quot;change&quot;, onFrToggleChange);
          });
          document
            .querySelectorAll('input[id^=&quot;dispense-&quot;]')
            .forEach((input) =&gt; {
              input.addEventListener(&quot;change&quot;, onFrToggleChange);
            });
        }

        function bindForeignListeners() {
          document.querySelectorAll(&quot;.taux-select&quot;).forEach((select) =&gt; {
            select.addEventListener(&quot;change&quot;, onForeignTauxChange);
            select.addEventListener(&quot;blur&quot;, function (e) {
              // Permet la saisie libre d'un taux
              let val = parseFrNumber(e.target.value);
              if (!isNaN(val) &amp;&amp; val &gt; 0) {
                e.target.value = val;
                onForeignTauxChange(e);
              }
            });
          });
        }

        bindFrListeners();
        bindForeignListeners();

        // --- SAUVEGARDE ---
        document
          .getElementById(&quot;btn-save-distribution&quot;)
          .addEventListener(&quot;click&quot;, function () {
            // En mode lecture seule : naviguer vers l‚Äô√©cran 1 sans sauvegarder
            if (localStorage.getItem(&quot;distributionMode&quot;) === &quot;view&quot;) {
              window.parent.postMessage({ type: &quot;po:navigate&quot;, action: &quot;goto&quot;, index: 1 }, &quot;*&quot;);
              return;
            }
            // Construction de l‚Äôobjet distribution √† sauvegarder
            let data = getDistributionsData();

            // üîπ si on vient d‚Äôun edit/view, l‚Äô√©cran 2 a pos√© cet id
            const editingId = Number(
              localStorage.getItem(&quot;distributionEditingId&quot;) || &quot;0&quot;,
            );

            // id = update si edit, sinon create
            const idToUse = editingId
              ? editingId
              : data.length &gt; 0
                ? Math.max(...data.map((d) =&gt; Number(d.id || 0))) + 1
                : 1;

            // Construit l‚Äôobjet distribution
            let distribution = {
              id: idToUse,
              locked: false, // tu peux aussi garder l'ancien locked si tu veux
              details: details,
              legalForm: legalForm,
              beneficiaires: [],
            };

            // FR
            frBenefs.forEach((b, idx) =&gt; {
              let row = document.querySelector(
                '#fr-datatable tbody tr[data-idx=&quot;' + idx + '&quot;]',
              );
              let montant = parseFrNumber(b.montant);
              let qp =
                legalForm === &quot;SARL&quot;
                  ? parseFrNumber(row.querySelector(&quot;.qp-input&quot;).value)
                  : 0;
              let cc =
                legalForm === &quot;SARL&quot;
                  ? parseFrNumber(row.querySelector(&quot;.cc-input&quot;).value)
                  : 0;
              let pea = row.querySelector('input[id^=&quot;pea-&quot;]').checked;
              let dispense = row.querySelector(
                'input[id^=&quot;dispense-&quot;]',
              ).checked;
              let csg = parseFrNumber(
                row.querySelector(&quot;.csg-cell&quot;).textContent,
              );
              let ir = parseFrNumber(row.querySelector(&quot;.ir-cell&quot;).textContent);
              let net = parseFrNumber(
                row.querySelector(&quot;.net-cell&quot;).textContent,
              );

              distribution.beneficiaires.push({
                id: b.id,
                name: b.name,
                pays: b.pays,
                montant: montant,
                pp: b.pp || 0,
                np: b.np || 0,
                u: b.u || 0,
                ppMontant: b.ppMontant || 0,
                npMontant: b.npMontant || 0,
                uMontant: b.uMontant || 0,
                qp: qp,
                cc: cc,
                pea: pea,
                dispense: dispense,
                csg: csg,
                ir: ir,
                net: net,
                type: &quot;fr&quot;,
              });
            });

            // FOREIGN
            foreignBenefs.forEach((b, idx) =&gt; {
              let row = document.querySelector(
                '#foreign-datatable tbody tr[data-idx=&quot;' + idx + '&quot;]',
              );
              let montant = parseFrNumber(b.montant);
              let taux = parseFrNumber(row.querySelector(&quot;.taux-select&quot;).value);
              let retenue = parseFrNumber(
                row.querySelector(&quot;.retenue-cell&quot;).textContent,
              );
              let net = parseFrNumber(
                row.querySelector(&quot;.net-cell&quot;).textContent,
              );

              distribution.beneficiaires.push({
                id: b.id,
                name: b.name,
                pays: b.pays,
                montant: montant,
                pp: b.pp || 0,
                np: b.np || 0,
                u: b.u || 0,
                ppMontant: b.ppMontant || 0,
                npMontant: b.npMontant || 0,
                uMontant: b.uMontant || 0,
                taux: taux,
                retenue: retenue,
                net: net,
                type: &quot;foreign&quot;,
              });
            });

            // Ajout √† la liste

            if (editingId) {
              // UPDATE
              const idx = data.findIndex((d) =&gt; Number(d.id) === editingId);
              if (idx &gt;= 0) {
                // optionnel : conserver l'√©tat locked existant
                distribution.locked = !!data[idx].locked;
                data[idx] = distribution;
              } else {
                data.push(distribution); // fallback si pas trouv√©
              }
            } else {
              // CREATE
              data.push(distribution);
            }

            setDistributionsData(data);

            // Nettoyage du mode √©dition apr√®s sauvegarde
            localStorage.removeItem(&quot;distributionEditingId&quot;);
            localStorage.setItem(
              &quot;distModalIntent&quot;,
              JSON.stringify({ action: &quot;add&quot; }),
            );
            localStorage.setItem(&quot;distributionMode&quot;, &quot;add&quot;);
            // Navigation √©cran 1
            window.parent.postMessage(
              { type: &quot;po:navigate&quot;, action: &quot;goto&quot;, index: 1 },
              &quot;*&quot;,
            );
          });

        // Rebind listeners apr√®s chaque render
        function rerenderAndBind() {
          renderFrTable();
          renderForeignTable();
          bindFrListeners();
          bindForeignListeners();
        }

        // Si jamais on veut rafra√Æchir dynamiquement (ex: changement de forme juridique)
        window.rerenderDistributionScreen = rerenderAndBind;

        // R√©-initialisation quand on navigue vers cet √©cran
        function activateScreen3() {
          legalForm = getLegalForm();
          details = getDistributionDetails();
          beneficiaires = getBeneficiaires();
          var totalPPNPLocal = beneficiaires.reduce(function (acc, b) {
            return acc + parseFrNumber(b.pp || 0) + parseFrNumber(b.np || 0);
          }, 0);
          beneficiaires.forEach(function (b) {
            b.qpInit = totalPPNPLocal
              ? (parseFrNumber(b.pp || 0) + parseFrNumber(b.np || 0)) / totalPPNPLocal
              : 0;
          });
          frBenefs = beneficiaires.filter(function (b) { return isFrance(b.pays); });
          foreignBenefs = beneficiaires.filter(function (b) { return !isFrance(b.pays); });
          renderSummary();
          rerenderAndBind();
          var mode = localStorage.getItem(&quot;distributionMode&quot;);
          var btnSave = document.getElementById(&quot;btn-save-distribution&quot;);
          if (mode === &quot;view&quot;) {
            btnSave.textContent = &quot;Fermer&quot;;
            document.querySelectorAll(&quot;input, select, textarea&quot;).forEach(function (el) {
              el.disabled = true;
            });
          } else {
            btnSave.textContent = &quot;Sauvegarder&quot;;
            document.querySelectorAll(&quot;input, select, textarea&quot;).forEach(function (el) {
              el.disabled = false;
            });
          }
        }

        window.addEventListener(&quot;message&quot;, function (e) {
          var data = e.data || {};
          if (data.type === &quot;po:activate&quot; &amp;&amp; data.index === 3) {
            activateScreen3();
          }
        });
      })();
    &lt;/script&gt;
  

&lt;/body&gt;&lt;/html&gt;" distributionmode");="" var="" btnsave="document.getElementById(&quot;btn-save-distribution&quot;);" if="" (mode="==" "view")="" {="" btnsave.textcontent="Fermer" ;="" document.queryselectorall("input,="" select,="" textarea").foreach(function="" (el)="" el.disabled="true;" });="" }="" else="" window.addeventlistener("message",="" function="" (e)="" data="e.data" ||="" {};="" (data.type="==" "po:activate"="" &amp;&amp;="" data.index="==" 3)="" activatescreen3();="" })();="" &lt;="" script&gt;="" body&gt;&lt;="" html&gt;"=""></iframe><textarea class="html-source" style="display: none; min-height: 260px; font-family: monospace; white-space: pre; width: 100%;">&lt;!doctype html&gt;
&lt;html lang="fr"&gt;&lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;meta name="viewport" content="width=device-width,initial-scale=1"&gt;
    &lt;title&gt;Pr√©l√®vements et retenues ‚Äî Distribution&lt;/title&gt;
    &lt;link rel="stylesheet" href="vikta-task.css"&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h2&gt;Pr√©l√®vements et retenues&lt;/h2&gt;
    &lt;div id="distribution-summary" class="mb-4"&gt;&lt;/div&gt;

    &lt;div id="fr-residents-section"&gt;
      &lt;h3&gt;B√©n√©ficiaires r√©sidents fran√ßais&lt;/h3&gt;
      &lt;table class="display datatable table table-hover dataTable" id="fr-datatable"&gt;
        &lt;thead&gt;
          &lt;tr&gt;
            &lt;th&gt;B√©n√©ficiaire&lt;/th&gt;
            &lt;th&gt;Montant&lt;/th&gt;
            &lt;th class="qp-col"&gt;QP du capital&lt;/th&gt;
            &lt;th class="cc-col"&gt;C/C moyen&lt;/th&gt;
            &lt;th&gt;CSG/CRDS/PS&lt;/th&gt;
            &lt;th&gt;IR&lt;/th&gt;
            &lt;th&gt;Montant NET&lt;/th&gt;
            &lt;th&gt;PEA&lt;/th&gt;
            &lt;th&gt;Demande de dispense&lt;/th&gt;
          &lt;/tr&gt;
        &lt;/thead&gt;
        &lt;tbody&gt;&lt;/tbody&gt;
        &lt;tfoot&gt;
          &lt;tr&gt;
            &lt;th&gt;Total&lt;/th&gt;
            &lt;th id="fr-total-montant" class="text-right"&gt;&lt;/th&gt;
            &lt;th class="qp-col" id="fr-total-qp"&gt;&lt;/th&gt;
            &lt;th class="cc-col" id="fr-total-cc"&gt;&lt;/th&gt;
            &lt;th id="fr-total-csg" class="text-right"&gt;&lt;/th&gt;
            &lt;th id="fr-total-ir" class="text-right"&gt;&lt;/th&gt;
            &lt;th id="fr-total-net" class="text-right"&gt;&lt;/th&gt;
            &lt;th&gt;&lt;/th&gt;
            &lt;th&gt;&lt;/th&gt;
          &lt;/tr&gt;
        &lt;/tfoot&gt;
      &lt;/table&gt;
    &lt;/div&gt;

    &lt;div id="foreign-residents-section" class="mt-5"&gt;
      &lt;h3&gt;B√©n√©ficiaires r√©sidents √©trangers&lt;/h3&gt;
      &lt;table class="display datatable table table-hover dataTable" id="foreign-datatable"&gt;
        &lt;thead&gt;
          &lt;tr&gt;
            &lt;th&gt;B√©n√©ficiaire&lt;/th&gt;
            &lt;th&gt;Montant&lt;/th&gt;
            &lt;th&gt;Taux&lt;/th&gt;
            &lt;th&gt;Retenue √† la source&lt;/th&gt;
            &lt;th&gt;Montant NET&lt;/th&gt;
          &lt;/tr&gt;
        &lt;/thead&gt;
        &lt;tbody&gt;&lt;/tbody&gt;
        &lt;tfoot&gt;
          &lt;tr&gt;
            &lt;th&gt;Total&lt;/th&gt;
            &lt;th id="foreign-total-montant" class="text-right"&gt;&lt;/th&gt;
            &lt;th&gt;&lt;/th&gt;
            &lt;th id="foreign-total-retenue" class="text-right"&gt;&lt;/th&gt;
            &lt;th id="foreign-total-net" class="text-right"&gt;&lt;/th&gt;
          &lt;/tr&gt;
        &lt;/tfoot&gt;
      &lt;/table&gt;
    &lt;/div&gt;

    &lt;div class="row mt-4"&gt;
      &lt;div class="col-5"&gt;&lt;/div&gt;
      &lt;div class="col-7 right"&gt;
        &lt;button type="button" class="btn btn-primary" id="btn-save-distribution"&gt;
          Sauvegarder
        &lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;script&gt;
      (function () {
        // --- UTILS ---
        function parseFrNumber(str) {
          if (!str) return 0;
          return Number(String(str).replace(/\s/g, "").replace(",", ".")) || 0;
        }
        function formatFrNumber(value) {
          return Number(value).toLocaleString("fr-FR", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
        }
        function sum(arr, fn) {
          return arr.reduce((acc, x) =&gt; acc + (fn ? fn(x) : x), 0);
        }
        function getLegalForm() {
          return localStorage.getItem("distributionLegalForm") || "";
        }
        function getDistributionDetails() {
          try {
            return JSON.parse(
              localStorage.getItem("distributionDetails") || "{}",
            );
          } catch (e) {
            return {};
          }
        }
        function getBeneficiaires() {
          try {
            return JSON.parse(
              localStorage.getItem("distributionBeneficiaires") || "[]",
            );
          } catch (e) {
            return [];
          }
        }
        function getDistributionsData() {
          try {
            return JSON.parse(
              localStorage.getItem("distributionsData") || "[]",
            );
          } catch (e) {
            return [];
          }
        }
        function setDistributionsData(data) {
          localStorage.setItem("distributionsData", JSON.stringify(data));
        }
        function isFrance(pays) {
          if (!pays) return true;
          return (
            pays.trim().toLowerCase() === "france" ||
            pays.trim().toLowerCase() === "fr"
          );
        }
        function createToggleInput(id, checked) {
          return (
            '&lt;input type="checkbox" id="' +
            id +
            '" ' +
            (checked ? "checked" : "") +
            "&gt;"
          );
        }
        function createSelectTaux(id, value) {
          const tauxList = [
            "5",
            "10",
            "12",
            "12.5",
            "12.8",
            "15",
            "20",
            "25",
            "75",
          ];
          let options = tauxList
            .map((t) =&gt; {
              let v = t.replace(",", ".");
              let label = t.replace(".", ",") + " %";
              return (
                '&lt;option value="' +
                v +
                '"' +
                (parseFloat(value) == parseFloat(v) ? " selected" : "") +
                "&gt;" +
                label +
                "&lt;/option&gt;"
              );
            })
            .join("");
          // Ajout d'une option personnalis√©e si la valeur n'est pas dans la liste
          if (
            value &amp;&amp;
            !tauxList.some((t) =&gt; parseFloat(t) === parseFloat(value))
          ) {
            options +=
              '&lt;option value="' +
              value +
              '" selected&gt;' +
              formatFrNumber(value) +
              " %&lt;/option&gt;";
          }
          return (
            '&lt;select class="viktaselect custom-select taux-select" id="' +
            id +
            '"&gt;' +
            options +
            "&lt;/select&gt;"
          );
        }

        // --- ETAT ---
        let legalForm = getLegalForm();
        let details = getDistributionDetails();
        let beneficiaires = getBeneficiaires();

        // Calcul QP du capital total (somme PP+NP de tous les b√©n√©ficiaires)
        let totalPPNP = sum(
          beneficiaires,
          (b) =&gt; parseFrNumber(b.pp || 0) + parseFrNumber(b.np || 0),
        );
        // Pour chaque b√©n√©ficiaire, calculer QP du capital initial
        beneficiaires.forEach((b) =&gt; {
          b.qpInit = totalPPNP
            ? (parseFrNumber(b.pp || 0) + parseFrNumber(b.np || 0)) / totalPPNP
            : 0;
        });

        // S√©paration FR/√©trangers
        let frBenefs = beneficiaires.filter((b) =&gt; isFrance(b.pays));
        let foreignBenefs = beneficiaires.filter((b) =&gt; !isFrance(b.pays));

        // --- RENDU SOMMAIRE DISTRIBUTION ---
        function renderSummary() {
          let html = '&lt;div class="row"&gt;';
          html +=
            '&lt;div class="col-3"&gt;&lt;strong&gt;Date :&lt;/strong&gt;' +
            (details.date || "-") +
            "&lt;/div&gt;";
          html +=
            '&lt;div class="col-3"&gt;&lt;strong&gt;Type :&lt;/strong&gt;' +
            (details.type || "-") +
            "&lt;/div&gt;";
          html +=
            '&lt;div class="col-3"&gt;&lt;strong&gt;Source :&lt;/strong&gt;' +
            (details.source || "-") +
            "&lt;/div&gt;";
          html +=
            '&lt;div class="col-3"&gt;&lt;strong&gt;Montant :&lt;/strong&gt;' +
            (details.montant ? formatFrNumber(details.montant) : "-") +
            "&lt;/div&gt;";
          html += "&lt;/div&gt;";
          document.getElementById("distribution-summary").innerHTML = html;
        }

        // --- RENDU TABLEAU FR ---
        function renderFrTable() {
          let tbody = "";
          frBenefs.forEach((b, idx) =&gt; {
            let montant = parseFrNumber(b.montant);
            let qp = b.qp !== undefined ? parseFrNumber(b.qp) : b.qpInit * 100; // QP en %
            let cc = b.cc !== undefined ? parseFrNumber(b.cc) : 0;
            let pea = !!b.pea;
            let dispense = !!b.dispense;
            // Calculs
            let csg = -1 * Math.min((qp + cc) * 0.1, montant) * 0.186;
            let ir = pea || dispense ? 0 : -1 * montant * 0.128;
            let net = montant + csg + ir;
            tbody += '&lt;tr data-idx="' + idx + '"&gt;';
            tbody += "&lt;td&gt;" + b.name + "&lt;/td&gt;";
            tbody +=
              '&lt;td class="text-right"&gt;' + formatFrNumber(montant) + "&lt;/td&gt;";
            if (legalForm === "SARL") {
              tbody +=
                '&lt;td&gt;&lt;input class="form-control text-right qp-input" type="text" value="' +
                formatFrNumber(qp) +
                '" data-idx="' +
                idx +
                '" /&gt;&lt;/td&gt;';
              tbody +=
                '&lt;td&gt;&lt;input class="form-control text-right cc-input" type="text" value="' +
                formatFrNumber(cc) +
                '" data-idx="' +
                idx +
                '" /&gt;&lt;/td&gt;';
            } else {
              tbody += '&lt;td class="qp-col" style="display:none"&gt;&lt;/td&gt;';
              tbody += '&lt;td class="cc-col" style="display:none"&gt;&lt;/td&gt;';
            }
            tbody +=
              '&lt;td class="text-right csg-cell"&gt;' +
              formatFrNumber(csg) +
              "&lt;/td&gt;";
            tbody +=
              '&lt;td class="text-right ir-cell"&gt;' + formatFrNumber(ir) + "&lt;/td&gt;";
            tbody +=
              '&lt;td class="text-right net-cell"&gt;' +
              formatFrNumber(net) +
              "&lt;/td&gt;";
            tbody +=
              '&lt;td class="center"&gt;' +
              createToggleInput("pea-" + idx, pea) +
              "&lt;/td&gt;";
            tbody +=
              '&lt;td class="center"&gt;' +
              createToggleInput("dispense-" + idx, dispense) +
              "&lt;/td&gt;";
            tbody += "&lt;/tr&gt;";
          });
          document.querySelector("#fr-datatable tbody").innerHTML = tbody;
          // Affichage/masquage colonnes SARL
          let showSARL = legalForm === "SARL";
          document
            .querySelectorAll(".qp-col")
            .forEach((e) =&gt; (e.style.display = showSARL ? "" : "none"));
          document
            .querySelectorAll(".cc-col")
            .forEach((e) =&gt; (e.style.display = showSARL ? "" : "none"));
          // Totaux
          updateFrTotals();
        }

        function updateFrTotals() {
          let rows = document.querySelectorAll("#fr-datatable tbody tr");
          let totalMontant = 0,
            totalQP = 0,
            totalCC = 0,
            totalCSG = 0,
            totalIR = 0,
            totalNet = 0;
          rows.forEach((row) =&gt; {
            let idx = row.getAttribute("data-idx");
            let montant = parseFrNumber(frBenefs[idx].montant);
            let qp =
              legalForm === "SARL"
                ? parseFrNumber(row.querySelector(".qp-input").value)
                : 0;
            let cc =
              legalForm === "SARL"
                ? parseFrNumber(row.querySelector(".cc-input").value)
                : 0;
            let csg = parseFrNumber(row.querySelector(".csg-cell").textContent);
            let ir = parseFrNumber(row.querySelector(".ir-cell").textContent);
            let net = parseFrNumber(row.querySelector(".net-cell").textContent);
            totalMontant += montant;
            totalQP += qp;
            totalCC += cc;
            totalCSG += csg;
            totalIR += ir;
            totalNet += net;
          });
          document.getElementById("fr-total-montant").textContent =
            formatFrNumber(totalMontant);
          if (legalForm === "SARL") {
            document.getElementById("fr-total-qp").textContent =
              formatFrNumber(totalQP);
            document.getElementById("fr-total-cc").textContent =
              formatFrNumber(totalCC);
          } else {
            document.getElementById("fr-total-qp").textContent = "";
            document.getElementById("fr-total-cc").textContent = "";
          }
          document.getElementById("fr-total-csg").textContent =
            formatFrNumber(totalCSG);
          document.getElementById("fr-total-ir").textContent =
            formatFrNumber(totalIR);
          document.getElementById("fr-total-net").textContent =
            formatFrNumber(totalNet);
        }

        // --- RENDU TABLEAU ETRANGER ---
        function renderForeignTable() {
          let tbody = "";
          foreignBenefs.forEach((b, idx) =&gt; {
            let montant = parseFrNumber(b.montant);
            let taux = b.taux !== undefined ? parseFrNumber(b.taux) : 12.8;
            let retenue = -1 * montant * (taux / 100);
            let net = montant + retenue; // Correction: Montant NET = Montant + Retenue √† la source
            tbody += '&lt;tr data-idx="' + idx + '"&gt;';
            tbody += "&lt;td&gt;" + b.name + "&lt;/td&gt;";
            tbody +=
              '&lt;td class="text-right"&gt;' + formatFrNumber(montant) + "&lt;/td&gt;";
            tbody += "&lt;td&gt;" + createSelectTaux("taux-" + idx, taux) + "&lt;/td&gt;";
            tbody +=
              '&lt;td class="text-right retenue-cell"&gt;' +
              formatFrNumber(retenue) +
              "&lt;/td&gt;";
            tbody +=
              '&lt;td class="text-right net-cell"&gt;' +
              formatFrNumber(net) +
              "&lt;/td&gt;";
            tbody += "&lt;/tr&gt;";
          });
          document.querySelector("#foreign-datatable tbody").innerHTML = tbody;
          updateForeignTotals();
        }

        function updateForeignTotals() {
          let rows = document.querySelectorAll("#foreign-datatable tbody tr");
          let totalMontant = 0,
            totalRetenue = 0,
            totalNet = 0;
          rows.forEach((row) =&gt; {
            let idx = row.getAttribute("data-idx");
            let montant = parseFrNumber(foreignBenefs[idx].montant);
            let retenue = parseFrNumber(
              row.querySelector(".retenue-cell").textContent,
            );
            let net = parseFrNumber(row.querySelector(".net-cell").textContent);
            totalMontant += montant;
            totalRetenue += retenue;
            totalNet += net;
          });
          document.getElementById("foreign-total-montant").textContent =
            formatFrNumber(totalMontant);
          document.getElementById("foreign-total-retenue").textContent =
            formatFrNumber(totalRetenue);
          document.getElementById("foreign-total-net").textContent =
            formatFrNumber(totalNet);
        }

        // --- EVENTS ---
        function onFrInputChange(e) {
          let input = e.target;
          let idx = input.getAttribute("data-idx");
          let row = input.closest("tr");
          let qp =
            legalForm === "SARL"
              ? parseFrNumber(row.querySelector(".qp-input").value)
              : 0;
          let cc =
            legalForm === "SARL"
              ? parseFrNumber(row.querySelector(".cc-input").value)
              : 0;
          let pea = row.querySelector('input[id^="pea-"]').checked;
          let dispense = row.querySelector('input[id^="dispense-"]').checked;
          let montant = parseFrNumber(frBenefs[idx].montant);
          // Calculs
          let csg = -1 * Math.min((qp + cc) * 0.1, montant) * 0.186;
          let ir = pea || dispense ? 0 : -1 * montant * 0.128;
          let net = montant + csg + ir;
          row.querySelector(".csg-cell").textContent = formatFrNumber(csg);
          row.querySelector(".ir-cell").textContent = formatFrNumber(ir);
          row.querySelector(".net-cell").textContent = formatFrNumber(net);
          // Format input
          if (
            input.classList.contains("qp-input") ||
            input.classList.contains("cc-input")
          ) {
            input.value = formatFrNumber(parseFrNumber(input.value));
          }
          // MAJ √©tat
          if (legalForm === "SARL") {
            frBenefs[idx].qp = qp;
            frBenefs[idx].cc = cc;
          }
          frBenefs[idx].pea = pea;
          frBenefs[idx].dispense = dispense;
          updateFrTotals();
        }

        function onFrToggleChange(e) {
          let input = e.target;
          let row = input.closest("tr");
          // Forcer recalcul IR et net
          let idx = row.getAttribute("data-idx");
          let qp =
            legalForm === "SARL"
              ? parseFrNumber(
                  row.querySelector(".qp-input")
                    ? row.querySelector(".qp-input").value
                    : 0,
                )
              : 0;
          let cc =
            legalForm === "SARL"
              ? parseFrNumber(
                  row.querySelector(".cc-input")
                    ? row.querySelector(".cc-input").value
                    : 0,
                )
              : 0;
          let pea = row.querySelector('input[id^="pea-"]').checked;
          let dispense = row.querySelector('input[id^="dispense-"]').checked;
          let montant = parseFrNumber(frBenefs[idx].montant);
          let csg = -1 * Math.min((qp + cc) * 0.1, montant) * 0.186;
          let ir = pea || dispense ? 0 : -1 * montant * 0.128;
          let net = montant + csg + ir;
          row.querySelector(".csg-cell").textContent = formatFrNumber(csg);
          row.querySelector(".ir-cell").textContent = formatFrNumber(ir);
          row.querySelector(".net-cell").textContent = formatFrNumber(net);
          // MAJ √©tat
          if (legalForm === "SARL") {
            frBenefs[idx].qp = qp;
            frBenefs[idx].cc = cc;
          }
          frBenefs[idx].pea = pea;
          frBenefs[idx].dispense = dispense;
          updateFrTotals();
        }

        function onForeignTauxChange(e) {
          let select = e.target;
          let idx = select.id.split("-")[1];
          let row = select.closest("tr");
          let montant = parseFrNumber(foreignBenefs[idx].montant);
          let taux = parseFrNumber(select.value);
          let retenue = -1 * montant * (taux / 100);
          let net = montant + retenue; // Correction: Montant NET = Montant + Retenue √† la source
          row.querySelector(".retenue-cell").textContent =
            formatFrNumber(retenue);
          row.querySelector(".net-cell").textContent = formatFrNumber(net);
          // MAJ √©tat
          foreignBenefs[idx].taux = taux;
          updateForeignTotals();
        }

        function onFrInputBlur(e) {
          // Format input
          let input = e.target;
          input.value = formatFrNumber(parseFrNumber(input.value));
        }

        // --- INIT ---
        renderSummary();
        renderFrTable();
        renderForeignTable();

        // Listeners FR
        function bindFrListeners() {
          if (legalForm === "SARL") {
            document.querySelectorAll(".qp-input").forEach((input) =&gt; {
              input.addEventListener("input", onFrInputChange);
              input.addEventListener("blur", onFrInputBlur);
            });
            document.querySelectorAll(".cc-input").forEach((input) =&gt; {
              input.addEventListener("input", onFrInputChange);
              input.addEventListener("blur", onFrInputBlur);
            });
          }
          document.querySelectorAll('input[id^="pea-"]').forEach((input) =&gt; {
            input.addEventListener("change", onFrToggleChange);
          });
          document
            .querySelectorAll('input[id^="dispense-"]')
            .forEach((input) =&gt; {
              input.addEventListener("change", onFrToggleChange);
            });
        }

        function bindForeignListeners() {
          document.querySelectorAll(".taux-select").forEach((select) =&gt; {
            select.addEventListener("change", onForeignTauxChange);
            select.addEventListener("blur", function (e) {
              // Permet la saisie libre d'un taux
              let val = parseFrNumber(e.target.value);
              if (!isNaN(val) &amp;&amp; val &gt; 0) {
                e.target.value = val;
                onForeignTauxChange(e);
              }
            });
          });
        }

        bindFrListeners();
        bindForeignListeners();

        // --- SAUVEGARDE ---
        document
          .getElementById("btn-save-distribution")
          .addEventListener("click", function () {
            // En mode lecture seule : naviguer vers l‚Äô√©cran 1 sans sauvegarder
            if (localStorage.getItem("distributionMode") === "view") {
              window.parent.postMessage({ type: "po:navigate", action: "goto", index: 1 }, "*");
              return;
            }
            // Construction de l‚Äôobjet distribution √† sauvegarder
            let data = getDistributionsData();

            // üîπ si on vient d‚Äôun edit/view, l‚Äô√©cran 2 a pos√© cet id
            const editingId = Number(
              localStorage.getItem("distributionEditingId") || "0",
            );

            // id = update si edit, sinon create
            const idToUse = editingId
              ? editingId
              : data.length &gt; 0
                ? Math.max(...data.map((d) =&gt; Number(d.id || 0))) + 1
                : 1;

            // Construit l‚Äôobjet distribution
            let distribution = {
              id: idToUse,
              locked: false, // tu peux aussi garder l'ancien locked si tu veux
              details: details,
              legalForm: legalForm,
              beneficiaires: [],
            };

            // FR
            frBenefs.forEach((b, idx) =&gt; {
              let row = document.querySelector(
                '#fr-datatable tbody tr[data-idx="' + idx + '"]',
              );
              let montant = parseFrNumber(b.montant);
              let qp =
                legalForm === "SARL"
                  ? parseFrNumber(row.querySelector(".qp-input").value)
                  : 0;
              let cc =
                legalForm === "SARL"
                  ? parseFrNumber(row.querySelector(".cc-input").value)
                  : 0;
              let pea = row.querySelector('input[id^="pea-"]').checked;
              let dispense = row.querySelector(
                'input[id^="dispense-"]',
              ).checked;
              let csg = parseFrNumber(
                row.querySelector(".csg-cell").textContent,
              );
              let ir = parseFrNumber(row.querySelector(".ir-cell").textContent);
              let net = parseFrNumber(
                row.querySelector(".net-cell").textContent,
              );

              distribution.beneficiaires.push({
                id: b.id,
                name: b.name,
                pays: b.pays,
                montant: montant,
                pp: b.pp || 0,
                np: b.np || 0,
                u: b.u || 0,
                ppMontant: b.ppMontant || 0,
                npMontant: b.npMontant || 0,
                uMontant: b.uMontant || 0,
                qp: qp,
                cc: cc,
                pea: pea,
                dispense: dispense,
                csg: csg,
                ir: ir,
                net: net,
                type: "fr",
              });
            });

            // FOREIGN
            foreignBenefs.forEach((b, idx) =&gt; {
              let row = document.querySelector(
                '#foreign-datatable tbody tr[data-idx="' + idx + '"]',
              );
              let montant = parseFrNumber(b.montant);
              let taux = parseFrNumber(row.querySelector(".taux-select").value);
              let retenue = parseFrNumber(
                row.querySelector(".retenue-cell").textContent,
              );
              let net = parseFrNumber(
                row.querySelector(".net-cell").textContent,
              );

              distribution.beneficiaires.push({
                id: b.id,
                name: b.name,
                pays: b.pays,
                montant: montant,
                pp: b.pp || 0,
                np: b.np || 0,
                u: b.u || 0,
                ppMontant: b.ppMontant || 0,
                npMontant: b.npMontant || 0,
                uMontant: b.uMontant || 0,
                taux: taux,
                retenue: retenue,
                net: net,
                type: "foreign",
              });
            });

            // Ajout √† la liste

            if (editingId) {
              // UPDATE
              const idx = data.findIndex((d) =&gt; Number(d.id) === editingId);
              if (idx &gt;= 0) {
                // optionnel : conserver l'√©tat locked existant
                distribution.locked = !!data[idx].locked;
                data[idx] = distribution;
              } else {
                data.push(distribution); // fallback si pas trouv√©
              }
            } else {
              // CREATE
              data.push(distribution);
            }

            setDistributionsData(data);

            // Nettoyage du mode √©dition apr√®s sauvegarde
            localStorage.removeItem("distributionEditingId");
            localStorage.setItem(
              "distModalIntent",
              JSON.stringify({ action: "add" }),
            );
            localStorage.setItem("distributionMode", "add");
            // Navigation √©cran 1
            window.parent.postMessage(
              { type: "po:navigate", action: "goto", index: 1 },
              "*",
            );
          });

        // Rebind listeners apr√®s chaque render
        function rerenderAndBind() {
          renderFrTable();
          renderForeignTable();
          bindFrListeners();
          bindForeignListeners();
        }

        // Si jamais on veut rafra√Æchir dynamiquement (ex: changement de forme juridique)
        window.rerenderDistributionScreen = rerenderAndBind;

        // R√©-initialisation quand on navigue vers cet √©cran
        function activateScreen3() {
          legalForm = getLegalForm();
          details = getDistributionDetails();
          beneficiaires = getBeneficiaires();
          var totalPPNPLocal = beneficiaires.reduce(function (acc, b) {
            return acc + parseFrNumber(b.pp || 0) + parseFrNumber(b.np || 0);
          }, 0);
          beneficiaires.forEach(function (b) {
            b.qpInit = totalPPNPLocal
              ? (parseFrNumber(b.pp || 0) + parseFrNumber(b.np || 0)) / totalPPNPLocal
              : 0;
          });
          frBenefs = beneficiaires.filter(function (b) { return isFrance(b.pays); });
          foreignBenefs = beneficiaires.filter(function (b) { return !isFrance(b.pays); });
          renderSummary();
          rerenderAndBind();
          var mode = localStorage.getItem("distributionMode");
          var btnSave = document.getElementById("btn-save-distribution");
          if (mode === "view") {
            btnSave.textContent = "Fermer";
            document.querySelectorAll("input, select, textarea").forEach(function (el) {
              el.disabled = true;
            });
          } else {
            btnSave.textContent = "Sauvegarder";
            document.querySelectorAll("input, select, textarea").forEach(function (el) {
              el.disabled = false;
            });
          }
        }

        window.addEventListener("message", function (e) {
          var data = e.data || {};
          if (data.type === "po:activate" &amp;&amp; data.index === 3) {
            activateScreen3();
          }
        });
      })();
    &lt;/script&gt;
  

&lt;/body&gt;&lt;/html&gt;</textarea></div></div></div></div>
  </div>

  <!-- Workspace Gate -->
  <div class="gate" id="workspaceGate" style="display: none;">
    <div class="gate-card">
      <h2>Choisis ton dossier de travail</h2>
      <p>Chrome exige une action de ta part pour autoriser l‚Äôacc√®s √† un dossier. Ce dossier sera utilis√© par
        <b>Sauvegarder</b> pour ouvrir la bo√Æte ‚ÄúEnregistrer sous‚Ä¶‚Äù directement au bon endroit.
      </p>
      <div class="gate-actions"><button class="btn brand">Rouvrir "VIKTA"</button>
        <button class="btn" id="gateSkip">Plus tard</button>
        <button class="btn brand" id="gatePick">Choisir le dossier‚Ä¶</button>
      </div>
    </div>
  </div>

  <!-- Modal param√®tres IA -->
  <div class="modal" id="modal">
    <div class="modal-card">
      <div class="modal-head">
        <div style="font-weight:700">Param√®tres IA</div>
        <button class="btn" id="closeModal">Fermer</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <label>Mode</label>
          <div class="inline">
            <label><input type="radio" name="aimode" value="proxy" checked=""> Proxy s√©curis√© (recommand√©)</label>
            <label><input type="radio" name="aimode" value="direct"> Direct (cl√© stock√©e localement)</label>
          </div>
        </div>

        <div class="row">
          <label>Fournisseur</label>
          <div class="inline">
            <label><input type="radio" name="aiprovider" value="openai" checked=""> OpenAI (ChatGPT)</label>
            <label><input type="radio" name="aiprovider" value="anthropic"> Anthropic (Claude)</label>
          </div>
        </div>

        <div id="proxyFields" class="row" style="">
          <label for="proxyUrl">URL du proxy (POST)</label>
          <input id="proxyUrl" placeholder="http://localhost:3000/vikta-ai" value="http://localhost:3000/vikta-ai">
          <div class="small">Le proxy accepte des prompts JSON et renvoie du texte/HTML.</div>
        </div>

        <div id="directFields" class="row" style="display:none;">
          <label for="apiKey">Cl√© API</label>
          <input id="apiKey" placeholder="sk-...  ou  sk-ant-..." value="">
          <label for="apiBase" style="margin-top:8px;">API Base (optionnel)</label>
          <input id="apiBase" placeholder="https://api.openai.com" value="">
          <div class="small">‚ö†Ô∏è La cl√© est stock√©e en local dans ton navigateur (localStorage).</div>
        </div>

        <div class="row" style="margin-top:4px;">
          <label>Mod√®les</label>
          <div class="inline">
            <div class="row" style="flex:1;min-width:180px">
              <label for="modelGeneration">G√©n√©ration</label>
              <select id="modelGeneration" class="vikta-select"><option value="gpt-5.2" selected="">GPT-5.2 ‚Äî $1.75/$14.00</option><option value="gpt-5">GPT-5 ‚Äî $1.25/$10.00</option><option value="gpt-4.1">GPT-4.1 ‚Äî $2.00/$8.00</option><option value="gpt-4o">GPT-4o ‚Äî $2.50/$10.00</option><option value="gpt-5-mini">GPT-5 Mini ‚Äî $0.25/$2.00 (recommand√©)</option><option value="gpt-4o-mini">GPT-4o Mini ‚Äî $0.15/$0.60</option><option value="gpt-4.1-nano">GPT-4.1 Nano ‚Äî $0.10/$0.40 (√©conomique)</option><option value="gpt-5-nano">GPT-5 Nano ‚Äî $0.05/$0.40 (le moins cher)</option></select>
            </div>
            <div class="row" style="flex:1;min-width:180px">
              <label for="modelChat">Chat</label>
              <select id="modelChat" class="vikta-select"><option value="gpt-5-mini" selected="">GPT-5 Mini ‚Äî $0.25/$2.00 (recommand√©)</option><option value="gpt-4o-mini">GPT-4o Mini ‚Äî $0.15/$0.60</option><option value="gpt-4.1-nano">GPT-4.1 Nano ‚Äî $0.10/$0.40</option><option value="gpt-5-nano">GPT-5 Nano ‚Äî $0.05/$0.40 (le moins cher)</option><option value="gpt-5">GPT-5 ‚Äî $1.25/$10.00</option><option value="gpt-4.1">GPT-4.1 ‚Äî $2.00/$8.00</option></select>
            </div>
            <div class="row" style="flex:1;min-width:180px">
              <label for="modelTranslate">Traduction</label>
              <select id="modelTranslate" class="vikta-select"><option value="gpt-5-mini" selected="">GPT-5 Mini ‚Äî $0.25/$2.00 (recommand√©)</option><option value="gpt-4o-mini">GPT-4o Mini ‚Äî $0.15/$0.60</option><option value="gpt-4.1-nano">GPT-4.1 Nano ‚Äî $0.10/$0.40</option><option value="gpt-5-nano">GPT-5 Nano ‚Äî $0.05/$0.40 (le moins cher)</option></select>
            </div>
          </div>
        </div>

        <div class="toolbar" style="justify-content:flex-end">
          <button class="btn" id="clearAiCfg">R√©initialiser</button>
          <button class="btn brand" id="saveAiCfg">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <script src="vikta-task.js"></script>
</body></html>